### **Проект: CryptoSafe Manager — Техническое задание (Спринт 2)**

**Цель спринта:** Реализовать аутентификацию по мастер-паролю, безопасное формирование ключей с использованием Argon2/PBKDF2 и интегрировать систему управления ключами с созданным фундаментом для поддержки всех будущих операций шифрования.

#### **1. Расширение архитектуры проекта**

Компоненты управления ключами должны быть бесшовно интегрированы в модульную архитектуру, созданную в Спринте 1.

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| ARC-1 | Директория `src/core/crypto/` **обязана** быть расширена:                                                           | Must     |
|      | - `key_derivation.py` - реализации Argon2 и PBKDF2                                                                  |          |
|      | - `key_storage.py` - безопасное кэширование ключей и интеграция с хранилищем ключей ОС                              |          |
|      | - `authentication.py` - проверка пароля и управление сессией                                                        |          |
| ARC-2 | Абстрактный `EncryptionService` из Спринта 1 **обязан** быть обновлен для принятия экземпляра `KeyManager` вместо сырых ключей. | Must     |
| ARC-3 | Система миграции базы данных **обязана** обрабатывать обновления схемы для таблиц хранения ключей без потери данных. | Must     |

#### **2. Система хэширования и проверки паролей**

Должен быть реализован Argon2 для безопасного хэширования паролей с защитой от атак перебором.

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| HASH-1 | **Обязательно** использовать библиотеку `argon2-cffi` с вариантом Argon2id.                                         | Must     |
| HASH-2 | Параметры хэширования **обязаны** быть настраиваемыми через настройки с безопасными значениями по умолчанию:        | Must     |
|      | - Временная стоимость: 3 итерации (минимум)                                                                         |          |
|      | - Память: 64 МиБ                                                                                                    |          |
|      | - Параллелизм: 4 потока                                                                                             |          |
|      | - Длина хэша: 32 байта                                                                                              |          |
| HASH-3 | Проверка пароля **обязана** использовать сравнение за константное время через `secrets.compare_digest()`.           | Must     |
| HASH-4 | Валидатор надежности пароля **обязан** проверять:                                                                   | Must     |
|      | - Минимальную длину (12 символов)                                                                                   |          |
|      | - Разнообразие символов (заглавные, строчные, цифры, спецсимволы)                                                   |          |
|      | - Распространенные шаблоны паролей (например, "password123", "qwerty")                                              |          |

#### **3. Формирование и управление ключами**

На основе мастер-пароля должны формироваться как ключ для проверки аутентификации, так и ключ шифрования.

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| KEY-1 | **Обязательно** формировать два отдельных ключа:                                                                    | Must     |
|      | - **Ключ аутентификации:** формируется через Argon2 (хранится как хэш для проверки)                                 |          |
|      | - **Ключ шифрования:** формируется через PBKDF2-HMAC-SHA256 (никогда не хранится, генерируется при необходимости)   |          |
| KEY-2 | Параметры PBKDF2 **обязаны** быть:                                                                                  | Must     |
|      | - Итерации: 100 000 (минимум)                                                                                       |          |
|      | - Длина соли: 16 байт (уникальная для пользователя)                                                                 |          |
|      | - Длина ключа: 32 байта (AES-256)                                                                                   |          |
| KEY-3 | Все соли и параметры **обязаны** храниться в таблице `key_store` с версионированием для будущих обновлений.         | Must     |

#### **4. Безопасное кэширование ключей и управление памятью**

Сформированные ключи должны безопасно кэшироваться в памяти с автоматической очисткой.

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| CACHE-1 | Ключ шифрования **обязан** кэшироваться в памяти только пока:                                                       | Must     |
|      | - Хранилище разблокировано                                                                                          |          |
|      | - Приложение активно (не свернуто и не в фоне)                                                                       |          |
| CACHE-2 | Кэш ключей **обязан** реализовывать автоматическое устаревание:                                                     | Must     |
|      | - После 1 часа неактивности                                                                                         |          |
|      | - Когда приложение сворачивается или теряет фокус (настраивается)                                                    |          |
| CACHE-3 | Хранение в памяти **должно** использовать защищенные области памяти, где это возможно (например, `mlock()` в Unix, `CryptProtectMemory` в Windows). | Should   |
| CACHE-4 | Все кэшированные ключи **обязаны** обнуляться в памяти, когда:                                                      | Must     |
|      | - Пользователь явно выходит из системы                                                                              |          |
|      | - Приложение закрывается                                                                                            |          |
|      | - Срабатывает авто-блокировка                                                                                       |          |

#### **5. Интеграция с хранилищем ключей ОС (Опционально)**

Опциональное безопасное хранение ключей через встроенные в платформу хранилища для улучшения пользовательского опыта.

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| KEYCHAIN-1 | Для кроссплатформенного доступа к хранилищу ключей **должна** использоваться библиотека `keyring`.                   | Should   |
| KEYCHAIN-2 | Хранилище ключей ОС **может** использоваться для:                                                                   | Optional |
|      | - Хранения сформированного ключа шифрования (зашифрованного хранилищем)                                             |          |
|      | - Кэширования хэша мастер-пароля для более быстрой разблокировки                                                   |          |
| KEYCHAIN-3 | **Должно** быть доступно резервное файловое хранилище, если системное недоступно.                                   | Should   |

#### **6. Интеграция процесса аутентификации**

Система аутентификации должна интегрироваться с существующим GUI и системой событий.

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| AUTH-1 | Диалог входа **обязан** заменить мастер первоначальной настройки после первичной конфигурации.                     | Must     |
| AUTH-2 | Процесс аутентификации **обязан**:                                                                                  | Must     |
|      | 1. Проверить пароль по хэшу Argon2                                                                                  |          |
|      | 2. Сформировать ключ шифрования через PBKDF2                                                                        |          |
|      | 3. Поместить ключ шифрования в безопасный кэш                                                                       |          |
|      | 4. Опубликовать событие `UserLoggedIn`                                                                              |          |
| AUTH-3 | Неудачные попытки входа **обязаны** активировать экспоненциальную задержку:                                         | Must     |
|      | - 1-2 неудачи: задержка 1 секунда                                                                                   |          |
|      | - 3-4 неудачи: задержка 5 секунд                                                                                    |          |
|      | - 5+ неудач: задержка 30 секунд                                                                                     |          |
| AUTH-4 | Управление сессией **обязано** отслеживать:                                                                         | Must     |
|      | - Время входа в систему                                                                                             |          |
|      | - Время последней активности                                                                                        |          |
|      | - Счетчик неудачных попыток                                                                                         |          |

#### **7. Смена пароля и ротация ключей**

Пользователи должны иметь возможность сменить мастер-пароль с безопасным перешифрованием хранилища.

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| CHANGE-1 | Диалог смены пароля **обязан** требовать:                                                                           | Must     |
|      | - Проверки текущего пароля                                                                                          |          |
|      | - Нового пароля (с проверкой надежности)                                                                            |          |
|      | - Подтверждения нового пароля                                                                                       |          |
| CHANGE-2 | Процесс ротации ключей **обязан**:                                                                                  | Must     |
|      | 1. Проверить текущий пароль и сформировать старый ключ шифрования                                                   |          |
|      | 2. Сформировать новый ключ шифрования из нового пароля                                                              |          |
|      | 3. Перешифровать все записи хранилища с использованием нового ключа (фоновый процесс)                               |          |
|      | 4. Обновить все соли и хэши в `key_store`                                                                           |          |
| CHANGE-3 | **Должен** отображаться индикатор прогресса во время перешифрования с возможностью приостановки/возобновления.      | Should   |
| CHANGE-4 | **Должен** быть доступен атомарный откат, если перешифрование завершилось неудачей.                                | Must     |

#### **8. Обновления схемы базы данных**

Необходимо реализовать таблицы хранения ключей для поддержки аутентификации и управления ключами.

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| DB-1 | Таблица `key_store` **обязана** включать:                                                                           | Must     |
|      | - `id` (INTEGER PRIMARY KEY)                                                                                        |          |
|      | - `key_type` (TEXT: "auth_hash", "enc_salt", "params")                                                              |          |
|      | - `key_data` (BLOB: хэш, соль или параметры)                                                                        |          |
|      | - `version` (INTEGER: для будущих обновлений алгоритмов)                                                            |          |
|      | - `created_at` (TIMESTAMP)                                                                                          |          |
| DB-2 | Таблица `settings` **обязана** хранить:                                                                             | Must     |
|      | - Конфигурацию политики паролей                                                                                     |          |
|      | - Параметры формирования ключей                                                                                     |          |
|      | - Таймаут авто-блокировки                                                                                           |          |

#### **9. Тестирование и проверка безопасности**

Необходимо комплексное тестирование для проверки криптографических реализаций и свойств безопасности.

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| TEST-1 | **Тест валидации параметров Argon2:** Убедиться, что разные комбинации параметров дают валидные хэши.              | Must     |
| TEST-2 | **Тест консистентности формирования ключей:** Сформировать ключ 100 раз с одинаковыми входными данными, убедиться в идентичности результата. | Must     |
| TEST-3 | **Тест на устойчивость к атакам по времени:** Убедиться, что сравнение паролей выполняется за константное время. | Must     |
| TEST-4 | **Тест безопасности памяти:** Убедиться, что ключи обнуляются в памяти после использования.                       | Must     |
| TEST-5 | **Интеграционный тест смены пароля:**                                                                              | Must     |
|      | 1. Создать хранилище с паролем "A"                                                                                  |          |
|      | 2. Добавить 10 записей                                                                                              |          |
|      | 3. Сменить пароль на "B"                                                                                            |          |
|      | 4. Убедиться, что все записи доступны с новым паролем                                                               |          |

#### **10. Интеграция с будущими спринтами**

Система управления ключами должна быть спроектирована с учетом поддержки будущих спринтов.

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| FUTURE-1 | Формирование ключей **должно** поддерживать несколько типов ключей для будущих функций:                            | Must     |
|      | - Ключ подписи журнала аудита (Спринт 5)                                                                            |          |
|      | - Ключ шифрования для обмена/экспорта (Спринт 6)                                                                    |          |
|      | - Формирование ключа для TOTP (Бонусная функция)                                                                    |          |
| FUTURE-2 | Система аутентификации **должна** поддерживать возможность подключения многофакторной аутентификации.              | Should   |
| FUTURE-3 | Кэширование ключей **должно** интегрироваться с функцией авто-блокировки (Спринт 7).                               | Must     |

#### **11. Контрольные точки аудита безопасности**

Критически важные требования безопасности для управления ключами.

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| SEC-1 | Мастер-пароль **никогда не должен** храниться ни в какой форме (кроме хэша Argon2).                                 | Must     |
| SEC-2 | Ключ шифрования **никогда не должен** записываться на диск (кроме опционального хранения в хранилище ключей ОС).    | Must     |
| SEC-3 | Все криптографические операции **обязаны** использовать одобренные библиотеки с актуальными версиями.               | Must     |
| SEC-4 | Валидация параметров **обязана** предотвращать DoS-атаки (например, чрезмерное использование памяти в Argon2).      | Must     |

---

**Пример реализации формирования ключей:**
```python
# src/core/crypto/key_derivation.py
from argon2 import PasswordHasher, Type
from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC
from cryptography.hazmat.primitives import hashes
import os
import secrets

class KeyManager:
    def __init__(self, config):
        self.argon2_hasher = PasswordHasher(
            time_cost=config.get('argon2_time', 3),
            memory_cost=config.get('argon2_memory', 65536),
            parallelism=config.get('argon2_parallelism', 4),
            hash_len=32,
            salt_len=16,
            type=Type.ID
        )
        self.pbkdf2_iterations = config.get('pbkdf2_iterations', 100000)

    def create_auth_hash(self, password: str) -> dict:
        """Создание хэша Argon2 для проверки пароля"""
        return {
            'hash': self.argon2_hasher.hash(password),
            'params': self.argon2_hasher.params()
        }

    def derive_encryption_key(self, password: str, salt: bytes) -> bytes:
        """Формирование ключа AES-256 из пароля с использованием PBKDF2"""
        kdf = PBKDF2HMAC(
            algorithm=hashes.SHA256(),
            length=32,
            salt=salt,
            iterations=self.pbkdf2_iterations
        )
        return kdf.derive(password.encode('utf-8'))

    def verify_password(self, password: str, stored_hash: str) -> bool:
        """Проверка пароля по сохраненному хэшу Argon2 (за константное время)"""
        try:
            return self.argon2_hasher.verify(stored_hash, password)
        except:
            # Фиктивная проверка за константное время для предотвращения атак по времени
            secrets.compare_digest(b'dummy', b'dummy')
            return False
```
