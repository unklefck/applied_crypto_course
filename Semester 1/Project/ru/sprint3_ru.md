### **Проект: CryptoSafe Manager — Техническое задание (Спринт 3)**

**Цель спринта:** Реализовать полный набор CRUD-операций для хранилища с индивидуальным шифрованием AES-256-GCM для каждой записи, безопасной генерацией паролей и интуитивно понятным табличным интерфейсом, интегрированным с существующей системой управления ключами.

#### **1. Архитектура и интеграция**

Все новые компоненты должны быть бесшовно интегрированы в модульную архитектуру из предыдущих спринтов.

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| ARC-1 | **Обязана** быть создана директория `src/core/vault/` с:                                                            | Must     |
|      | - `entry_manager.py` - Основной контроллер CRUD-операций                                                            |          |
|      | - `encryption_service.py` - Реализация AES-GCM для отдельных записей                                                |          |
|      | - `password_generator.py` - Безопасная генерация паролей                                                            |          |
| ARC-2 | Сервис-заглушка шифрования из Спринта 1 **обязан** быть заменен на реальную реализацию AES-256-GCM.                 | Must     |
| ARC-3 | Все операции с хранилищем **обязаны** использовать ключ шифрования, закэшированный KeyManager из Спринта 2.         | Must     |

#### **2. Реализация шифрования для отдельных записей**

Каждые учетные данные должны шифроваться индивидуально с использованием аутентифицированного шифрования.

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| ENC-1 | AES-256-GCM **обязан** быть реализован с использованием `cryptography.hazmat.primitives.ciphers.aead.AESGCM`.       | Must     |
| ENC-2 | Каждая операция шифрования **обязана** использовать уникальный 12-байтовый одноразовый номер (nonce), сгенерированный через `os.urandom(12)`. | Must     |
| ENC-3 | Зашифрованный пакет **обязан** включать:                                                                            | Must     |
|      | - Все поля записи (заголовок, имя пользователя, пароль, URL, заметки) в формате JSON                               |          |
|      | - Временную метку создания                                                                                          |          |
|      | - Идентификатор версии для будущей совместимости                                                                    |          |
| ENC-4 | Формат хранения **обязан** быть: `nonce (12Б) || ciphertext || tag (16Б)` в виде единого BLOB-объекта.             | Must     |
| ENC-5 | При расшифровке **обязательно** должна проверяться аутентификационная метка (tag) и вызываться исключение при обнаружении подмены. | Must     |

#### **3. Модель данных записи хранилища**

Структура записи должна поддерживать все необходимые поля с возможностью расширения для будущих функций.

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| DATA-1 | Модель записи **обязана** включать:                                                                                 | Must     |
|      | - `id`: UUID или целочисленный первичный ключ                                                                       |          |
|      | - `encrypted_data`: BLOB (nonce + ciphertext + tag)                                                                 |          |
|      | - `created_at`: TIMESTAMP                                                                                           |          |
|      | - `updated_at`: TIMESTAMP                                                                                           |          |
|      | - `tags`: TEXT (разделенные запятыми или JSON-массив)                                                               |          |
| DATA-2 | Структура записи в открытом виде **обязана** быть:                                                                  | Must     |
|      | ```json                                                                                                             |          |
|      | {                                                                                                                   |          |
|      |   "title": "Пример",                                                                                                |          |
|      |   "username": "user@example.com",                                                                                   |          |
|      |   "password": "••••••••",                                                                                           |          |
|      |   "url": "https://example.com",                                                                                     |          |
|      |   "notes": "Дополнительная информация",                                                                             |          |
|      |   "category": "Работа",                                                                                             |          |
|      |   "version": 1                                                                                                      |          |
|      | }                                                                                                                   |          |
|      | ```                                                                                                                 |          |

#### **4. Контроллер CRUD-операций**

Централизованный контроллер должен управлять всеми операциями с хранилищем с корректной обработкой ошибок.

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| CRUD-1 | Класс EntryManager **обязан** предоставлять:                                                                        | Must     |
|      | - `create_entry(data_dict) -> Entry`                                                                                |          |
|      | - `get_entry(entry_id) -> dict`                                                                                     |          |
|      | - `get_all_entries() -> list[dict]`                                                                                 |          |
|      | - `update_entry(entry_id, data_dict) -> Entry`                                                                      |          |
|      | - `delete_entry(entry_id, soft_delete=True)`                                                                        |          |
| CRUD-2 | Все операции **обязаны** быть транзакционными с возможностью отката при неудаче.                                    | Must     |
| CRUD-3 | EntryManager **обязан** публиковать соответствующие события:                                                        | Must     |
|      | - `EntryCreated`, `EntryUpdated`, `EntryDeleted`                                                                    |          |
| CRUD-4 | Мягкое удаление **должно** перемещать записи в таблицу `deleted_entries` с меткой времени истечения срока.          | Should   |

#### **5. Механизм генерации паролей**

Должен быть реализован безопасный, настраиваемый генератор паролей.

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| GEN-1 | Генератор **обязан** использовать `secrets.choice()` или `secrets.randbelow()` для всей случайности.                | Must     |
| GEN-2 | Параметры настройки **обязаны** включать:                                                                           | Must     |
|      | - Длину (8-64 символа, по умолчанию 16)                                                                             |          |
|      | - Наборы символов: заглавные (A-Z), строчные (a-z), цифры (0-9), спецсимволы (!@#$%^&*)                             |          |
|      | - Исключение неоднозначных символов (l, I, 1, 0, O)                                                                 |          |
| GEN-3 | Генератор **обязан** гарантировать, что в пароле есть хотя бы один символ из каждого выбранного набора.             | Must     |
| GEN-4 | Сгенерированные пароли **должны** проходить анализ надежности по zxcvbn или аналогичному методу (оценка ≥ 3/4).     | Should   |
| GEN-5 | История паролей **должна** предотвращать недавние дубликаты (последние 20 сгенерированных паролей).                 | Should   |

#### **6. Реализация табличного интерфейса**

Должен быть реализован безопасный, отзывчивый виджет таблицы для отображения записей хранилища.

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| GUI-1 | Основная таблица **обязана** отображать:                                                                            | Must     |
|      | - Заголовок (с возможностью сортировки)                                                                             |          |
|      | - Имя пользователя (маскируется как `••••` после 4 символов)                                                        |          |
|      | - URL/домен (извлеченный из полного URL)                                                                            |          |
|      | - Дата последнего изменения                                                                                         |          |
| GUI-2 | Функции таблицы **обязаны** включать:                                                                               | Must     |
|      | - Множественный выбор с shift/ctrl кликом                                                                           |          |
|      | - Изменение размера и перестановку колонок                                                                          |          |
|      | - Контекстное меню (правый клик) для действий                                                                       |          |
| GUI-3 | Видимость пароля **обязана** переключаться через:                                                                   | Must     |
|      | - Иконку глаза в колонке пароля                                                                                     |          |
|      | - Глобальный переключатель на панели инструментов                                                                   |          |
|      | - Горячую клавишу (Ctrl+Shift+P)                                                                                    |          |
| GUI-4 | Таблица **обязана** поддерживать 1000+ записей без деградации производительности.                                   | Must     |

#### **7. Диалог записи и управление формами**

Комплексный диалог должен обрабатывать создание и редактирование записей.

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| DIALOG-1 | Диалог записи **обязан** включать:                                                                                  | Must     |
|      | - Все поля формы с соответствующей валидацией                                                                       |          |
|      | - Индикатор надежности пароля                                                                                       |          |
|      | - Кнопку "Сгенерировать пароль" с всплывающим окном настроек                                                        |          |
|      | - Валидацию URL и получение фавиконки                                                                               |          |
| DIALOG-2 | Валидация формы **обязана** проверять:                                                                              | Must     |
|      | - Обязательные поля (заголовок, пароль)                                                                             |          |
|      | - Корректность формата URL                                                                                          |          |
|      | - Надежность пароля (если он не сгенерирован)                                                                       |          |
| DIALOG-3 | **Должно** работать автозаполнение имен пользователей на основе шаблонов доменов.                                   | Should   |

#### **8. Система поиска и фильтрации**

Поиск в реальном времени должен фильтровать записи по нескольким полям.

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| SEARCH-1 | Поиск **обязан** поддерживать:                                                                                      | Must     |
|      | - Полнотекстовый поиск по заголовку, имени пользователя, URL, заметкам                                              |          |
|      | - Нечеткое соответствие (допущение опечаток)                                                                        |          |
|      | - Фильтры по конкретным полям (например, `title:"работа"`)                                                          |          |
| SEARCH-2 | Результаты поиска **обязаны** обновляться в реальном времени по мере ввода пользователя.                            | Must     |
| SEARCH-3 | Фильтрация **должна** поддерживать:                                                                                 | Should   |
|      | - По категории/тегу                                                                                                 |          |
|      | - По диапазону дат                                                                                                  |          |
|      | - По надежности пароля                                                                                              |          |
| SEARCH-4 | История поиска **должна** запоминать последние 10 запросов.                                                         | Should   |

#### **9. Оптимизация и индексирование базы данных**

База данных должна быть оптимизирована для операций с хранилищем.

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| DB-1 | Таблица `vault_entries` **обязана** иметь индексы на:                                                               | Must     |
|      | - `created_at`, `updated_at`                                                                                        |          |
|      | - `tags` (для фильтрации по тегам)                                                                                  |          |
| DB-2 | Полнотекстовый поиск **должен** быть реализован через SQLite FTS5 или индексирование на уровне приложения.          | Should   |
| DB-3 | Подключение к базе данных **обязано** использовать пул соединений для конкурентных GUI-операций.                    | Must     |

#### **10. Тестирование и валидация**

Комплексное тестирование должно обеспечивать целостность и безопасность данных.

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| TEST-1 | **Тест цикла шифрования/расшифрования:**                                                                            | Must     |
|      | 1. Создать запись с известными данными                                                                              |          |
|      | 2. Убедиться, что зашифрованный BLOB не содержит открытого текста                                                   |          |
|      | 3. Расшифровать и убедиться в целостности данных                                                                    |          |
| TEST-2 | **Интеграционный тест CRUD:**                                                                                       | Must     |
|      | Создать 100 записей, выполнить обновления, удаления, проверить количество и целостность данных.                     |          |
| TEST-3 | **Тест на конкурентность:**                                                                                         | Should   |
|      | Имитировать одновременные GUI-операции, убедиться в отсутствии повреждения данных.                                  |          |
| TEST-4 | **Тест генератора паролей:**                                                                                        | Must     |
|      | Сгенерировать 10 000 паролей, проверить:                                                                            |          |
|      | - Отсутствие дубликатов (проверка вероятности)                                                                      |          |
|      | - Соответствие набору символов                                                                                      |          |
|      | - Соответствие требованиям надежности                                                                               |          |

#### **11. Требования к производительности**

Хранилище должно оставаться отзывчивым при реалистичных нагрузках.

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| PERF-1 | Загрузка 1000 записей **обязана** занимать < 2 секунд.                                                              | Must     |
| PERF-2 | Поиск среди 1000 записей **обязан** возвращать результат < 200 мс.                                                  | Must     |
| PERF-3 | Использование памяти **не должно** превышать 50 МБ для 1000 записей.                                                | Must     |

#### **12. Требования безопасности**

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| SEC-1 | Расшифрованные записи **обязаны** оставаться в памяти только пока отображаются.                                     | Must     |
| SEC-2 | Интеграция с буфером обмена (заглушка) **обязана** быть подготовлена для Спринта 4.                                 | Must     |
| SEC-3 | Все криптографические операции **обязаны** использовать алгоритмы с постоянным временем выполнения, где это применимо. | Must     |
| SEC-4 | Сообщения об ошибках **не должны** раскрывать существование идентификатора записи.                                  | Must     |

#### **13. Точки интеграции для будущих спринтов**

| ID  | Описание требования                                                                                                 | Приоритет |
| :-- | :------------------------------------------------------------------------------------------------------------------ | :------- |
| FUTURE-1 | Модель записи **обязана** включать поля для:                                                                        | Must     |
|      | - Секрета TOTP (для бонусной функции)                                                                               |          |
|      | - Метаданных для общего доступа (для Спринта 6)                                                                     |          |
| FUTURE-2 | Система событий **обязана** публиковать события для интеграции с буфером обмена (Спринт 4).                         | Must     |
| FUTURE-3 | Поисковый индекс **должен** поддерживать интеграцию с журналом аудита (Спринт 5).                                   | Should   |

---

**Пример реализации EntryManager:**

```python
# src/core/vault/entry_manager.py
import json
import uuid
from datetime import datetime
from cryptography.hazmat.primitives.ciphers.aead import AESGCM
import os

class EntryManager:
    def __init__(self, db_connection, key_manager):
        self.db = db_connection
        self.key_manager = key_manager
        self.aesgcm = AESGCM(key_manager.get_encryption_key())

    def create_entry(self, data: dict) -> str:
        """Создать новую запись в хранилище с шифрованием"""
        entry_id = str(uuid.uuid4())
        nonce = os.urandom(12)

        # Подготовка данных
        payload = {
            **data,
            'id': entry_id,
            'created_at': datetime.utcnow().isoformat(),
            'version': 1
        }

        # Шифрование
        plaintext = json.dumps(payload).encode('utf-8')
        ciphertext = self.aesgcm.encrypt(nonce, plaintext, None)

        # Сохранение
        encrypted_blob = nonce + ciphertext
        self.db.execute(
            "INSERT INTO vault_entries (id, encrypted_data, created_at, updated_at) VALUES (?, ?, ?, ?)",
            (entry_id, encrypted_blob, datetime.utcnow(), datetime.utcnow())
        )

        # Публикация события
        self.event_system.publish('EntryCreated', {'entry_id': entry_id})
        return entry_id

    def get_entry(self, entry_id: str) -> dict:
        """Получить и расшифровать запись"""
        row = self.db.execute(
            "SELECT encrypted_data FROM vault_entries WHERE id = ?",
            (entry_id,)
        ).fetchone()

        if not row:
            raise ValueError("Запись не найдена")

        encrypted_blob = row[0]
        nonce = encrypted_blob[:12]
        ciphertext = encrypted_blob[12:]

        plaintext = self.aesgcm.decrypt(nonce, ciphertext, None)
        return json.loads(plaintext.decode('utf-8'))
```
