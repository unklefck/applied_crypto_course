# **Проект: MicroPKI – Технические требования (Спринт 3)**

**Цель спринта:** Создать систему управления жизненным циклом сертификатов и базовый репозиторий путём реализации базы данных сертификатов, механизма уникальных серийных номеров и REST API для выдачи сертификатов и точек распространения CRL.

---

## 1. Структура проекта и гигиена репозитория

Кодовая база теперь должна включать интеграцию с базой данных и компонент HTTP-сервера.

| ID      | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                          | Приоритет |
|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **STR-9**  | Репозиторий **обязан** сохранять структуру, заложенную в Спринтах 1 и 2. Новые модули **обязаны** быть добавлены для работы с базой данных и функциональностью HTTP-сервера: <br> • **Python:** `database.py`, `repository.py`, `serial.py`.<br> • **Go:** `internal/database/`, `internal/repository/`, `internal/serial/`.                                                                                                                | **Must**  |
| **STR-10** | Файл `README.md` **обязан** быть обновлён, включая:<br> • Инструкции по инициализации базы данных сертификатов (`db init`).<br> • Как запустить HTTP-сервер репозитория.<br> • Примеры API-запросов (команды curl) для получения сертификатов.                                                                                                                                                                                                  | **Must**  |
| **STR-11** | **Рекомендуется** поддержка файла конфигурации (например, `config.yaml` или `micropki.conf`) для задания пути к БД по умолчанию, хоста/порта сервера, мест хранения сертификатов и т.д. Это опционально, но приветствуется.                                                                                                                                                                                                                     | **Could** |
| **STR-12** | Файлы базы данных (например, `certificates.db`) **обязаны** быть добавлены в `.gitignore`. Никакие конфиденциальные данные не должны попадать в репозиторий.                                                                                                                                                                                                                                                                                  | **Must**  |

---

## 2. Парсер командной строки (CLI)

Интерфейс командной строки должен поддерживать инициализацию базы данных, учёт сертификатов и управление сервером репозитория.

| ID       | Описание требования                                                                                                                                                                                                                                                                                                                                                          | Приоритет |
|----------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **CLI-12** | Инструмент **обязан** предоставлять подкоманду `db init`, которая создаёт схему базы данных SQLite и подготавливает её к использованию. <br> • **Необязательный аргумент:** `--db-path` – путь к файлу базы данных SQLite (по умолчанию: `./pki/micropki.db`).<br> • Команда **обязана** быть идемпотентной: если база данных уже существует и схема присутствует, она **должна** либо ничего не делать, либо выдать предупреждение.          | **Must**  |
| **CLI-13** | Инструмент **обязан** предоставлять подкоманду `ca list-certs`, которая выполняет запрос к базе данных и отображает все выпущенные сертификаты в удобочитаемом табличном формате (серийный номер, субъект, срок действия, статус). <br> • **Необязательный фильтр:** `--status` (valid, revoked, expired).<br> • **Необязательный формат:** `--format` (table, json, csv) – по умолчанию `table`.                                             | **Should**|
| **CLI-14** | Инструмент **обязан** предоставлять подкоманду `ca show-cert <serial>`, которая извлекает один сертификат из базы данных и выводит его PEM-содержимое в stdout.                                                                                                                                                                                                              | **Must**  |
| **CLI-15** | Инструмент **обязан** предоставлять подкоманду `repo serve`, которая запускает HTTP-сервер репозитория. <br> • **Аргументы:** <br>   - `--host` – адрес привязки (по умолчанию: `127.0.0.1`). <br>   - `--port` – TCP-порт (по умолчанию: `8080`). <br>   - `--db-path` – путь к базе данных SQLite (по умолчанию: `./pki/micropki.db`). <br>   - `--cert-dir` – каталог с PEM-сертификатами (по умолчанию: `./pki/certs`). <br> • Сервер **обязан** работать до прерывания (Ctrl+C) и логировать входящие запросы. | **Must**  |
| **CLI-16** | Инструменту **рекомендуется** предоставлять подкоманду `repo status`, которая сообщает, запущен ли сервер репозитория (если используется PID-файл) или просто проверяет доступность порта.                                                                                                                                                                                     | **Could** |
| **CLI-17** | Команды выпуска сертификатов (`ca issue-cert`, `ca issue-intermediate`) **обязаны** быть расширены для автоматической вставки только что выпущенного сертификата в базу данных. Дополнительные флаги не требуются; это **обязано** происходить прозрачно.                                                                                                                      | **Must**  |

**Примеры вызова:**

```bash
# 1. Инициализация базы данных сертификатов
$ micropki db init --db-path ./pki/micropki.db

# 2. Список всех действительных сертификатов
$ micropki ca list-certs --status valid --format table

# 3. Просмотр конкретного сертификата по серийному номеру
$ micropki ca show-cert 3A7B... --format pem

# 4. Запуск сервера репозитория
$ micropki repo serve --host 0.0.0.0 --port 8443 --db-path ./pki/micropki.db

# 5. Выпуск сертификата теперь автоматически сохраняет его в БД
$ micropki ca issue-cert ...   # (без изменений, но происходит вставка в БД)
```

---

## 3. Базовая реализация PKI (Интеграция с БД и серийные номера)

Процесс выпуска сертификатов теперь должен быть интегрирован с базой данных и обеспечивать уникальность серийных номеров.

| ID       | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                      | Приоритет |
|----------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **PKI-13** | **Генератор уникальных серийных номеров:** Инструмент **обязан** генерировать серийные номера сертификатов, **гарантированно уникальные** для всех сертификатов, выпущенных корневым и промежуточными УЦ. <br> • Серийный номер **обязан** быть положительным целым числом, содержащим не менее 20 бит случайности, но **также обязан** включать механизм обеспечения уникальности. <br> • **Рекомендуемый подход:** использовать 64-битное составное значение: старшие 32 бита = метка времени Unix (секунды) или постоянный счётчик из базы данных; младшие 32 бита = значение от CSPRNG. <br> • В столбце серийного номера таблицы **обязано** быть ограничение `UNIQUE`. | **Must**  |
| **PKI-14** | **Автоматическая вставка в БД при выпуске:** Сразу после подписания сертификата и записи на диск инструмент **обязан** вставить запись в таблицу `certificates`, содержащую: <br> • серийный номер (в виде шестнадцатеричной строки или целого числа). <br> • DN субъекта. <br> • DN издателя. <br> • временные метки notBefore / notAfter (ISO 8601). <br> • сертификат в формате PEM (полный текст). <br> • статус: `"valid"`. <br> • причина отзыва / дата: `NULL`.                                                                                                        | **Must**  |
| **PKI-15** | **Определение схемы базы данных:** База данных SQLite **обязана** содержать как минимум следующую таблицу:                                                                                                                                                                                                                                                                                                                                                | **Must**  |

```sql
CREATE TABLE certificates (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    serial_hex TEXT UNIQUE NOT NULL,          -- шестнадцатеричное представление, например "2A7F..."
    subject TEXT NOT NULL,
    issuer TEXT NOT NULL,
    not_before TEXT NOT NULL,                 -- ISO 8601
    not_after TEXT NOT NULL,                 -- ISO 8601
    cert_pem TEXT NOT NULL,                  -- полный сертификат в PEM
    status TEXT NOT NULL,                    -- 'valid', 'revoked', 'expired'
    revocation_reason TEXT,                  -- NULL если не отозван
    revocation_date TEXT,                   -- NULL если не отозван
    created_at TEXT NOT NULL                -- временная метка выпуска (ISO 8601)
);
```

*Для производительности **рекомендуется** создать дополнительные индексы по полям `serial_hex` и `status`.*

| ID       | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                      | Приоритет |
|----------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **PKI-16** | **Миграция базы данных:** Инструменту **рекомендуется** поддерживать простой автоматический механизм миграции при изменении схемы в будущих спринтах. Для Спринта 3 схема может создаваться с нуля через `db init`.                                                                                                                                                                                                                                         | **Should**|
| **PKI-17** | **Обработка ошибок:** Если вставка в базу данных не удалась (например, дубликат серийного номера, диск переполнен), выпуск сертификата **обязан** завершиться ошибкой, файл сертификата **не должен** быть записан, а ошибка **обязана** быть залогирована. Операция **обязана** быть максимально атомарной.                                                                                                                                               | **Must**  |

---

## 4. Хранение сертификатов и репозиторий (SQLite CRUD)

Помимо вставки, база данных должна поддерживать извлечение и обновление статуса.

| ID      | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                      | Приоритет |
|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **DB-1**  | **Получение по серийному номеру:** Инструмент **обязан** реализовать функцию для извлечения записи сертификата по его серийному номеру (шестнадцатеричному). Эта функция **обязана** использоваться как CLI (`ca show-cert`), так и HTTP API.                                                                                                                                                                                                              | **Must**  |
| **DB-2**  | **Список сертификатов:** Инструмент **обязан** реализовать функцию для запроса сертификатов с необязательными фильтрами: статус, издатель, диапазон дат. Это **обязано** обеспечивать работу CLI-команды `ca list-certs`.                                                                                                                                                                                                                                    | **Must**  |
| **DB-3**  | **Обновление статуса сертификата:** Хотя отзыв будет реализован в Спринте 4, база данных **обязана** быть готова к изменению статуса. Функции для обновления `status`, `revocation_reason` и `revocation_date` **рекомендуется** реализовать в виде заглушек (или полностью).                                                                                                                                                                           | **Should**|
| **DB-4**  | **Точка распространения CRL:** База данных **рекомендуется** предоставлять запрос для получения всех отозванных сертификатов (status = 'revoked') для генерации CRL. Полная генерация CRL – Спринт 4, но запрос **рекомендуется** подготовить уже сейчас.                                                                                                                                                                                                | **Should**|

---

## 5. Базовый репозиторий (HTTP-сервер)

Легковесный HTTP-сервер должен предоставлять сертификаты и сертификаты УЦ через REST-подобные эндпоинты.

| ID       | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                      | Приоритет |
|----------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **REPO-1** | **Реализация HTTP-сервера:** Инструмент **обязан** включать HTTP-сервер, который слушает указанные хост и порт. Сервер **обязан** запускаться через `repo serve` и работать до завершения. <br> • **Python:** `Flask` или `FastAPI` (рекомендуется) или встроенный `http.server` (проще). <br> • **Go:** Стандартный пакет `net/http`.                                                                                                                         | **Must**  |
| **REPO-2** | **Эндпоинт: GET /certificate/<serial>** <br> • Принимает серийный номер в шестнадцатеричном формате (регистронезависимо). <br> • Выполняет поиск сертификата в базе данных. <br> • Если найден, возвращает PEM-сертификат с `Content-Type: application/x-pem-file` (или `text/plain`). <br> • Если не найден, возвращает `404 Not Found`. <br> • Если сертификат отозван, **допускается** по-прежнему возвращать сертификат (или `410 Gone`) – в Спринте 3 это не принципиально. | **Must**  |
| **REPO-3** | **Эндпоинт: GET /ca/<level>** <br> • Поддерживает `level = root` и `level = intermediate`. <br> • Возвращает соответствующий сертификат УЦ (PEM) из каталога `--cert-dir`. <br> • Если файл не существует, возвращает `404 Not Found`. <br> • Content-Type как указано выше.                                                                                                                                                                              | **Must**  |
| **REPO-4** | **Эндпоинт: GET /crl** <br> • **Обязан существовать** как заглушка для Спринта 4. <br> • В Спринте 3 этот эндпоинт **должен** возвращать статус `501 Not Implemented` с текстовым сообщением «Генерация CRL ещё не реализована». <br> • В ответе **может** присутствовать подсказка с Content-Type `application/pkix-crl`.                                                                                                                                     | **Must**  |
| **REPO-5** | **Резервная выдача из файлов:** Сервер **рекомендуется** уметь отдавать файлы сертификатов напрямую из файловой системы, если они отсутствуют в базе данных (обратная совместимость). Это опционально.                                                                                                                                                                                                                                                   | **Could** |
| **REPO-6** | **Логирование:** Каждый HTTP-запрос **обязан** логироваться с уровнем `INFO`, включая временную метку, метод, путь, IP-адрес клиента и статус ответа.                                                                                                                                                                                                                                                                                                     | **Must**  |
| **REPO-7** | **CORS-заголовки:** Серверу **рекомендуется** включать заголовок `Access-Control-Allow-Origin: *`, чтобы разрешить тестирование из браузерных инструментов.                                                                                                                                                                                                                                                                                              | **Should**|
| **REPO-8** | **Обработка ошибок:** Некорректные серийные номера, отсутствующие параметры или неподдерживаемые методы **обязаны** возвращать соответствующие HTTP-статусы (`400`, `405`) с описательным сообщением об ошибке в виде обычного текста.                                                                                                                                                                                                                    | **Must**  |

**Примеры взаимодействия с API:**

```bash
# Получить сертификат по серийному номеру
$ curl http://localhost:8080/certificate/2A7F... --output cert.pem

# Получить сертификат корневого УЦ
$ curl http://localhost:8080/ca/root --output root.pem

# Получить сертификат промежуточного УЦ
$ curl http://localhost:8080/ca/intermediate --output intermediate.pem

# Эндпоинт CRL (заглушка)
$ curl http://localhost:8080/crl
501 Not Implemented
```

---

## 6. Логирование и аудит

Подсистема логирования теперь должна фиксировать события базы данных и репозитория.

| ID      | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                      | Приоритет |
|---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **LOG-6** | **Новые события логирования (CLI):** Следующие события **обязаны** логироваться с уровнем `INFO`:<br> • Инициализация базы данных (успех/неудача).<br> • Вставка сертификата (серийный номер, субъект).<br> • Получение сертификата через `ca show-cert` (серийный номер).<br> • Любые ошибки базы данных (нарушения ограничений, проблемы с подключением) **обязаны** логироваться с уровнем `ERROR`.                                      | **Must**  |
| **LOG-7** | **Журнал доступа к репозиторию:** Как указано в REPO-6, каждый HTTP-запрос **обязан** логироваться. Эти записи журнала **обязаны** быть отличимы от логов CLI (например, добавлением префикса `[HTTP]` или использованием отдельного логгера).                                                                                                                                                                                          | **Must**  |
| **LOG-8** | **Целостность журнала аудита (подготовка):** Инструменту **рекомендуется** начать подготовку к обеспечению целостности журнала аудита (Спринт 7) путём записи логов в структурированном формате (JSON) в отдельный файл при использовании `--log-file` вместе с `repo serve`. Для Спринта 3 это **опционально**.                                                                                                                          | **Could** |

---

## 7. Тестирование и проверка

Готовое решение должно демонстрировать корректную интеграцию с базой данных и функциональность репозитория.

| ID       | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Приоритет |
|----------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **TEST-13** | **Тест вставки в базу данных:** Выпустите не менее 5 сертификатов (смесь серверных, клиентских и для подписи кода) с помощью команд выпуска из Спринта 2. После каждого выпуска убедитесь, что база данных содержит соответствующую запись с корректными полями и что серийный номер уникален.                                                                                                                                                                                                                                      | **Must**  |
| **TEST-14** | **Тест получения через CLI:** Используйте `ca list-certs` и `ca show-cert` для извлечения сертификатов, вставленных в TEST-13. Убедитесь, что вывод соответствует ожидаемым субъектам и серийным номерам.                                                                                                                                                                                                                                                                                                                         | **Must**  |
| **TEST-15** | **Тест API репозитория – получение сертификата:** Запустите сервер репозитория. Для каждого сертификата, выпущенного в TEST-13, выполните HTTP GET на `/certificate/<serial>` и убедитесь, что возвращённый PEM совпадает с локально сохранённым файлом сертификата.                                                                                                                                                                                                                                                             | **Must**  |
| **TEST-16** | **Тест API репозитория – получение УЦ:** Выполните HTTP GET на `/ca/root` и `/ca/intermediate`. Убедитесь, что возвращённые PEM-файлы совпадают с файлами на диске.                                                                                                                                                                                                                                                                                                                                                             | **Must**  |
| **TEST-17** | **Нагрузочный тест уникальности серийных номеров:** Напишите скрипт, который в цикле выпускает 100 сертификатов (с автоматическим изменением субъекта). Убедитесь, что не возникает нарушений ограничения уникальности в БД (т.е. все серийные номера уникальны). Этот тест **рекомендуется** включить в набор тестов, но допустимо задокументировать отдельно.                                                                                                                                                                      | **Should**|
| **TEST-18** | **Негативный тест – дубликат серийного номера:** Попытайтесь вручную вставить сертификат с дублирующимся серийным номером (например, напрямую манипулируя БД). Команда выпуска инструмента **не должна** порождать дубликаты; этот тест проверяет, что генератор серийных номеров достаточно надёжен.                                                                                                                                                                                                                             | **Should**|
| **TEST-19** | **Негативный тест – неверный формат серийного номера:** Отправьте запрос на `/certificate/XYZ` (не шестнадцатеричное) и ожидайте `400 Bad Request`.                                                                                                                                                                                                                                                                                                                                                                              | **Should**|
| **TEST-20** | **Интеграционный тест:** Продемонстрируйте полный рабочий процесс: инициализация БД → выпуск промежуточного УЦ (автоматически вставлен) → выпуск 3 конечных сертификатов → запуск репозитория → получение одного конечного сертификата через API → проверка соответствия. **Рекомендуется** автоматизировать этот процесс в одном тестовом скрипте.                                                                                                                                                                             | **Should**|

---

## 8. Сводка обязательного технического стека (дополнения для Спринта 3)

| Компонент             | Требование (дополнения для Спринта 3)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|-----------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **База данных**       | • **SQLite** (версия 3.x) **обязательна** к использованию.<br> • **Python:** `sqlite3` (стандартная библиотека).<br> • **Go:** `database/sql` + драйвер `github.com/mattn/go-sqlite3`.                                                                                                                                                                                                                                                                                                                                          |
| **HTTP-сервер**       | • **Python:** `Flask`, `FastAPI` или `http.server` (встроенный). Рекомендуются `Flask`/`FastAPI` для более чистой реализации API.<br> • **Go:** Стандартный пакет `net/http`.                                                                                                                                                                                                                                                                                                                                                 |
| **Серийный номер**    | • Рекомендуется 64-битное целое число.<br> • Должен быть уникальным для всех сертификатов, когда-либо выпущенных данной PKI.<br> • Хранится в базе данных как шестнадцатеричная строка (или INTEGER).                                                                                                                                                                                                                                                                                                                         |
| **Конфигурация**      | • Обязательный файл конфигурации не требуется; достаточно флагов CLI.<br> • Если используется, допустимы форматы YAML или JSON.                                                                                                                                                                                                                                                                                                                                                                                               |
| **Логирование**       | • То же, что в Спринтах 1/2. Новые обязательные библиотеки не требуются.<br> • Логирование HTTP-запросов **обязано** быть реализовано.                                                                                                                                                                                                                                                                                                                                                                                        |
| **Тестирование**      | • Дополнительные модульные тесты для функций работы с БД, генератора серийных номеров и эндпоинтов API.<br> • **Обязательно** использование `pytest` (Python) или `go test` (Go).                                                                                                                                                                                                                                                                                                                                              |

---

**Конец требований Спринта 3**
*Все требования могут быть уточнены. В случае сомнений отдавайте предпочтение корректной интеграции с базой данных и работающему репозиторию в режиме «только чтение», а не расширенным функциям.*
