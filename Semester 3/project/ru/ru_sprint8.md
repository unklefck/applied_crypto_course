# **Проект: MicroPKI - Документ с техническими требованиями (Спринт 8)**

**Цель спринта:** Создать полностью интегрированную, демонстрируемую PKI‑систему, которая наглядно покажет результаты всех предыдущих спринтов в реалистичных сценариях. Разработать готовый сценарий демонстрации, интегрировать поддержку TLS и подписи кода, финализировать документацию и представить полный набор тестов, охватывающих корректность, граничные случаи и производительность.

---

## 1. Структура проекта и состояние репозитория

Репозиторий должен находиться в финальном, готовом к поставке состоянии со всеми корректно организованными исходными кодами, документацией и материалами для демонстрации.

| ID       | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                   | Приоритет |
|----------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **STR‑26** | В репозитории **обязательно** должна быть создана **метка (tag)** релиза (например, `v1.0.0`), соответствующая итоговому результату спринта 8. Метка **обязана** быть отправлена в удалённый репозиторий.                                                                                                                                                                                                                                            | **Must**  |
| **STR‑27** | Файл `README.md` **обязан** быть всеобъемлющим, выверенным и содержать все разделы, описанные в Разделе 6. Он **обязан** быть основной точкой входа для всех, кто оценивает проект.                                                                                                                                                                                                                                                                    | **Must**  |
| **STR‑28** | Все исходные коды, тесты, конфигурационные файлы и демонстрационные скрипты **обязаны** быть зафиксированы в репозитории и отправлены. Сгенерированные файлы (сертификаты, ключи, базы данных, журналы) **не должны** попадать в репозиторий; они **обязаны** быть перечислены в `.gitignore`.                                                                                                                                                          | **Must**  |
| **STR‑29** | В репозитории **рекомендуется** создать каталог `demo/`, содержащий все ресурсы, необходимые для запуска демонстрационного сценария (например, файлы конфигурации, примеры скриптов, тестовые файлы). Назначение этого каталога **обязано** быть чётко задокументировано.                                                                                                                                                                                | **Should** |
| **STR‑30** | В корневом каталоге **желательно** наличие файла `LICENSE` (например, MIT, Apache 2.0). Это требование не является обязательным, но настоятельно рекомендуется.                                                                                                                                                                                                                                                                                        | **Could** |

---

## 2. Парсер командной строки (CLI)

В спринте 8 не требуется реализация новых крупных функций. Однако CLI **обязан** быть полностью работоспособным и хорошо задокументированным. При необходимости **могут** быть добавлены вспомогательные команды для удобства демонстрации.

| ID        | Описание требования                                                                                                                                                                                                                                                                                                                                                       | Приоритет |
|-----------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **CLI‑36** | Все ранее реализованные команды CLI (`ca init`, `ca issue-intermediate`, `ca issue-cert`, `ca revoke`, `ca gen-crl`, `ca issue-ocsp-cert`, `ocsp serve`, `repo serve`, `client gen-csr`, `client request-cert`, `client validate`, `client check-status`, `audit query`, `audit verify`, `ca compromise`) **обязаны** работать без ошибок при вызове в соответствии с документацией. | **Must**  |
| **CLI‑37** | Новая вспомогательная команда `demo run` **может** быть добавлена для выполнения всего сценария демонстрации (Раздел 3) за один шаг. Это необязательно, но приветствуется.                                                                                                                                                                                             | **Could** |
| **CLI‑38** | Вывод справки `--help` для каждой команды **обязан** быть точным, полным и удобным для восприятия. Все аргументы и флаги **обязаны** быть описаны.                                                                                                                                                                                                                     | **Must**  |

---

## 3. Сценарий демонстрации

Студент должен предоставить самодостаточный, автоматизированный демонстрационный скрипт, который проведёт зрителя через полный сценарий использования PKI, демонстрируя все ключевые возможности системы.

| ID        | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | Приоритет |
|-----------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **DEMO‑1** | Демонстрация **обязана** быть реализована в виде **одного исполняемого скрипта** (например, `demo.sh`, `demo.py` или `make demo`), который можно запустить в чистом окружении. Скрипт **обязан**:<br> • Создать необходимую структуру каталогов.<br> • Инициализировать корневой УЦ.<br> • Инициализировать промежуточный УЦ (подписанный корневым).<br> • Выпустить как минимум один **серверный** сертификат.<br> • Выпустить как минимум один **клиентский** сертификат.<br> • Выпустить сертификат для **OCSP‑ответчика**.<br> • Запустить сервер репозитория (в фоне или в отдельном терминале).<br> • Запустить OCSP‑ответчик (в фоне).<br> • Выполнить успешную проверку сертификата (полная цепочка + проверка отзыва).<br> • Отозвать сертификат.<br> • Продемонстрировать, что отозванный сертификат теперь отклоняется.<br> • Продемонстрировать **целостность журнала аудита** (например, проверить хеш‑цепочку).<br> • Продемонстрировать **применение политик** (например, показать, что некорректный запрос сертификата отклоняется).<br> • Остановить все серверы. | **Must**  |
| **DEMO‑2** | Демонстрационный скрипт **должен** быть **идемпотентным** – повторный запуск в том же каталоге **должен** либо выполнять очистку перед началом работы, либо корректно обрабатывать уже существующее состояние (например, использовать временные каталоги).                                                                                                                                                                                                                                                                            | **Should** |
| **DEMO‑3** | Демонстрационный скрипт **должен** выводить понятный человеку текст, указывая каждый шаг и его результат (например, `[УСПЕШНО]`, `[ОШИБКА]`). Приветствуется цветной вывод.                                                                                                                                                                                                                                                                                                                                                        | **Should** |
| **DEMO‑4** | Демонстрационный скрипт **не должен** требовать какого‑либо ручного вмешательства (например, ввода парольных фраз). Все парольные фразы **обязаны** считываться из файлов, создаваемых в процессе демонстрации, либо передаваться через переменные окружения.                                                                                                                                                                                                                                                                     | **Must**  |
| **DEMO‑5** | **Письменное описание** демонстрации **обязано** быть включено в `README.md` или в отдельный файл `DEMO.md`. В нём **необходимо** объяснить, что делает каждый шаг и почему он важен.                                                                                                                                                                                                                                                                                                                                               | **Must**  |

---

## 4. Интеграция с TLS

Студент должен продемонстрировать, что сертификат, выпущенный его PKI, может быть использован для защиты реального TLS‑соединения.

| ID       | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | Приоритет |
|----------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **TLS‑1** | **Демонстрация TLS‑сервера:** Студент **обязан** настроить простой веб‑сервер (например, `http.server` на Python, `nginx` или `openssl s_server`) для использования **серверного сертификата**, выпущенного его промежуточным УЦ, вместе с соответствующим закрытым ключом. <br> • Сервер **обязан** быть запущен в ходе демонстрации (вручную или через скрипт).<br> • Клиент (например, `curl`, `wget`, `openssl s_client`) **обязан** успешно подключаться **только** при указании корневого сертификата в качестве доверенного.<br> • Демонстрация **обязана** быть задокументирована в README с точными командами.                                     | **Must**  |
| **TLS‑2** | **OCSP-степлинг (реальный или симулированный):** Студенту **рекомендуется** продемонстрировать OCSP-степлинг. Это можно сделать одним из способов:<br> • Использовать `openssl s_server -status`, передав файл с ответом OCSP.<br> • Настроить веб‑сервер с поддержкой стеллинга (например, nginx с `ssl_stapling`).<br> • Имитировать, показав вручную, что сертификат содержит URL OCSP‑ответчика и что ответчик возвращает статус `good`.<br> Данное требование **необязательно**, но настоятельно рекомендуется.                                                                       | **Could** |
| **TLS‑3** | **Демонстрация отзыва:** В демонстрацию **обязан** быть включён шаг, на котором серверный сертификат отзывается, и последующие TLS‑подключения **завершаются ошибкой**, если клиент выполняет проверку отзыва (CRL или OCSP). Это **обязано** быть чётко показано и задокументировано.                                                                                                                                                                                                                                  | **Must**  |

**Пример демонстрации (должен быть задокументирован):**
```bash
# Запуск простого HTTPS‑сервера с выпущенным сертификатом
$ python3 -m http.server 8443 --certfile server.cert.pem --keyfile server.key.pem

# Подключение клиента с доверием к корневому УЦ
$ curl --cacert root.cert.pem https://localhost:8443

# Отзыв сертификата
$ micropki ca revoke <serial> --reason keyCompromise

# Генерация свежего CRL и перезапуск сервера (или использование OCSP)
# Клиент с проверкой отзыва теперь должен завершиться ошибкой
```

---

## 5. Демонстрация подписи кода

Студент должен продемонстрировать, что сертификат для подписи кода, выпущенный его PKI, может быть использован для подписания и проверки скрипта или бинарного файла.

| ID         | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Приоритет |
|------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **CSIGN‑1** | **Сертификат для подписи кода:** Студент **обязан** выпустить сертификат с шаблоном **code signing** от своего промежуточного УЦ (в соответствии со спринтами 2/6).                                                                                                                                                                                                                                                                                                                                              | **Must**  |
| **CSIGN‑2** | **Демонстрация подписи:** Студент **обязан** продемонстрировать подписание простого файла (например, Python‑скрипта, shell‑скрипта или текстового файла) с использованием закрытого ключа сертификата для подписи кода. <br> • Процесс подписания **обязан** использовать стандартный формат (например, отделённую подпись PKCS#7 или простую подпись SHA‑256 хеша закрытым ключом).<br> • Студент **обязан** предоставить инструмент (или расширить `micropki client`) для выполнения подписания и проверки. <br> • Демонстрация **обязана** быть полностью задокументирована.                                                                 | **Must**  |
| **CSIGN‑3** | **Демонстрация проверки:** Студент **обязан** продемонстрировать, что подпись успешно проверяется с помощью сертификата для подписи кода и доверенного корневого УЦ. <br> • Проверка **обязана** завершаться ошибкой, если файл был изменён. <br> • Проверка **обязана** завершаться ошибкой, если сертификат отозван (опционально, но приветствуется).                                                                                                                                                           | **Must**  |
| **CSIGN‑4** | **Инструментарий:** Студент **может** реализовать простые подкоманды `client sign` и `client verify`. В качестве альтернативы **можно** использовать команды OpenSSL (`openssl dgst -sign`, `openssl dgst -verify`) для демонстрации концепции. Основной акцент – показать, что выпущенный сертификат пригоден для подписи кода, а не на создании промышленного инструмента.                                                                                                                                         | **Should** |

**Пример демонстрации (на основе OpenSSL):**
```bash
# Подписать скрипт
$ openssl dgst -sha256 -sign code_signing.key.pem -out script.sh.sig script.sh

# Проверить подпись
$ openssl dgst -sha256 -verify <(openssl x509 -in code_signing.cert.pem -pubkey -noout) -signature script.sh.sig script.sh
```

---

## 6. Финальная документация

Проект должен быть тщательно задокументирован, чтобы новый пользователь мог понять, собрать и использовать систему.

| ID       | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | Приоритет |
|----------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **DOC‑1** | **README.md** – корневой файл `README.md` **обязан** содержать следующие разделы, чётко оформленные:<br> • **Название проекта и краткое описание (One‑Liner)** – ёмкое описание.<br> • **Возможности (Features)** – маркированный список основных функций (по спринтам).<br> • **Схема архитектуры** – визуальное представление компонентов PKI, их взаимодействия и потоков данных. Это **обязан** быть рисунок (PNG/SVG), встроенный в README или связанный ссылкой. (См. DOC‑2).<br> • **Предварительные требования** – необходимое ПО (Python/Go, OpenSSL и т.д.).<br> • **Инструкция по установке / сборке** – пошаговые команды для установки зависимостей и сборки/установки инструмента.<br> • **Конфигурация** – объяснение конфигурационного файла (если реализован).<br> • **Справочник по CLI** – исчерпывающий перечень всех команд и подкоманд с примерами. Может быть сгенерирован или написан вручную.<br> • **Описание демонстрации** – подробное объяснение, как запустить демонстрационный скрипт, с ожидаемым выводом.<br> • **Справочник API** – если используются конечные точки сервера репозитория, необходимо задокументировать их (пути, методы, параметры, примеры).<br> • **Аспекты безопасности** – обсуждение известных ограничений, допущений и рекомендаций по безопасному использованию системы. Включить предупреждения о незашифрованных ключах конечных субъектов, обработке парольных фраз и т.д.<br> • **Благодарности / Источники** – использованные RFC, библиотеки, учебные материалы. | **Must**  |
| **DOC‑2** | **Схема архитектуры:** Студент **обязан** создать чёткую схему архитектуры, показывающую основные компоненты (CLI, модули CA, база данных, сервер репозитория, OCSP‑ответчик, клиентские инструменты, система аудита) и их связи. Схема **обязана** быть включена в README (как изображение) или в каталог `docs/`. Допустимые инструменты: `draw.io`, `PlantUML`, `Mermaid` (совместимая с Markdown).                                                                                                                                                                                                                                            | **Must**  |
| **DOC‑3** | **Аспекты безопасности:** Студент **обязан** явно задокументировать следующие моменты (если применимо):<br> • Закрытые ключи конечных субъектов хранятся незашифрованными (предупреждение).<br> • Ключи корневого/промежуточного УЦ зашифрованы, но парольные фразы считываются из файлов – обсудить риски.<br> • OCSP‑ответчик не использует HTTPS (если не реализовано) – отсутствие защиты транспортного уровня.<br> • Ограничение скорости является базовым и может не защищать от распределённых атак.<br> • Целостность журнала аудита основана на хеш‑цепочке, но сам файл журнала не подписан.<br> • Certificate Transparency только симулируется (нет дерева Меркла, нет публичного обмена).<br> • Система предназначена для обучения и не рекомендуется к использованию в производственной среде без дополнительного усиления защиты. | **Must**  |
| **DOC‑4** | **Справочник CLI/API:** Студент **обязан** предоставить полный справочник всех команд CLI и их параметров, а также конечных точек REST API (если реализованы). Это **может** быть размещено в README или в отдельных markdown‑файлах в каталоге `docs/`.                                                                                                                                                                                                                                                                                                                             | **Must**  |
| **DOC‑5** | **Документирование кода (inline):** Все публичные функции, методы и сложная логика **обязаны** быть документированы с помощью docstring/комментариев, объясняющих назначение, параметры и возвращаемые значения. Студенту **рекомендуется** следовать стандартному для языка стилю документации (например, docstrings в Python, комментарии в Go).                                                                                                                                                                                                                                  | **Should** |

---

## 7. Набор тестов

Финальный спринт требует всеобъемлющего, автоматизированного набора тестов, проверяющих корректность, устойчивость и производительность.

| ID          | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | Приоритет |
|-------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **TEST‑61** | **Всеобъемлющий набор тестов:** Проект **обязан** включать автоматизированный набор тестов, который обеспечивает **не менее 80% покрытия кода** (покрытие строк) для основной логики PKI, механизма проверки, модулей отзыва и CLI. <br> • **Python:** `pytest` с `pytest-cov`.<br> • **Go:** `go test -cover`.<br> • Отчёт о покрытии **обязан** быть задокументирован в README или отображаться через бейдж CI.                                                                                                                                                                                                                                             | **Must**  |
| **TEST‑62** | **Граничные случаи – просроченные сертификаты:** Набор тестов **обязан** включать проверки просроченных сертификатов (с использованием фиксированного времени проверки или манипуляции системным временем).                                                                                                                                                                                                                                                                                                                                                                                | **Must**  |
| **TEST‑63** | **Граничные случаи – неверное использование ключа:** Набор тестов **обязан** включать сценарии, где сертификат используется не по назначению (например, клиентский сертификат применяется как серверный). Валидатор **должен** обнаруживать и сообщать о таком использовании (если реализована проверка EKU).                                                                                                                                                                                                                                                                                | **Should** |
| **TEST‑64** | **Граничные случаи – некорректные входные данные:** Набор тестов **обязан** включать тесты с передачей повреждённых PEM/DER‑файлов, недействительных CSR, испорченных журналов аудита и т.п. для проверки корректной обработки ошибок.                                                                                                                                                                                                                                                                                                                                                     | **Must**  |
| **TEST‑65** | **Тест производительности – 1000 сертификатов:** Набор тестов **обязан** включать тест производительности, который:<br> • Выпускает **1000 сертификатов** (синтетических, автоматизированных) с помощью CA.<br> • Измеряет время, затраченное на выпуск и вставку в базу данных.<br> • Выполняет проверку всех 1000 сертификатов.<br> • Выводит результаты (например, количество сертификатов в секунду).<br> • Этот тест **может** быть помечен как «медленный» и пропускаться по умолчанию, но **обязан** запускаться по специальной команде (например, `make perf-test` или `pytest -m perf`).                                                                 | **Must**  |
| **TEST‑66** | **Тест производительности – нагрузка CRL/OCSP:** Набор тестов **должен** включать тест производительности, имитирующий 1000 OCSP‑запросов или загрузок CRL, и измерять время ответа.                                                                                                                                                                                                                                                                                                                                                                                                        | **Could**  |
| **TEST‑67** | **Непрерывная интеграция (CI):** В репозитории **рекомендуется** настроить CI‑сервис (например, GitHub Actions, GitLab CI), который автоматически запускает набор тестов при каждом push и pull request. Бейдж CI **желательно** разместить в README.                                                                                                                                                                                                                                                                                                                                        | **Should** |
| **TEST‑68** | **Документация тестов:** Набор тестов **обязан** быть задокументирован: как запускать тесты, как интерпретировать результаты, какие есть особые требования (например, необходимость установки OpenSSL).                                                                                                                                                                                                                                                                                                                                                                                   | **Must**  |

---

## 8. Сводка обязательных технологических решений (дополнения для спринта 8)

| Компонент             | Требование (дополнения спринта 8)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|-----------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Демо-скрипт**       | • Любой язык (Bash, Python, Go‑скрипт), который оркестрирует демонстрацию.<br> • **Обязан** быть исполняемым и самодостаточным.<br> • **Обязан** использовать временные каталоги или выполнять очистку после себя.                                                                                                                                                                                                                                                                                                                                                                                      |
| **Интеграция с TLS**  | • Новые библиотеки не требуются; использовать существующие системные инструменты (`openssl`, `curl`, `python3 -m http.server`, `nginx` и т.д.).<br> • Демонстрация **обязана** быть воспроизводимой с задокументированными командами.                                                                                                                                                                                                                                                                                                                                                                 |
| **Подпись кода**      | • Для подписания/проверки **можно** использовать командную строку **OpenSSL**.<br> • Альтернативно, реализовать собственные команды `client sign` / `client verify` с использованием библиотек `cryptography` или стандартной библиотеки Go.                                                                                                                                                                                                                                                                                                                                                           |
| **Документация**      | • Схема архитектуры: любой формат (PNG, SVG, Mermaid).<br> • README в формате Markdown.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Набор тестов**      | • **Python:** `pytest`, `pytest-cov`, `pytest-benchmark` (опционально).<br> • **Go:** пакет `testing`, `go test -bench` для производительности.<br> • Целевое покрытие: **≥80%** покрытие строк.                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Тест производительности** | • Должен обрабатывать 1000 выпусков сертификатов.<br> • Рекомендуется изоляция (использовать SQLite в памяти или временные файлы).                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **CI**                | • GitHub Actions, GitLab CI и т.п. (опционально).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |

---

**Окончание требований спринта 8**
*Все требования могут быть уточнены. В случае сомнений отдавайте приоритет чистой, воспроизводимой демонстрации и тщательной документации перед расширенными оптимизациями производительности.*
