# **Проект: MicroPKI - Технические требования (Спринт 1)**

**Цель спринта:** Заложить фундамент инфраструктуры открытых ключей (PKI) путём реализации самоподписанного корневого удостоверяющего центра (УЦ) с безопасным хранением ключей, генерацией сертификата и базовым журналированием аудита.

---

## 1. Структура проекта и гигиена репозитория

Кодовая база должна быть чистой, находиться под версионным контролем и легко собираться/запускаться.

| ID      | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                 | Приоритет |
|---------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **STR-1** | Проект **обязан** размещаться в Git-репозитории (например, GitHub, GitLab). Файл `.gitignore` **обязан** исключать артефакты сборки, виртуальные окружения и файлы с конфиденциальной информацией (например, закрытые ключи).                                                                                                                                                                                                                         | **Must**  |
| **STR-2** | Файл `README.md` **обязан** присутствовать в корневой директории и содержать: <br> • Название проекта и одно предложение с его описанием.<br> • **Инструкцию по сборке** – чёткие команды для настройки окружения и установки зависимостей.<br> • **Инструкцию по использованию** – как минимум один полный пример CLI-команды для Спринта 1.<br> • **Зависимости** – список всех внешних библиотек/инструментов (например, Python 3.9+, `cryptography`, Go 1.18+ и т.д.).                                               | **Must**  |
| **STR-3** | В репозитории **обязан** присутствовать файл управления зависимостями/сборкой: <br> • **Для Python:** `requirements.txt` **или** `pyproject.toml` (с указанием `cryptography`).<br> • **Для Go:** `go.mod` и `go.sum`.                                                                                                                                                                                                                               | **Must**  |
| **STR-4** | Исходный код **обязан** быть логически организован. **Рекомендуются** следующие структуры (с адаптацией под выбранный язык):                                                                                                                                                                                                                                                                                                                        | **Should**|
| **STR-5** | В проекте **обязан** присутствовать скрипт или цель в makefile для запуска всех тестов (например, `make test`, `go test ./...`, `pytest`).                                                                                                                                                                                                                                                                                                          | **Should**|

**Рекомендуемая структура каталогов для Go:**

```
project_root/
├── micropki/
│   ├── cmd/
│   │   └── micropki/
│   │       └── main.go
│   ├── internal/
│   │   ├── ca/             # операции УЦ
│   │   ├── certs/          # работа с сертификатами
│   │   └── crypto/         # крипто-утилиты
│   ├── tests/              # модульные/интеграционные тесты
│   ├── go.mod
│   └── README.md
└── ...
```

**Рекомендуемая структура каталогов для Python:**

```
project_root/
├── micropki/
│   ├── __init__.py
│   ├── cli.py              # парсер аргументов
│   ├── ca.py               # логика корневого УЦ
│   ├── certificates.py     # работа с X.509
│   ├── crypto_utils.py     # PEM, загрузка ключей, шифрование
│   └── logger.py           # настройка логирования
├── tests/                  # файлы pytest
├── requirements.txt
└── README.md
```

---

## 2. Парсер командной строки (CLI)

Инструмент должен вызываться как `micropki` и поддерживать отдельную подкоманду для инициализации корневого УЦ.

| ID      | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                 | Приоритет |
|---------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **CLI-1** | Инструмент **обязан** быть доступен для вызова как `micropki` после установки/сборки.                                                                                                                                                                                                                                                                                                                                                               | **Must**  |
| **CLI-2** | Инструмент **обязан** предоставлять подкоманду `ca init`, которая создаёт самоподписанный корневой УЦ. Других подкоманд в Спринте 1 не требуется, но парсер **обязан** быть расширяемым для последующих этапов.                                                                                                                                                                                                                                    | **Must**  |
| **CLI-3** | Подкоманда `ca init` **обязана** принимать следующие аргументы:<br> • `--subject`   – отличительное имя (DN), например, `/CN=My Root CA` или `CN=My Root CA,O=Demo,C=US`.<br> • `--key-type`  – `rsa` или `ecc` (по умолчанию `rsa`).<br> • `--key-size`  – длина ключа в битах. Для RSA **обязано** быть `4096`; для ECC **обязано** быть `384` (NIST P‑384).<br> • `--passphrase-file` – путь к файлу, содержащему парольную фразу для шифрования закрытого ключа.<br> • `--out-dir`    – выходной каталог (по умолчанию `./pki`).<br> • `--validity-days` – срок действия в днях (по умолчанию `3650` ≈ 10 лет).<br> • `--log-file`   – необязательный путь к файлу журнала. Если параметр опущен, журнал **обязан** выводиться в stderr. | **Must**  |
| **CLI-4** | Парсер аргументов **обязан** выполнять валидацию всех входных данных:<br> • Должен быть указан ровно один `--subject` и это **обязана** быть непустая строка.<br> • `--key-type` обязан быть `rsa` или `ecc`.<br> • `--key-size` обязан соответствовать выбранному типу (4096 для RSA, 384 для ECC).<br> • `--passphrase-file` обязан существовать и быть доступным для чтения.<br> • `--out-dir` может быть создан, если не существует; если существует, он обязан быть доступен для записи.<br> • `--validity-days` обязан быть положительным целым числом.<br> При любой ошибке валидации инструмент **обязан** вывести понятную ошибку в stderr и завершиться с ненулевым кодом возврата. | **Must**  |
| **CLI-5** | Инструмент **обязан** обрабатывать парольную фразу безопасно: содержимое `--passphrase-file` **обязано** быть прочитано как байты; завершающий символ новой строки **рекомендуется** отбросить. Парольная фраза **ни при каких обстоятельствах не должна** попадать в журналы или отображаться на консоли.                                                                                                                                          | **Must**  |
| **CLI-6** | Если `--out-dir` уже содержит файлы, которые будут перезаписаны (например, `private/ca.key.pem`, `certs/ca.cert.pem`), инструменту **рекомендуется** запрашивать подтверждение или отказываться от перезаписи, если не указан дополнительный флаг `--force` (опционально).                                                                                                                                                                          | **Could** |

**Примеры вызова:**

```bash
# Корневой УЦ на основе RSA
$ micropki ca init \
    --subject "/CN=Demo Root CA" \
    --key-type rsa \
    --key-size 4096 \
    --passphrase-file ./secrets/ca.pass \
    --out-dir ./pki \
    --validity-days 7300 \
    --log-file ./logs/ca-init.log

# Корневой УЦ на основе ECC (P-384)
$ micropki ca init \
    --subject "CN=ECC Root CA,O=MicroPKI" \
    --key-type ecc \
    --key-size 384 \
    --passphrase-file ./secrets/ca.pass \
    --out-dir ./pki
```

---

## 3. Базовая реализация PKI

Все криптографические операции должны полагаться на зрелые, проверенные библиотеки. **Запрещена самостоятельная реализация криптографических примитивов (AES, RSA, ECDSA, хеширование).**

| ID      | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | Приоритет |
|---------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **PKI-1** | **Генерация ключей:**<br> • **RSA:** Сгенерировать пару ключей RSA длиной 4096 бит с использованием криптостойкого генератора случайных чисел.<br> • **ECC:** Сгенерировать закрытый ключ на кривой NIST P‑384 (secp384r1).                                                                                                                                                                                                                                                                                         | **Must**  |
| **PKI-2** | **Самоподписанный сертификат X.509:**<br> • Версия: `v3` (значение 2).<br> • Серийный номер: положительное целое число, генерируемое с помощью CSPRNG, минимум 20 бит энтропии (например, 20-байтовое случайное число).<br> • Субъект: устанавливается точно в соответствии со строкой DN, переданной через `--subject`. Парсер **обязан** корректно обрабатывать распространённые форматы DN (нотация с косой чертой `/CN=...` или через запятую `CN=...,O=...`).<br> • Издатель: идентичен субъекту (самоизданный).<br> • Срок действия: `notBefore` = текущее UTC-время, `notAfter` = `notBefore` + `validity_days`.<br> • Алгоритм подписи: для RSA – `sha256WithRSAEncryption`; для ECC – `ecdsa-with-SHA384`. | **Must**  |
| **PKI-3** | **Расширения X.509v3 (все критические, где указано):**<br> • **Basic Constraints:** `CA=TRUE`, ограничение длины пути **не должно** устанавливаться (или устанавливается `nil` / `MaxPathLen=0` без ограничения). Это расширение **обязано** быть критическим.<br> • **Key Usage:** **обязано** включать `keyCertSign` и `cRLSign`. Рекомендуется также добавить `digitalSignature` (опционально). Это расширение **обязано** быть критическим.<br> • **Идентификатор ключа субъекта (SKI):** **обязан** вычисляться из открытого ключа. Предпочтительный метод – SHA‑1-хеш битовой строки `subjectPublicKey` (как в RFC 5280).<br> • **Идентификатор ключа издателя (AKI):** для самоподписанного сертификата **обязан** совпадать с SKI.                                                                                                                                                                                                                                             | **Must**  |
| **PKI-4** | **Кодировка сертификата:** Итоговый сертификат **обязан** быть сериализован в формат **PEM** (RFC 7468) с заголовком `-----BEGIN CERTIFICATE-----`.                                                                                                                                                                                                                                                                                               | **Must**  |
| **PKI-5** | **Вывод сертификата:** Файл сертификата **обязан** быть сохранён как `ca.cert.pem` внутри подкаталога `certs` в `--out-dir`.                                                                                                                                                                                                                                                                                                                        | **Must**  |

---

## 4. Безопасное хранение ключей и управление выходными данными

Закрытый ключ является корнем доверия; он должен храниться в зашифрованном виде и со строгими правами доступа к файлу.

| ID      | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | Приоритет |
|---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **KEY-1** | **Шифрование закрытого ключа:** Закрытый ключ **обязан** быть зашифрован с помощью парольной фразы, полученной из `--passphrase-file`.<br> • **Для Python (cryptography):** Использовать `serialization.BestAvailableEncryption(passphrase)`, который генерирует зашифрованный закрытый ключ в формате PKCS#8 (AES‑256‑CBC + PBKDF2).<br> • **Для Go:** Использовать `x509.EncryptPEMBlock` с алгоритмом `x509.PEMCipherAES256` (создаёт зашифрованный PEM-блок, совместимый с OpenSSL). **Примечание:** `EncryptPEMBlock` является устаревшим (deprecated), но по-прежнему допустим для данного задания; в качестве альтернативы можно использовать стороннюю реализацию PKCS#8 (например, `github.com/youmark/pkcs8`). Итоговый PEM-блок **обязан** иметь тип `ENCRYPTED PRIVATE KEY` (PKCS#8) или `RSA PRIVATE KEY` (зашифрованный, устаревший формат). | **Must**  |
| **KEY-2** | **Вывод файла ключа:** Зашифрованный закрытый ключ **обязан** быть сохранён как `ca.key.pem` внутри подкаталога `private` в `--out-dir`.                                                                                                                                                                                                                                                                                                                                                                                                                                          | **Must**  |
| **KEY-3** | **Права доступа к файлам:**<br> • Каталог `private` **рекомендуется** создавать с правами `0o700` (в Unix-подобных системах).<br> • Файл `ca.key.pem` **обязан** создаваться с правами `0o600` (только чтение/запись для владельца).<br> Если операционная система не поддерживает такие режимы доступа (например, Windows), инструмент **должен** по крайней мере выдать предупреждение.                                                                                                                                                                                           | **Must**  |
| **KEY-4** | **Структура каталогов:** Инструмент **обязан** создать следующую иерархию каталогов внутри `--out-dir` (если они ещё не существуют):                                                                                                                                                                                                                                                                                                                                                                                                                                             | **Must**  |

```
<out-dir>/
├── private/          # зашифрованные закрытые ключи
├── certs/            # выпущенные сертификаты (PEM)
└── policy.txt        # документ политики сертификации (см. Раздел 5)
```

---

## 5. Политика и журналирование

Даже минимальная PKI должна определять свои политики и вести журнал аудита.

| ID      | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                    | Приоритет |
|---------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **POL-1** | **Документ политики сертификации:** После успешной инициализации УЦ в корне `--out-dir` **обязан** быть размещён текстовый файл `policy.txt`. Файл **обязан** содержать следующую информацию (в читаемом виде):<br> • Имя УЦ (субъект DN)<br> • Серийный номер сертификата (в шестнадцатеричном виде)<br> • Период действия (NotBefore / NotAfter)<br> • Алгоритм и размер ключа (например, RSA‑4096, ECC‑P384)<br> • Краткое описание назначения УЦ (например, «Корневой УЦ для демонстрации MicroPKI»).<br> • Версия политики (например, «1.0») и дата создания.                     | **Must**  |
| **LOG-1** | **Инфраструктура логирования:** Инструмент **обязан** реализовать механизм логирования, который учитывает аргумент `--log-file`.<br> • Если `--log-file` указан, все записи журнала **обязаны** дописываться в этот файл.<br> • Если не указан, журнал **обязан** выводиться в stderr.<br> • Каждая запись журнала **обязана** включать временную метку (ISO 8601 с миллисекундами), уровень логирования (`INFO`, `WARNING`, `ERROR`) и описательное сообщение. | **Must**  |
| **LOG-2** | **Обязательные события логирования:** Следующие события **обязаны** логироваться с уровнем `INFO`:<br> • Начало и успешное завершение генерации ключа.<br> • Начало и успешное завершение подписания сертификата.<br> • Сохранение `ca.key.pem` и `ca.cert.pem` (с полными путями).<br> • Генерация `policy.txt`.<br> • Любые ошибки или предупреждения валидации **обязаны** логироваться с уровнем `ERROR` или `WARNING` соответственно.                 | **Must**  |
| **LOG-3** | **Сокрытие конфиденциальных данных:** Парольная фраза **ни в коем случае не должна** появляться в журналах, даже частично. Любые сообщения об ошибках, касающиеся файла с парольной фразой, **обязаны** избегать повторения самой фразы.                                                                                                                                                                                                              | **Must**  |

---

## 6. Тестирование и проверка

Готовое решение должно быть демонстрационно корректным и устойчивым.

| ID       | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | Приоритет |
|----------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **TEST-1** | **Тест самосогласованности:** Сгенерированный сертификат **обязан** быть проверяемым с использованием самого сертификата как доверенного корня.<br> • Инструмент **рекомендуется** предоставить команду (например, `micropki ca verify --cert <путь>`) для выполнения такой проверки. В качестве альтернативы студент **обязан** задокументировать чёткую процедуру с использованием OpenSSL:<br>   `openssl x509 -in ca.cert.pem -text -noout` (проверка расширений)<br>   `openssl verify -CAfile ca.cert.pem ca.cert.pem` (должен вернуть `OK`). | **Must**  |
| **TEST-2** | **Соответствие закрытого ключа и сертификата:** **Необходимо** продемонстрировать, что закрытый ключ соответствует открытому ключу из сертификата.<br> • Пример: создать тестовую подпись с помощью закрытого ключа и проверить её с использованием открытого ключа из сертификата. Тестовый скрипт **рекомендуется** включить в репозиторий.                                                                                                                                                                                                 | **Must**  |
| **TEST-3** | **Загрузка зашифрованного ключа:** Студент **обязан** продемонстрировать, что зашифрованный закрытый ключ может быть успешно расшифрован с правильной парольной фразой и загружен в память для операций подписи.                                                                                                                                                                                                                                                                  | **Must**  |
| **TEST-4** | **Негативные/граничные сценарии:** Набор тестов (или документированные ручные тесты) **обязан** включать как минимум следующие сценарии, каждый из которых ожидает информативное сообщение об ошибке и ненулевой код возврата:<br> • Отсутствует `--subject`<br> • Некорректный синтаксис DN<br> • `--key-type ecc` с `--key-size 256` (не поддерживается)<br> • Несуществующий `--passphrase-file`<br> • Каталог `--out-dir` недоступен для записи<br> • Конфликтующие аргументы (если применимо).                                                      | **Should**|
| **TEST-5** | **Тесты в репозитории:** Проект **обязан** включать автоматизированные тесты (например, `pytest`, `go test`), которые проверяют ключевые функции изолированно (генерация ключей, разбор DN, сериализация PEM, логирование) – как минимум два модульных теста.                                                                                                                                                                                                                    | **Should**|
| **TEST-6** | **Совместимость с OpenSSL:** Сгенерированный сертификат **рекомендуется** сравнить с сертификатом, созданным OpenSSL для тех же параметров субъекта и ключа, чтобы убедиться в соответствии. Это не является обязательным условием сдачи/несдачи, но настоятельно рекомендуется.                                                                                                                                                                                                  | **Could** |

---

## 7. Сводка обязательного технического стека

| Компонент             | Требование                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|-----------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Языки**             | • **Python** (≥ 3.8) **или** **Go** (≥ 1.18).<br> • Весь Спринт 1 **обязан** быть реализован на одном языке; смешивать запрещено.                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Криптобиблиотека**  | • **Python:** `cryptography` (версия ≥ 3.0).<br> • **Go:** Стандартные пакеты: `crypto/rsa`, `crypto/ecdsa`, `crypto/elliptic`, `crypto/x509`, `crypto/rand`, `encoding/pem`, `encoding/asn1`. Для зашифрованных закрытых ключей – `x509.EncryptPEMBlock` (устаревший, но допустим) **или** широко известная сторонняя библиотека для PKCS#8 (например, `github.com/youmark/pkcs8`).<br> • **Категорически запрещено:** Самостоятельная реализация AES, RSA, ECDSA или SHA с нуля.                                                                                                                                                  |
| **Хранение ключей**   | • Зашифрованный закрытый ключ в формате **PEM**.<br> • **Python:** `BestAvailableEncryption(passphrase)` → зашифрованный ключ PKCS#8.<br> • **Go:** `x509.EncryptPEMBlock(rand.Reader, "RSA PRIVATE KEY", … , passphrase, x509.PEMCipherAES256)` для RSA; для ECC аналогично, используя блок `"EC PRIVATE KEY"` с шифрованием. (Альтернативы на основе PKCS#8 также допустимы.)                                                                                                                                                                                             |
| **Сертификат**        | • X.509 v3, самоподписанный, с **критическими** расширениями BasicConstraints (CA=TRUE) и KeyUsage (keyCertSign, cRLSign).<br> • SKI/AKI **обязаны** присутствовать.<br> • Серийный номер: генерируется CSPRNG, минимум 20 бит энтропии.<br> • Алгоритмы подписи:<br>   - Ключи RSA → SHA‑256<br>   - Ключи ECC P‑384 → SHA‑384 (ECDSA).                                                                                                                                                                                                                                    |
| **CLI-фреймворк**     | • **Python:** `argparse` (из стандартной библиотеки) **обязателен**.<br> • **Go:** `flag` (стандартный) **или** популярный пакет типа `spf13/cobra` (рекомендуется для поддержки подкоманд).                                                                                                                                                                                                                                                                                                                      |
| **Логирование**       | • **Python:** `logging` (стандартная библиотека).<br> • **Go:** `log` (стандартный) **или** любой пакет для структурированного логирования (например, `logrus`).<br> • Формат вывода: обычный текст с временной меткой, уровнем и сообщением.                                                                                                                                                                                                                                                                   |
| **Файл политики**     | • Обычный текст (UTF‑8), имя файла `policy.txt`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |

---

**Конец требований Спринта 1**
*Все требования могут быть уточнены. В случае сомнений отдавайте предпочтение корректности и безопасности, а не излишней функциональности.*
