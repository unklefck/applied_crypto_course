# **Проект: MicroPKI – Технические требования (Спринт 4)**

**Цель спринта:** Реализовать полноценную систему списков отозванных сертификатов (CRL) – генерацию, процедуру отзыва и распространение через HTTP, обеспечивающую проверку статуса сертификатов.

---

## 1. Структура проекта и гигиена репозитория

Кодовая база теперь должна включать модули генерации и управления CRL, а также расширения для сервера репозитория.

| ID      | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                          | Приоритет |
|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **STR-13** | Репозиторий **обязан** сохранять структуру, заложенную в Спринтах 1–3. Новые модули **обязаны** быть добавлены для работы с CRL: <br> • **Python:** `crl.py`, `revocation.py`.<br> • **Go:** `internal/crl/`, `internal/revocation/`.                                                                                                                                                                                                          | **Must**  |
| **STR-14** | Файл `README.md` **обязан** быть обновлён, включая:<br> • Инструкции по отзыву сертификата (подкоманда `revoke`).<br> • Как генерировать и обслуживать CRL.<br> • Примеры команд `curl` для получения CRL из репозитория.<br> • Проверку отозванных сертификатов с помощью OpenSSL или встроенных средств.                                                                                                                                      | **Must**  |
| **STR-15** | Структура каталогов в `--out-dir` **обязана** быть расширена добавлением подкаталога `crl` для хранения сгенерированных файлов CRL (как корневого, так и промежуточного УЦ).                                                                                                                                                                                                                                                                 | **Must**  |

```
<out-dir>/
├── private/
├── certs/
├── csrs/                       (опционально)
├── crl/                        # НОВОЕ – для файлов CRL
│   ├── root.crl.pem
│   └── intermediate.crl.pem
├── micropki.db                (база данных)
└── policy.txt
```

---

## 2. Парсер командной строки (CLI)

Интерфейс командной строки должен поддерживать отзыв сертификатов и ручную генерацию CRL.

| ID       | Описание требования                                                                                                                                                                                                                                                                                                                                                          | Приоритет |
|----------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **CLI-18** | Инструмент **обязан** предоставлять подкоманду `ca revoke <serial>` для отзыва ранее выпущенного сертификата. <br> • `serial` – серийный номер сертификата в шестнадцатеричном формате (регистронезависимо).<br> • **Необязательный флаг:** `--reason` – код причины отзыва (по умолчанию: `unspecified`). Поддерживаемые причины **обязаны** включать: `keyCompromise`, `cACompromise`, `affiliationChanged`, `superseded`, `cessationOfOperation`, `certificateHold`, `removeFromCRL`, `privilegeWithdrawn`, `aACompromise`. <br> • **Необязательный флаг:** `--crl` – путь к файлу CRL для обновления (по умолчанию автоматический выбор на основании издателя).<br> • **Необязательный флаг:** `--force` – пропустить запросы подтверждения. | **Must**  |
| **CLI-19** | Инструмент **обязан** предоставлять подкоманду `ca gen-crl` для ручной (повторной) генерации CRL указанного УЦ. <br> • **Обязательный аргумент:** `--ca` – либо `root`, либо `intermediate` (или путь к сертификату УЦ).<br> • **Необязательный флаг:** `--next-update` – количество дней до следующего обновления CRL (по умолчанию: `7`).<br> • **Необязательный флаг:** `--out-file` – путь к выходному файлу; если не указан, используется расположение по умолчанию (`<out-dir>/crl/<ca>.crl.pem`). <br> • Данная команда **обязана** выполнить запрос к базе данных для получения всех отозванных сертификатов, выпущенных этим УЦ, построить CRL, подписать его закрытым ключом УЦ и записать на диск. | **Must**  |
| **CLI-20** | Инструменту **рекомендуется** предоставлять подкоманду `ca check-revoked <serial>` для быстрой проверки статуса отзыва сертификата по последнему CRL или прямому запросу к базе данных.                                                                                                                                                                                        | **Could** |
| **CLI-21** | Существующие команды `ca issue-cert` и `ca issue-intermediate` **обязаны** остаться без изменений. Команда отзыва **обязана** соблюдать схему базы данных и обновлять поля `status` и поля отзыва.                                                                                                                                                                             | **Must**  |

**Примеры вызова:**

```bash
# 1. Отзыв серверного сертификата по причине компрометации ключа
$ micropki ca revoke 2A7F... --reason keyCompromise

# 2. Отзыв сертификата с немедленным вступлением в силу (без подтверждения)
$ micropki ca revoke 3B8E... --reason superseded --force

# 3. Ручная регенерация CRL промежуточного УЦ
$ micropki ca gen-crl --ca intermediate --next-update 14

# 4. Генерация CRL корневого УЦ и сохранение в пользовательское расположение
$ micropki ca gen-crl --ca root --out-file ./backup/root.crl.pem
```

---

## 3. Базовая реализация PKI (Генерация CRL)

Все операции с CRL должны использовать стандартные библиотеки и соответствовать RFC 5280.

| ID      | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                      | Приоритет |
|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **CRL-1** | **Формат CRLv2:** Сгенерированный CRL **обязан** быть версии 2 (X.509 CRL) и содержать следующие поля:<br> • Версия = 1 (v2).<br> • Алгоритм подписи: тот же, что и в сертификате подписывающего УЦ (например, `sha256WithRSAEncryption` или `ecdsa-with-SHA384`).<br> • Издатель: DN УЦ, выпускающего CRL.<br> • `thisUpdate`: текущее UTC-время.<br> • `nextUpdate`: `thisUpdate` + `--next-update` дней.<br> • Список отозванных сертификатов: каждая запись **обязана** содержать серийный номер сертификата (ASN.1 INTEGER) и дату отзыва.<br> • **Опционально:** причина отзыва (код причины CRL) **обязана** быть включена как расширение записи CRL, если она была указана. | **Must**  |
| **CRL-2** | **Расширения CRL:** В CRL **рекомендуется** включать следующие расширения уровня CRL (v2):<br> • **Authority Key Identifier (AKI):** соответствует расширению AKI из сертификата УЦ.<br> • **Номер CRL (CRL Number):** монотонно возрастающее целое число (хранится в базе данных или файле).<br> • **Код причины отзыва (CRL Reason Code):** расширение записи – согласно RFC 5280, включается для каждого отозванного сертификата, если была указана причина.                                                                                                                                | **Should**|
| **CRL-3** | **Интеграция с БД при отзыве:** Команда `ca revoke` **обязана**:<br> • Найти сертификат по серийному номеру в базе данных.<br> • Обновить его `status` на `'revoked'`.<br> • Установить `revocation_date` в текущее UTC-время.<br> • Установить `revocation_reason` в указанную причину (строка, например, `'keyCompromise'`).<br> • **Обязана** проверить, что сертификат ещё не отозван; если уже отозван, вывести предупреждение и ничего не делать (код возврата 0).                                                                                                                       | **Must**  |
| **CRL-4** | **Подпись CRL:** CRL **обязан** быть подписан цифровой подписью с использованием закрытого ключа УЦ. Алгоритм подписи **обязан** соответствовать алгоритму, использованному в сертификате УЦ. CRL **обязан** быть закодирован в DER, а затем обёрнут в PEM (`-----BEGIN X509 CRL-----`).                                                                                                                                                                        | **Must**  |
| **CRL-5** | **Хранение CRL:** Сгенерированные CRL **обязаны** сохраняться в подкаталоге `crl` с именем по шаблону `<имя_УЦ>.crl.pem` (например, `root.crl.pem`, `intermediate.crl.pem`).                                                                                                                                                                                                                                                                               | **Must**  |
| **CRL-6** | **Сохранение номера CRL:** Номер CRL (монотонно возрастающее целое число) **обязан** сохраняться и восстанавливаться при последующих вызовах. **Рекомендуемые подходы:**<br> • Хранить в небольшом текстовом файле `crl_number.txt` внутри каталога `crl`.<br> • Хранить в базе данных в отдельной таблице `metadata`.<br> • Увеличивать на единицу при каждой новой генерации CRL для одного и того же УЦ.                                                                                                                                 | **Should**|
| **CRL-7** | **Коды причин отзыва:** Инструмент **обязан** поддерживать следующие коды причин (с отображением на соответствующие перечисления ASN.1):<br> • `unspecified` (0)<br> • `keyCompromise` (1)<br> • `cACompromise` (2)<br> • `affiliationChanged` (3)<br> • `superseded` (4)<br> • `cessationOfOperation` (5)<br> • `certificateHold` (6)<br> • `removeFromCRL` (8)<br> • `privilegeWithdrawn` (9)<br> • `aACompromise` (10)<br> Если указана неподдерживаемая причина, инструмент **обязан** завершиться с ошибкой.                                                                               | **Must**  |
| **CRL-8** | **Delta-CRL:** Для Спринта 4 не требуется. Полного CRL (полный список) достаточно.                                                                                                                                                                                                                                                                                                                                                                         | **N/A**   |

---

## 4. Распространение CRL (расширения репозитория)

HTTP-сервер репозитория должен предоставлять CRL с корректным Content-Type и заголовками кэширования.

| ID       | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                      | Приоритет |
|----------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **REPO-9** | **Эндпоинт: GET /crl** <br> • **Обязан** быть обновлён (ранее заглушка в Спринте 3) и возвращать текущий CRL **УЦ по умолчанию** (например, промежуточного УЦ). <br> • **Рекомендуется** поддерживать необязательный параметр запроса `?ca=root` или `?ca=intermediate` для указания, какой CRL необходимо получить. <br> • **Обязан** возвращать `Content-Type: application/pkix-crl` (стандартный MIME-тип для CRL). <br> • Если запрошенный файл CRL не существует, возвращать `404 Not Found`.                                                                                              | **Must**  |
| **REPO-10**| **Эндпоинт: GET /crl/<ca>.crl** (альтернативный путь) <br> • Для REST-удобства сервер **может** также отдавать `/crl/root.crl` и `/crl/intermediate.crl` как статические файлы. Это опционально, если реализован подход с `/crl?ca=`.                                                                                                                                                                                                                     | **Could** |
| **REPO-11**| **Заголовки кэширования:** Серверу **рекомендуется** включать соответствующие HTTP-заголовки кэширования: <br> • `Last-Modified`: на основе времени модификации файла.<br> • `Cache-Control: max-age=<секунды>` – вычисляется из поля `nextUpdate`.<br> • `ETag`: хеш файла или версия.                                                                                                                                                                  | **Should**|
| **REPO-12**| **Логирование:** Запросы к CRL **обязаны** логироваться аналогично другим HTTP-запросам (временная метка, метод, путь, статус).                                                                                                                                                                                                                                                                                                                          | **Must**  |

**Примеры взаимодействия с API:**

```bash
# Получить CRL по умолчанию (промежуточного УЦ)
$ curl -H "Accept: application/pkix-crl" http://localhost:8080/crl

# Получить CRL корневого УЦ
$ curl http://localhost:8080/crl?ca=root

# Альтернативный стиль пути
$ curl http://localhost:8080/crl/root.crl

# Проверить с помощью OpenSSL
$ openssl crl -inform PEM -in root.crl.pem -text -noout
```

---

## 5. Обновления базы данных и схемы

Существующая схема базы данных должна быть расширена для поддержки метаданных CRL и отслеживания отзыва.

| ID      | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                      | Приоритет |
|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **DB-5** | **Миграция схемы – таблица certificates:** Таблица `certificates` из Спринта 3 уже содержит поля `status`, `revocation_reason`, `revocation_date`. Структурных изменений не требуется, но инструмент **обязан** теперь записывать данные в эти поля при отзыве.                                                                                                                                                                                             | **Must**  |
| **DB-6** | **Новая таблица: crl_metadata** (рекомендуется) <br> Для сохранения номеров CRL и отслеживания nextUpdate **рекомендуется** создать новую таблицу:                                                                                                                                                                                                                                                                                                        | **Should**|

```sql
CREATE TABLE crl_metadata (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ca_subject TEXT NOT NULL,           -- DN выпускающего УЦ
    crl_number INTEGER NOT NULL,        -- текущий номер CRL
    last_generated TEXT NOT NULL,       -- ISO 8601
    next_update TEXT NOT NULL,          -- ISO 8601
    crl_path TEXT NOT NULL             -- путь к файлу относительно out-dir
);

CREATE UNIQUE INDEX idx_ca_subject ON crl_metadata(ca_subject);
```

| ID      | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                      | Приоритет |
|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **DB-7** | **Обработка миграции:** Команда `db init` **обязана** создавать новые таблицы, если они отсутствуют. Существующие базы данных из Спринта 3 **рекомендуется** обновлять с помощью простой миграции (например, проверка версии схемы). Это **настоятельно рекомендуется**, но не является обязательным; студенты могут задокументировать, что требуется повторная инициализация `db init`.                                                                 | **Should**|

---

## 6. Логирование и аудит

Операции отзыва и генерации CRL являются критическими с точки зрения безопасности; логирование должно быть всеобъемлющим.

| ID      | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                      | Приоритет |
|---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **LOG-9** | **Обязательные события логирования (отзыв):**<br> • Успешный отзыв – залогировать серийный номер, причину и временную метку.<br> • Попытка отзыва уже отозванного сертификата – залогировать предупреждение.<br> • Ошибка отзыва (например, серийный номер не найден) – залогировать ошибку.                                                                                                                                              | **Must**  |
| **LOG-10**| **Обязательные события логирования (генерация CRL):**<br> • Начало и успешное завершение генерации CRL (имя УЦ, количество отозванных сертификатов, thisUpdate, nextUpdate, номер CRL).<br> • Ошибка генерации CRL (например, отсутствует ключ УЦ, ошибка БД) – залогировать ошибку.                                                                                                                                                    | **Must**  |
| **LOG-11**| **Целостность аудиторского следа:** Все журналы, связанные с отзывом и CRL, **рекомендуется** записывать в тот же аудиторский выход, что и в предыдущих спринтах, желательно в структурированном формате (JSON) для последующих мер по обеспечению целостности (Спринт 7).                                                                                                                                                               | **Should**|

---

## 7. Тестирование и проверка

Реализация должна быть проверена с помощью стандартных инструментов и демонстрировать полный жизненный цикл отзыва.

| ID       | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Приоритет |
|----------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **TEST-21** | **Тест жизненного цикла отзыва:** Выполнить следующую последовательность (автоматизированно или документированно):<br> 1. Выпустить серверный сертификат (серийный номер A).<br> 2. Убедиться, что его статус в БД – `valid`.<br> 3. Отозвать сертификат с причиной `keyCompromise`.<br> 4. Убедиться, что статус в БД изменился на `revoked`, а дата и причина отзыва установлены.<br> 5. Сгенерировать новый CRL для промежуточного УЦ.<br> 6. Убедиться, что CRL содержит серийный номер A с корректной датой отзыва и кодом причины.<br> 7. Получить CRL через HTTP и проверить с помощью OpenSSL. | **Must**  |
| **TEST-22** | **Проверка подписи CRL:** С помощью OpenSSL убедиться, что CRL корректно подписан выпустившим УЦ:<br> `openssl crl -in intermediate.crl.pem -inform PEM -CAfile intermediate.cert.pem -noout` (должно вывести «verify OK»).                                                                                                                                                                                                                                                                                                      | **Must**  |
| **TEST-23** | **Тест увеличения номера CRL:** Сгенерировать два CRL подряд без добавления новых отозванных сертификатов. Номер CRL **обязан** увеличиться. Проверить через `openssl crl -text`.                                                                                                                                                                                                                                                                                                                                               | **Should**|
| **TEST-24** | **Негативный тест – отзыв несуществующего сертификата:** Выполнить `ca revoke` с серийным номером, которого нет в БД. Инструмент **обязан** вывести сообщение об ошибке и завершиться с ненулевым кодом.                                                                                                                                                                                                                                                                                                                         | **Should**|
| **TEST-25** | **Негативный тест – отзыв уже отозванного сертификата:** Попытаться отозвать сертификат, который уже отозван. Инструмент **должен** вывести предупреждение и завершиться успешно (0). Изменений в БД происходить не должно.                                                                                                                                                                                                                                                                                                      | **Should**|
| **TEST-26** | **Тест распространения CRL:** Запустить сервер репозитория, отозвать сертификат, перегенерировать CRL, затем получить его по HTTP. Сравнить полученный CRL с локальным файлом (должны быть идентичны).                                                                                                                                                                                                                                                                                                                           | **Must**  |
| **TEST-27** | **Тест совместимости – OpenSSL s_client:** Продемонстрировать, что отозванный сертификат при предъявлении в TLS-рукопожатии отклоняется, если клиент выполняет проверку CRL. Для этого может потребоваться настройка HTTP-сервера (nginx, Python) и использование `openssl s_client -crl_check -CAfile chain.pem`. Этот тест **рекомендуется**, но не обязателен для Спринта 4.                                                                                                                                                     | **Could** |

---

## 8. Сводка обязательного технического стека (дополнения для Спринта 4)

| Компонент             | Требование (дополнения для Спринта 4)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|-----------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Генерация CRL**     | • **Python:** `cryptography.x509.CertificateRevocationListBuilder`, `cryptography.x509.RevokedCertificateBuilder`.<br> • **Go:** `crypto/x509.CreateRevocationList`, `x509.RevocationList`, `x509.RevokedCertificate`.<br> • **Запрещено ручное кодирование ASN.1.**                                                                                                                                                                                                                                                                                                                           |
| **Причины отзыва**    | • Необходимо поддерживать все 10 кодов причин по RFC 5280 (0,1,2,3,4,5,6,8,9,10).<br> • Отображать строки CLI в соответствующие значения перечислений ASN.1.                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Хранение CRL**      | • Формат PEM с заголовком `-----BEGIN X509 CRL-----`.<br> • Сохранять в подкаталоге `crl/` внутри `--out-dir`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Эндпоинт CRL**      | • `GET /crl` – возвращает текущий CRL (предпочтительно промежуточного УЦ).<br> • Content‑Type: `application/pkix-crl`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **База данных**       | • **Рекомендуется** реализовать новую таблицу `crl_metadata`.<br> • Существующая таблица `certificates` используется для хранения статуса отзыва.                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **CLI**               | • Добавлены подкоманды `revoke` и `gen-crl` в группу `ca`.<br> • Коды причин передаются строковыми аргументами, регистронезависимо.                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Логирование**       | • Новые библиотеки не требуются; расширить существующий логгер.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Тестирование**      | • Дополнительные модульные тесты для построителя CRL, отображения кодов причин и обновлений БД.<br> • Ручная или автоматизированная проверка CRL с помощью OpenSSL.                                                                                                                                                                                                                                                                                                                                                                                                                         |

---

**Конец требований Спринта 4**
*Все требования могут быть уточнены. В случае сомнений отдавайте предпочтение корректной структуре ASN.1 и действительности подписи, а не расширенным функциям CRL (например, delta CRL, косвенные CRL).*
