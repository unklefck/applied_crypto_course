# **Проект: MicroPKI – Технические требования (Спринт 5)**

**Цель спринта:** Реализовать базовый OCSP-ответчик (Online Certificate Status Protocol), предоставляющий информацию о статусе сертификатов в реальном времени, включая выпуск сертификата для подписи OCSP, обработку запросов и ответов, а также интеграцию с существующим HTTP-сервером репозитория.

---

## 1. Структура проекта и гигиена репозитория

Кодовая база теперь должна включать модули OCSP-ответчика и специализированный сертификат для подписи OCSP.

| ID      | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                          | Приоритет |
|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **STR-16** | Репозиторий **обязан** сохранять структуру, заложенную в Спринтах 1–4. Новые модули **обязаны** быть добавлены для функциональности OCSP: <br> • **Python:** `ocsp.py`, `ocsp_responder.py`.<br> • **Go:** `internal/ocsp/`, `internal/ocsp/responder.go`, `internal/ocsp/signer.go`.                                                                                                                                                         | **Must**  |
| **STR-17** | Файл `README.md` **обязан** быть обновлён, включая:<br> • Инструкции по выпуску сертификата OCSP-ответчика.<br> • Как запустить OCSP-ответчик (как часть сервера репозитория или отдельный сервис).<br> • Примеры клиентских команд `openssl ocsp` для запросов к ответчику.<br> • Пояснение о nonce в OCSP и защите от повторов.                                                                                                                | **Must**  |
| **STR-18** | Структура каталогов в `--out-dir` **рекомендуется** расширить, опционально добавив подкаталог `ocsp` для хранения журналов или кэша OCSP-ответчика (если реализовано).                                                                                                                                                                                                                                                                      | **Should**|

```
<out-dir>/
├── private/
├── certs/
├── crl/
├── ocsp/                         # ОПЦИОНАЛЬНО – для кэша/логов OCSP
├── micropki.db
└── policy.txt
```

---

## 2. Парсер командной строки (CLI)

Интерфейс командной строки должен поддерживать выпуск сертификата OCSP-ответчика и запуск службы OCSP-ответчика.

| ID       | Описание требования                                                                                                                                                                                                                                                                                                                                                          | Приоритет |
|----------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **CLI-22** | Инструмент **обязан** предоставлять подкоманду `ca issue-ocsp-cert` для выпуска специализированного сертификата подписи OCSP от промежуточного УЦ (или опционально напрямую от корневого УЦ). <br> • **Обязательные аргументы:** <br>   - `--ca-cert` – сертификат промежуточного УЦ.<br>   - `--ca-key` – закрытый ключ промежуточного УЦ.<br>   - `--ca-pass-file` – парольная фраза для ключа УЦ.<br>   - `--subject` – отличительное имя (например, `CN=OCSP Responder`).<br>   - `--key-type` / `--key-size` – как и ранее.<br> • **Необязательные аргументы:** <br>   - `--san` – альтернативное имя субъекта (обычно DNS-имя или URI, где размещён ответчик).<br>   - `--out-dir` – выходной каталог (по умолчанию: `./pki/certs`).<br>   - `--validity-days` – по умолчанию `365`. <br> • Сертификат **обязан** включать расширение Extended Key Usage со значением `id-kp-OCSPSigning` (1.3.6.1.5.5.7.3.9). <br> • Сертификат **обязан** иметь `CA=FALSE` и соответствующий Key Usage (`digitalSignature`). <br> • Сертификату **рекомендуется** включать расширение Authority Information Access (AIA), указывающее на сам OCSP-ответчик (опционально). | **Must**  |
| **CLI-23** | Инструмент **обязан** предоставлять подкоманду `ocsp serve` для запуска OCSP-ответчика. <br> • **Аргументы:** <br>   - `--host` – адрес привязки (по умолчанию: `127.0.0.1`). <br>   - `--port` – TCP-порт (по умолчанию: `8081`). <br>   - `--db-path` – путь к базе данных SQLite (по умолчанию: `./pki/micropki.db`). <br>   - `--responder-cert` – сертификат подписи OCSP (PEM). <br>   - `--responder-key` – закрытый ключ подписи OCSP (PEM, без шифрования). <br>   - `--ca-cert` – сертификат выпускающего УЦ (для проверки запросов и поиска сертификатов). <br>   - `--cache-ttl` – время жизни кэша ответов в секундах (по умолчанию: `60`). <br>   - `--log-file` – опциональный файл журнала (по умолчанию: stderr). <br> • Сервер **обязан** работать до прерывания (Ctrl+C). | **Must**  |
| **CLI-24** | Существующая команда `repo serve` **может** быть расширена флагом `--enable-ocsp`, который также запускает OCSP-ответчик на отдельном порту (или на том же порту по пути `/ocsp`). Это **опционально**; отдельной команды `ocsp serve` достаточно.                                                                                                                                   | **Could** |

**Примеры вызова:**

```bash
# 1. Выпуск сертификата OCSP-ответчика, подписанного промежуточным УЦ
$ micropki ca issue-ocsp-cert \
    --ca-cert ./pki/certs/intermediate.cert.pem \
    --ca-key ./pki/private/intermediate.key.pem \
    --ca-pass-file ./secrets/intermediate.pass \
    --subject "CN=OCSP Responder,O=MicroPKI" \
    --key-type rsa \
    --key-size 2048 \
    --san dns:ocsp.example.com \
    --out-dir ./pki/certs \
    --validity-days 365

# 2. Запуск OCSP-ответчика
$ micropki ocsp serve \
    --host 127.0.0.1 \
    --port 8081 \
    --db-path ./pki/micropki.db \
    --responder-cert ./pki/certs/ocsp.cert.pem \
    --responder-key ./pki/certs/ocsp.key.pem \
    --ca-cert ./pki/certs/intermediate.cert.pem \
    --cache-ttl 120 \
    --log-file ./logs/ocsp.log
```

---

## 3. Базовая реализация PKI (OCSP-ответчик)

OCSP-ответчик должен корректно разбирать запросы согласно RFC 6960, обращаться к базе данных и формировать подписанные ответы.

| ID       | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                      | Приоритет |
|----------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **OCSP-1** | **Разбор OCSP-запроса:** Ответчик **обязан** принимать POST-запросы с `Content-Type: application/ocsp-request`, содержащие DER-кодированный OCSP-запрос (ASN.1). Ответчик **обязан** извлечь из запроса следующие поля:<br> • `version` – должно быть `v1` (значение 0).<br> • `requestorName` – опционально, игнорируется.<br> • **Список запросов:** как минимум один `CertID`, содержащий:<br>   - Алгоритм хеша (должен быть SHA‑1 или SHA‑256; **обязана** поддерживаться SHA‑1 для совместимости).<br>   - Хеш имени издателя (hash of issuer's DN).<br>   - Хеш ключа издателя (hash of issuer's public key).<br>   - Серийный номер запрашиваемого сертификата.<br> • **Расширения:** nonce (если присутствует).<br> Ответчик **обязан** отклонять некорректные запросы соответствующим OCSP-ответом (malformedRequest) или HTTP 400. | **Must**  |
| **OCSP-2** | **Формирование OCSP-ответа:** Для каждого запрошенного сертификата ответчик **обязан** сформировать ответ следующей структуры:<br> • `version` – v1 (0).<br> • `responderID` – по имени (субъект сертификата OCSP-ответчика) **или** по хешу ключа (SHA‑1 хеш открытого ключа ответчика). **Обязана** поддерживаться обе формы; **рекомендуется** использование byKey для анонимности.<br> • `producedAt` – текущее UTC-время.<br> • **SingleResponse** для каждого сертификата, содержащий:<br>   - `certID` – тот же, что в запросе.<br>   - `certStatus`: `good`, `revoked` или `unknown`.<br>   - `thisUpdate` – текущее время.<br>   - `nextUpdate` – опционально (рекомендуется: `thisUpdate` + cache TTL).<br>   - `revokedInfo` – если статус revoked, включаются дата отзыва и причина.<br> • **ResponseExtensions:** nonce (если присутствовал в запросе, ОБЯЗАН быть повторён).<br> • **Подпись:** подписывается закрытым ключом OCSP-ответчика с использованием алгоритма, указанного в сертификате ответчика. | **Must**  |
| **OCSP-3** | **Определение статуса:** Ответчик **обязан** выполнять запрос к базе данных для каждого серийного номера:<br> • Если сертификат существует и `status = 'valid'` → `good`.<br> • Если сертификат существует и `status = 'revoked'` → `revoked`, с датой отзыва и причиной из базы.<br> • Если сертификат не существует ИЛИ выпущен другим УЦ (несовпадение издателя) → `unknown`.<br> • **Граничный случай:** просроченные сертификаты для OCSP по-прежнему считаются `good` (они не отозваны). Ответчик **может** вернуть `good` или `unknown`; `good` предпочтительнее. | **Must**  |
| **OCSP-4** | **Обработка nonce:** Ответчик **обязан** извлечь расширение nonce из запроса (если присутствует). Ответчик **обязан** включить точно такое же значение nonce в расширение ответа `OCSPNonce` (OID 1.3.6.1.5.5.7.48.1.2). Это обеспечивает защиту от повторов. Если запрос не содержит nonce, ответчику **рекомендуется** не включать nonce в ответ.                                                                                                       | **Must**  |
| **OCSP-5** | **Кодирование ответа:** OCSP-ответ **обязан** быть DER-кодирован как `BasicOCSPResponse` (согласно RFC 6960), затем обёрнут в структуру `OCSPResponse` с `responseStatus = successful`. Итоговый DER **обязан** передаваться с `Content-Type: application/ocsp-response`.                                                                                                                                                                                | **Must**  |
| **OCSP-6** | **Ответы об ошибках:** Ответчик **обязан** формировать корректные OCSP-ответы об ошибках для:<br> • malformedRequest – запрос не удалось разобрать.<br> • internalError – внутренняя ошибка сервера (БД недоступна и т.п.).<br> • tryLater – опционально, при ограничении частоты запросов.<br> • sigRequired – если требуется аутентификация (не используется).<br> • unauthorized – если ответчик отказывается отвечать за данного издателя/сертификат (например, издатель не распознан).<br> Эти ответы **обязаны** возвращаться как корректные структуры OCSPResponse с HTTP 200 (или в крайнем случае соответствующие 4xx/5xx). | **Should**|
| **OCSP-7** | **Кэширование:** Для повышения производительности ответчику **рекомендуется** кэшировать недавно сформированные ответы в памяти с TTL. Ключ кэша **рекомендуется** формировать как (issuerHash, serialNumber, nonce) или просто (serialNumber), если nonce игнорируется – но учёт nonce при кэшировании нетривиален. Простой подход: кэшировать для каждого серийного номера ответы `good`/`revoked` и использовать только для запросов без nonce. Это **опционально**, но рекомендуется.                                                | **Could** |
| **OCSP-8** | **Логирование:** Каждый OCSP-запрос **обязан** логироваться с уровнем `INFO`, включая: временную метку, IP-адрес клиента, серийный номер(а), статус ответа (good/revoked/unknown) и время обработки (мс). Ошибки **обязаны** логироваться с уровнем `ERROR`.                                                                                                                                                                                               | **Must**  |

---

## 4. Сертификат для подписи OCSP

Сертификат OCSP-ответчика является специализированным конечным сертификатом с определёнными расширениями.

| ID      | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                      | Приоритет |
|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **OSC-1** | **Профиль сертификата подписи OCSP:** Сертификат, выпускаемый командой `ca issue-ocsp-cert`, **обязан** соответствовать следующему профилю:<br> • Версия: v3.<br> • Basic Constraints: `CA=FALSE`, критическое.<br> • Key Usage: `digitalSignature` (критическое). **Не должен** включать `keyCertSign` или `cRLSign`.<br> • Extended Key Usage: **обязан** включать `id-kp-OCSPSigning` (1.3.6.1.5.5.7.3.9). **Не должен** включать `serverAuth`, `clientAuth` и т.п., если только они не требуются дополнительно (не требуется).<br> • Subject Alternative Name: **рекомендуется** содержать DNS-имя или URI, соответствующее адресу ответчика (если известно). Это рекомендуется, но не обязательно.<br> • Authority Information Access (AIA): **может** включать URI OCSP, указывающий на самого ответчика (самоссылка). | **Must**  |
| **OSC-2** | **Требования к размеру ключа:** Пара ключей подписи OCSP **рекомендуется** иметь размер не менее RSA‑2048 или ECC‑P256. Хотя 2048-битного RSA достаточно, инструмент **обязан** разрешать размеры ключей согласно существующему аргументу `--key-size` (RSA ≥ 2048, ECC ≥ 256).                                                                                                                                                                             | **Should**|
| **OSC-3** | **Хранение закрытого ключа:** Закрытый ключ OCSP-ответчика **обязан** храниться **без шифрования** (простой PEM) с правами доступа `0o600`. Это необходимо, чтобы ответчик мог автоматически загрузить ключ при запуске без участия человека. Инструмент **обязан** выдавать явное предупреждение при генерации незашифрованного закрытого ключа для OCSP.                                                                                                    | **Must**  |

---

## 5. Расширения репозитория (опциональная интеграция)

OCSP-ответчик может быть интегрирован с существующим сервером репозитория или работать отдельно.

| ID       | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                      | Приоритет |
|----------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **REPO-13**| **Эндпоинт OCSP на сервере репозитория:** Если студент выбирает интеграцию OCSP в сервер репозитория (вместо отдельной команды `ocsp serve`), сервер **обязан** принимать POST-запросы на `/ocsp`. К этому эндпоинту применяются те же требования OCSP‑1 – OCSP‑8. Такой подход допустим, но **обязан** быть чётко задокументирован.                                                                                                                           | **Could** |
| **REPO-14**| **Расширение AIA в выпускаемых сертификатах:** Существующая команда `issue-cert` **рекомендуется** расширить возможностью опционального включения расширения Authority Information Access (AIA) с URI OCSP. Для этого потребуется новый флаг CLI (например, `--ocsp-url`). Для Спринта 5 это **опционально**.                                                                                                                                             | **Could** |

---

## 6. Интеграция с базой данных

OCSP-ответчик полагается на базу данных статусов сертификатов.

| ID      | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                      | Приоритет |
|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **DB-8** | **Идентификация издателя:** Для проверки соответствия CertID из запроса известному издателю ответчик **обязан** уметь:<br> • Загружать сертификаты УЦ (корневого и промежуточного) из файловой системы или базы данных.<br> • Вычислять хеш имени издателя (SHA‑1) и хеш ключа издателя (SHA‑1 от открытого ключа) для каждого УЦ.<br> • Сопоставлять хеши из запроса с предвычисленными значениями.<br> • Если совпадения нет, возвращать `unauthorized` или `unknown` для данного сертификата.                                                  | **Must**  |
| **DB-9** | **Эффективные запросы:** В базе данных **рекомендуется** иметь индекс по полю `serial_hex` для быстрого поиска. Ответчик **обязан** выдерживать не менее 10 запросов в секунду (целевой показатель, не строгое требование).                                                                                                                                                                                                                              | **Should**|

---

## 7. Логирование и аудит

Операции OCSP должны быть аудитируемы.

| ID      | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                      | Приоритет |
|---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **LOG-12**| **Логирование запросов OCSP:** Как указано в OCSP‑8, каждый запрос **обязан** логироваться с полными деталями. Формат журнала **рекомендуется** делать структурированным (JSON) для удобства анализа.                                                                                                                                                                                                                                    | **Must**  |
| **LOG-13**| **Аудиторский след:** Решения OCSP-ответчика (good/revoked/unknown) **рекомендуется** логировать таким образом, чтобы их можно было сопоставить с записями в базе данных сертификатов. Это важно для неотказуемости.                                                                                                                                                                                                                   | **Should**|

---

## 8. Тестирование и проверка

OCSP-ответчик должен быть протестирован с помощью OpenSSL и демонстрировать корректное отображение статусов.

| ID       | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Приоритет |
|----------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **TEST-28** | **Тест сертификата подписи OCSP:** Проверить, что выпущенный сертификат OCSP-ответчика имеет корректные расширения Extended Key Usage (`OCSPSigning`) и Key Usage (`digitalSignature`). Использовать OpenSSL:<br> `openssl x509 -in ocsp.cert.pem -text -noout` и проверить расширения.                                                                                                                                                                                                                                            | **Must**  |
| **TEST-29** | **Цикл запроса/ответа OCSP – Good-сертификат:** <br> 1. Выпустить серверный сертификат.<br> 2. Отправить запрос к OCSP-ответчику для этого сертификата с помощью `openssl ocsp`.<br> 3. Убедиться, что статус ответа `good` и что ответ корректно подписан сертификатом OCSP-ответчика.<br> 4. Убедиться, что nonce повторяется (если был предоставлен).                                                                                                                                                                            | **Must**  |
| **TEST-30** | **OCSP-запрос/ответ – отозванный сертификат:** <br> 1. Отозвать ранее выпущенный сертификат.<br> 2. Отправить запрос к OCSP-ответчику для этого сертификата.<br> 3. Убедиться, что статус ответа `revoked` и что дата отзыва и причина включены в ответ.                                                                                                                                                                                                                                                                           | **Must**  |
| **TEST-31** | **OCSP-запрос/ответ – неизвестный сертификат:** <br> 1. Отправить запрос к OCSP-ответчику для несуществующего серийного номера (или сертификата, выпущенного другим УЦ).<br> 2. Убедиться, что статус ответа `unknown`.                                                                                                                                                                                                                                                                                                           | **Must**  |
| **TEST-32** | **Тест nonce в OCSP:** <br> 1. Отправить OCSP-запрос с nonce.<br> 2. Убедиться, что ответ содержит точно такой же nonce.<br> 3. Отправить OCSP-запрос без nonce; убедиться, что ответ не включает расширение nonce.                                                                                                                                                                                                                                                                                                                | **Must**  |
| **TEST-33** | **Проверка подписи OCSP-ответчика:** <br> Используя сертификат OCSP-ответчика и сертификат выпускающего УЦ, проверить подпись OCSP-ответа с помощью OpenSSL:<br> `openssl ocsp -respin response.der -CAfile intermediate.cert.pem -verify_other ocsp.cert.pem` (или аналогично).                                                                                                                                                                                                                                                   | **Should**|
| **TEST-34** | **Негативный тест – некорректный запрос:** <br> Отправить невалидный OCSP-запрос (например, мусорные данные, отсутствие Content-Type). Ответчик **обязан** вернуть соответствующий HTTP-статус (400) или корректный OCSP-ответ об ошибке (`malformedRequest`).                                                                                                                                                                                                                                                                  | **Should**|
| **TEST-35** | **Негативный тест – неавторизованный издатель:** <br> Отправить запрос для сертификата, подписанного неизвестным УЦ (т.е. хеши издателя не совпадают с настроенным УЦ). Ответчику **рекомендуется** вернуть `unauthorized` или считать статус `unknown`.                                                                                                                                                                                                                                                                         | **Should**|
| **TEST-36** | **Тест производительности / нагрузочный тест:** <br> Написать скрипт, отправляющий 100 конкурентных OCSP-запросов для валидных сертификатов. Измерить время отклика. Этот тест **опционален**, но приветствуется.                                                                                                                                                                                                                                                                                                                  | **Could** |
| **TEST-37** | **Интеграционный тест – полный PKI-сценарий с OCSP:** <br> Продемонстрировать полный сценарий: корневой УЦ → промежуточный УЦ → выпуск серверного сертификата → выпуск сертификата OCSP-ответчика → запуск OCSP-ответчика → запрос статуса (good) → отзыв сертификата → запрос статуса (revoked). **Рекомендуется** автоматизировать этот процесс в тестовом скрипте.                                                                                                                                                         | **Should**|

---

## 9. Сводка обязательного технического стека (дополнения для Спринта 5)

| Компонент             | Требование (дополнения для Спринта 5)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|-----------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Библиотека OCSP**   | • **Python:** `cryptography.x509.ocsp` – предоставляет `OCSPRequestBuilder`, `OCSPResponseBuilder`, `OCSPNonce`, `OCSPSigningKeyUsage` и др.<br> • **Go:** Стандартный пакет `crypto/ocsp` (для разбора OCSP-запросов/ответов) и `crypto/x509` для построения расширений.                                                                                                                                                                                                                                                                                                                    |
| **Сертификат подписи OCSP** | • **Extended Key Usage:** `id-kp-OCSPSigning` (1.3.6.1.5.5.7.3.9).<br> • **Key Usage:** только `digitalSignature`.<br> • **Закрытый ключ:** хранится без шифрования (PEM) с правами `0o600`.                                                                                                                                                                                                                                                                                                                                                                                                  |
| **HTTP-транспорт**    | • OCSP-запросы **обязаны** приниматься через HTTP POST (путь `/ocsp` при интеграции, иначе отдельный сервер).<br> • Content‑Type: `application/ocsp-request` (запрос), `application/ocsp-response` (ответ).<br> • **Python:** `Flask`/`FastAPI` или встроенный `http.server`.<br> • **Go:** `net/http`.                                                                                                                                                                                                                                                                                     |
| **Обработка nonce**   | • ОБЯЗАН отражать nonce, если он присутствует; НЕ ДОЛЖЕН добавлять nonce, если его нет.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **База данных**       | • Та же SQLite; рекомендуется индекс на `serial_hex`.<br> • Новые обязательные таблицы не требуются.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **CLI**               | • `ca issue-ocsp-cert` – выпуск сертификата OCSP-ответчика.<br> • `ocsp serve` – запуск ответчика (отдельная команда).                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Логирование**       | • Расширить существующий логгер; **рекомендуется** структурированный JSON для журналов доступа OCSP.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Тестирование**      | • Использование команды OpenSSL `ocsp` в качестве эталонного клиента.<br> • Необходимо продемонстрировать ответы good/revoked/unknown.                                                                                                                                                                                                                                                                                                                                                                                                                                                        |

---

**Конец требований Спринта 5**
*Все требования могут быть уточнены. В случае сомнений отдавайте предпочтение корректной обработке OCSP-запросов/ответов и формированию подписи, а не расширенным функциям (кэширование, AIA-расширения, высокая производительность).*
