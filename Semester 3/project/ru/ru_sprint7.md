# **Проект: MicroPKI - Документ с техническими требованиями (Спринт 7)**

**Цель спринта:** Усилить защиту PKI от эксплуатационных угроз за счёт внедрения комплексного аудита с криптографической целостностью, средств защиты (ограничение скорости запросов, симуляция Certificate Transparency, выявление компрометации ключей) и принудительного применения политик (размеры ключей, сроки действия, ограничения на SAN). Все нарушения политик должны блокироваться и фиксироваться в аудите.

---

## 1. Структура проекта и состояние репозитория

В кодовую базу необходимо добавить модули аудита, перехватчики проверки политик и вспомогательные инструменты.

| ID       | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                   | Приоритет |
|----------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **STR‑22** | В репозитории **обязательно** сохранить структуру, принятую в спринтах 1–6. Новые модули **обязательно** добавить для аудита и средств защиты: <br> • **Python:** `audit.py`, `policy.py`, `ratelimit.py`, `transparency.py`, `compromise.py`.<br> • **Go:** `internal/audit/`, `internal/policy/`, `internal/ratelimit/`, `internal/transparency/`, `internal/compromise/`.                                                                               | **Must**  |
| **STR‑23** | В `README.md` **обязательно** обновить разделы:<br> • Описание системы аудита и способа проверки целостности журнала.<br> • Параметры настройки ограничения скорости, правил политик и симуляции компрометации.<br> • Инструкции по использованию инструмента запросов к журналу аудита.<br> • Пояснение о симуляции журнала Certificate Transparency (CT).                                                                                                    | **Must**  |
| **STR‑24** | **Рекомендуется** ввести новый формат конфигурационного файла (например, `micropki.yaml` или `config.toml`) для управления политиками безопасности, лимитами скорости, настройками аудита и расположением CT‑журнала. Если файл конфигурации реализован, CLI **обязан** принимать флаг `--config`.                                                                                                                                                         | **Should** |
| **STR‑25** | Все операции, критичные для безопасности (выпуск, отзыв, генерация ключей, обход политик), **обязаны** регистрироваться в системе аудита **до** выполнения и **после** завершения (с указанием исхода).                                                                                                                                                                                                                                                | **Must**  |

---

## 2. Парсер командной строки (CLI)

CLI должен предоставлять команды для управления журналами аудита, их запросов и имитации компрометации.

| ID        | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                           | Приоритет |
|-----------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **CLI‑31** | Инструмент **обязан** предоставлять подкоманду `audit query` для поиска и отображения записей аудита с возможностью фильтрации. <br> • **Аргументы:** <br>   - `--from` – начальная метка времени (ISO 8601).<br>   - `--to` – конечная метка времени.<br>   - `--level` – уровень журнала (INFO, WARNING, ERROR, AUDIT).<br>   - `--operation` – фильтр по типу операции (например, `issue`, `revoke`, `ca_init`).<br>   - `--serial` – фильтр по серийному номеру сертификата.<br>   - `--format` – формат вывода: `table` (по умолч.), `json`, `csv`.<br>   - `--verify` – проверить целостность хеш‑цепочки полученных записей (завершиться с ненулевым кодом при обнаружении подделки).<br> • Если БД/файл не указаны, инструмент **обязан** использовать расположение журнала аудита по умолчанию (например, `./pki/audit/audit.log`). | **Must**  |
| **CLI‑32** | Инструмент **обязан** предоставлять подкоманду `audit verify`, выполняющую полную проверку целостности всего журнала аудита с перестроением и верификацией хеш‑цепочки. <br> • **Аргументы:** <br>   - `--log-file` – путь к журналу аудита (по умолч.: `./pki/audit/audit.log`).<br>   - `--chain-file` – путь к файлу сохранённой хеш‑цепочки (по умолч.: `./pki/audit/chain.dat`). <br> • Инструмент **обязан** сообщить, была ли целостность журнала нарушена, и по возможности указать первую повреждённую запись.                                                             | **Must**  |
| **CLI‑33** | Инструмент **обязан** предоставлять подкоманду `ca compromise` для симуляции компрометации закрытого ключа в тестовых целях. <br> • **Аргументы:** <br>   - `--cert` – путь к сертификату, чей закрытый ключ скомпрометирован.<br>   - `--reason` – код причины (по умолч.: `keyCompromise`).<br>   - `--force` – пропустить подтверждение.<br> • Данная команда **обязана**:<br>   - Пометить сертификат как `compromised` в БД (новое поле либо переиспользовать статус `revoked` с причиной `keyCompromise`).<br>   - Немедленно отозвать сертификат.<br>   - Создать запись аудита высокого уровня критичности.<br>   - Опционально инициировать экстренное обновление CRL. | **Must**  |
| **CLI‑34** | Команды `repo serve` и `ocsp serve` **должны** быть расширены поддержкой опционального **ограничения скорости запросов**. <br> • Новые флаги:<br>   - `--rate-limit` – количество запросов в секунду с одного IP‑клиента (по умолч.: `0` = отключено).<br>   - `--rate-burst` – допустимая «вспышка» запросов (по умолч.: `10`).<br> • Ограничитель **обязан** применяться ко всем HTTP‑эндпоинтам (получение сертификата, CRL, OCSP, request‑cert). <br> • При превышении лимита сервер **обязан** отвечать статусом `429 Too Many Requests` и заголовком `Retry-After`.                                                                     | **Should** |
| **CLI‑35** | Существующие команды `ca issue-cert` и `ca issue-intermediate` **обязаны** применять политики безопасности, описанные в Разделе 5. При нарушении политики выпуск **обязан** быть прерван, создана запись аудита и возвращена ошибка.                                                                                                                                                                                                           | **Must**  |

**Примеры вызова:**

```bash
# 1. Запросить записи аудита о выпуске сертификатов за последние 24 часа
$ micropki audit query \
    --from $(date -d 'yesterday' -Iseconds) \
    --operation issue \
    --format table

# 2. Проверить целостность всего журнала аудита
$ micropki audit verify --log-file ./pki/audit/audit.log

# 3. Имитировать компрометацию серверного сертификата
$ micropki ca compromise --cert ./pki/certs/example.com.cert.pem --reason keyCompromise

# 4. Запустить сервер репозитория с включённым ограничением скорости
$ micropki repo serve \
    --host 0.0.0.0 \
    --port 8080 \
    --rate-limit 5 \
    --rate-burst 10
```

---

## 3. Базовая PKI‑реализация (принудительное применение политик)

Центр сертификации должен строго соблюдать политики, касающиеся размеров ключей, сроков действия и ограничений на SAN. Любые нарушения должны блокироваться и фиксироваться в аудите.

| ID       | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | Приоритет |
|----------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **POL‑3** | **Контроль размера ключей:** <br> • Для **RSA‑ключей**:<br>   - Корневой УЦ: минимум 4096 бит (ОБЯЗАТЕЛЬНО).<br>   - Промежуточный УЦ: минимум 3072 бит (рекомендуется) или 4096 (предпочтительно). **Обязан** отклонять ключи < 2048 бит для любых УЦ или конечных субъектов.<br>   - Конечный субъект: минимум 2048 бит. Отклонять любые CSR или внутреннюю генерацию с размером ключа < 2048.<br> • Для **ECC‑ключей**:<br>   - Корневой/Промежуточный УЦ: минимум P‑384 (secp384r1). Отклонять P‑256 для Корневого/Промежуточного УЦ.<br>   - Конечный субъект: минимум P‑256 (secp256r1). P‑384 также разрешён.<br> • Эти проверки **обязаны** выполняться как при генерации ключей внутри системы, так и при обработке внешних CSR. | **Must**  |
| **POL‑4** | **Контроль срока действия:** <br> • **Корневые сертификаты УЦ:** максимальный срок **10 лет** (3650 дней). Если `--validity-days` превышает это значение, выпуск **обязан** завершиться ошибкой.<br> • **Промежуточные сертификаты УЦ:** максимальный срок **5 лет** (1825 дней).<br> • **Конечные сертификаты:** максимальный срок **1 год** (365 дней).<br> • Инструмент **обязан** отклонять любой запрос на выпуск (внутренний или через CSR), запрашивающий больший срок действия, чем разрешённый максимум.                                                                                                                     | **Must**  |
| **POL‑5** | **Проверка и ограничения SAN:** <br> • **Wildcard-сертификаты:** Для серверных сертификатов wildcard-записи SAN (например, `dns:*.example.com`) **обязаны** отклоняться, если сертификат предназначен для критических систем. Политика **должна** быть настраиваемой; по умолчанию wildcard **должны** **отклоняться** с явным сообщением об ошибке.<br> • **Запрещённые типы SAN для каждого шаблона:** <br>   - `server` – только `dns` и `ip`. `email`, `uri` не разрешены.<br>   - `client` – разрешены `email` и `dns`; `ip` и `uri` не рекомендуются, но допустимы? **Должен** обеспечивать наличие у `client` как минимум `email`; `dns` опционально.<br>   - `code_signing` – разрешены `dns` и `uri`; `ip`, `email` не разрешены.<br> • УЦ **обязан** проверять, что расширения SAN в CSR соответствуют политике шаблона; в противном случае выпуск **обязан** завершиться ошибкой. | **Must**  |
| **POL‑6** | **Контроль алгоритмов и хешей:** <br> • **Алгоритмы подписи:** <br>   - RSA‑ключи: **обязаны** использовать SHA‑256 или более сильный (SHA‑384, SHA‑512). SHA‑1 **обязан** отклоняться.<br>   - ECC‑ключи: **обязаны** использовать SHA‑384 для P‑384, SHA‑256 для P‑256.<br> • УЦ **обязан** проверять, что алгоритм подписи CSR соответствует этим требованиям; в противном случае — отклонять.                                                                                                                                                                        | **Must**  |
| **POL‑7** | **Контроль ограничений длины пути:** <br> • Корневой УЦ: без ограничения длины пути (или явно `None`).<br> • Промежуточный УЦ: ограничение длины пути **обязано** быть `0` (не может выпускать последующие УЦ) без явного переопределения (которое не рекомендуется).<br> • Инструмент **обязан** отклонять выпуск сертификата промежуточного УЦ с `pathLen > 0`, если только не используется флаг `--allow-subordinate` (не реализован; следовательно, необходимо требовать `pathLen = 0`).                                                                               | **Must**  |
| **POL‑8** | **Переопределение политик:** Инструмент **должен** поддерживать конфигурационный файл политик, позволяющий администратору ослаблять или ужесточать отдельные политики (например, разрешить wildcard, изменить максимальный срок действия). Для спринта 7 это **опционально**, но рекомендуется.                                                                                                                                                                                                       | **Could** |

---

## 4. Система аудита и целостность журнала

Надёжная система аудита должна регистрировать все события, критичные для безопасности, и обеспечивать криптографическую гарантию целостности с помощью хеш‑цепочек.

| ID       | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | Приоритет |
|----------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **AUD‑1** | **Структурированное JSON-логирование:** Все записи аудита **обязаны** записываться в формате NDJSON (newline‑delimited JSON), где каждая запись — отдельный JSON‑объект. Файл журнала **обязан** быть дополняемым (насколько это возможно) и храниться в выделенной поддиректории `audit` внутри `--out-dir` (по умолч.: `./pki/audit/audit.log`). <br> • Каждая запись **обязана** содержать как минимум:<br>   - `timestamp` (ISO 8601 с микросекундами).<br>   - `level` (например, `"AUDIT"`, `"INFO"`, `"ERROR"`).<br>   - `operation` (строка, напр. `"issue_certificate"`).<br>   - `status` (`"success"` или `"failure"`).<br>   - `message` (читаемое описание).<br>   - `metadata` (объект с операционно‑специфичными полями: серийный номер, субъект, причина, IP клиента и т.д.).<br>   - `integrity` (объект, содержащий `prev_hash`, `hash`). | **Must**  |
| **AUD‑2** | **Целостность хеш‑цепочки:** <br> • Каждая запись аудита **обязана** содержать поле `integrity` с:<br>   - `prev_hash`: SHA‑256‑хеш предыдущей записи (полная JSON‑строка). Для первой записи `prev_hash = "0"*64`.<br>   - `hash`: SHA‑256‑хеш **содержимого текущей записи, исключая само поле `integrity.hash`**. Вычисление **обязано** выполняться над каноническим JSON‑представлением (отсортированные ключи, без лишних пробелов).<br> • Инструмент **обязан** поддерживать отдельный, дополняемый файл `chain.dat`, в котором хранится только последний хеш (или полная цепочка хешей) для эффективной верификации.                                                                                               | **Must**  |
| **AUD‑3** | **Верификация журнала аудита:** Команда `audit verify` **обязана** пересчитывать хеш‑цепочку для всего файла журнала и сравнивать её с сохранённой в `chain.dat`. Любое несоответствие **обязано** сообщаться как нарушение безопасности. Инструмент **обязан** также обнаруживать пропущенные записи, переупорядоченные или модифицированные записи.                                                                                                                                                                    | **Must**  |
| **AUD‑4** | **Обязательные события аудита:** Как минимум следующие операции **обязаны** генерировать записи уровня AUDIT (уровень: `"AUDIT"`): <br> • Инициализация УЦ (корневого/промежуточного).<br> • Выпуск сертификата (включая через CSR).<br> • Отзыв сертификата (включая симуляцию компрометации).<br> • Генерация CRL.<br> • Запуск/остановка OCSP‑ответчика.<br> • Попытки нарушения политик (заблокированный выпуск).<br> • Компрометация закрытого ключа (симуляция).<br> • Изменения конфигурации (если поддерживается конфигурационный файл).                                                                        | **Must**  |
| **AUD‑5** | **Ротация журнала аудита:** Система аудита **должна** поддерживать базовую ротацию журнала (например, закрытие и повторное открытие файла по сигналу `SIGUSR1` или при достижении лимита размера). Это **опционально**, но рекомендуется.                                                                                                                                                                                                                                                                 | **Could** |
| **AUD‑6** | **Признаки взлома:** Если проверка целостности хеш‑цепочки не удалась, любые последующие критичные для безопасности операции (выпуск, отзыв) **должны** блокироваться до вмешательства администратора. Это требование уровня **Should** (рекомендуется, но не обязательно для данного спринта).                                                                                                                                                                                                      | **Should** |

**Пример записи аудита (JSON):**
```json
{
  "timestamp": "2026-02-13T15:04:05.123456Z",
  "level": "AUDIT",
  "operation": "issue_certificate",
  "status": "success",
  "message": "Issued server certificate for CN=example.com",
  "metadata": {
    "serial": "2A7F8B3C...",
    "subject": "CN=example.com,O=MicroPKI",
    "template": "server",
    "requester": "127.0.0.1"
  },
  "integrity": {
    "prev_hash": "abc123...",
    "hash": "def456..."
  }
}
```

---

## 5. Средства защиты

Должны быть реализованы дополнительные эксплуатационные средства защиты: ограничение скорости запросов, симуляция Certificate Transparency и выявление компрометации.

| ID       | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | Приоритет |
|----------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **CTL‑1** | **Ограничение скорости запросов:** Как описано в CLI‑34, серверы репозитория и OCSP **должны** поддерживать ограничение скорости на IP‑клиента. <br> • Реализация **обязана** использовать алгоритм token bucket или скользящего окна.<br> • Конфигурация ограничителя **должна** настраиваться через флаги командной строки или конфигурационный файл.<br> • При превышении лимита отвечать HTTP‑статусом 429 и заголовком `Retry-After` (в секундах). <br> • Ограничитель **обязан** быть потокобезопасным (при многопоточном сервере).                                                        | **Should** |
| **CTL‑2** | **Симуляция Certificate Transparency (CT):** <br> • Инструмент **обязан** поддерживать дополняемый текстовый файл, выступающий в роли **журнала Certificate Transparency** (симуляция). Файл **обязан** называться `ct.log` и храниться в директории `audit`.<br> • Для каждого выпущенного сертификата **обязана** добавляться строка, содержащая:<br>   - Метку времени (ISO 8601).<br>   - Серийный номер сертификата (hex).<br>   - DN субъекта.<br>   - SHA‑256 отпечаток сертификата.<br>   - Опционально: DN издателя.<br> • Этот журнал **обязан** быть общедоступным для чтения (права `0o644`) — он **не является** конфиденциальным.<br> • Инструмент **должен** предоставлять команду `audit ct-verify` для проверки наличия сертификата в журнале (доказательство включения). Поскольку это простой текстовый файл, проверка сводится к `grep`. | **Must**  |
| **CTL‑3** | **Симуляция компрометации закрытого ключа:** <br> • Команда `ca compromise` (CLI‑33) **обязана** немедленно отозвать сертификат с причиной `keyCompromise`.<br> • Кроме того, инструмент **обязан** пометить соответствующий закрытый ключ как скомпрометированный в новой таблице БД (`compromised_keys`) либо через новое поле в таблице сертификатов.<br> • Инструмент **должен** также инициировать **экстренное обновление CRL** (т.е. немедленно сгенерировать новый CRL).<br> • **Обязательно** создание записи аудита высокого уровня критичности.                                                                                              | **Must**  |
| **CTL‑4** | **Блокировка скомпрометированных ключей:** Если закрытый ключ помечен как скомпрометированный, любой будущий CSR, использующий тот же открытый ключ (т.е. одинаковый модуль для RSA, одинаковую точку кривой для ECC), **обязан** отклоняться УЦ. Инструмент **обязан** проверять базу данных скомпрометированных ключей перед выпуском.                                                                                                                                                                           | **Should** |
| **CTL‑5** | **Симуляция обнаружения вторжений:** Инструмент **должен** предоставлять команду `audit detect-anomalies`, выполняющую простой эвристический анализ журнала аудита (например, внезапный всплеск выпусков, отзывов и т.п.). Это **опционально** и может быть реализовано упрощённо (например, подсчёт событий в час и предупреждение при превышении порога).                                                                                                                                          | **Could** |

---

## 6. Расширения базы данных

Схема базы данных должна быть расширена для поддержки отслеживания компрометации и метаданных аудита.

| ID        | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Приоритет |
|-----------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **DB‑10** | **Новая таблица: `compromised_keys`** <br> Для поддержки симуляции компрометации и блокировки **рекомендуется** создать следующую таблицу:                                                                                                                                                                                                                                                                                                                                                                       | **Should** |

```sql
CREATE TABLE compromised_keys (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    public_key_hash TEXT UNIQUE NOT NULL,   -- SHA‑256 открытого ключа (DER) для быстрого поиска
    certificate_serial TEXT NOT NULL,       -- серийный номер отозванного сертификата
    compromise_date TEXT NOT NULL,          -- ISO 8601
    compromise_reason TEXT NOT NULL,        -- строка с причиной
    FOREIGN KEY (certificate_serial) REFERENCES certificates(serial_hex)
);
```

| ID        | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Приоритет |
|-----------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **DB‑11** | **Таблица журнала аудита (опционально):** Журнал аудита хранится в файле, не в БД. Создание новой таблицы для записей аудита не требуется. Файл `chain.dat` является отдельным.                                                                                                                                                                                                                                                                                                  | **N/A**   |
| **DB‑12** | **Миграция:** Команда `db init` **обязана** создавать таблицу `compromised_keys`, если она ещё не существует. Студенту **рекомендуется** предоставить скрипт миграции для существующих баз данных (или задокументировать необходимость создания свежей БД).                                                                                                                                                                                                                         | **Should** |

---

## 7. Логирование и аудит (расширения)

Существующая система логирования должна быть модернизирована для поддержки новой системы аудита.

| ID         | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                              | Приоритет |
|------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **LOG‑17** | **Аудитный регистратор:** **Обязательно** реализовать выделенный аудитный регистратор, который записывает NDJSON в файл журнала аудита с хеш‑цепочкой. Этот регистратор **обязан** быть отдельным от прикладного логгера (который пишет обычный текст в stderr/файл).                                                                                                                                                                            | **Must**  |
| **LOG‑18** | **Сокрытие конфиденциальных данных:** Аудитный регистратор **обязан никогда не записывать** закрытые ключи, парольные фразы или любой секретный материал. Открытые ключи сертификатов допустимы.                                                                                                                                                                                                                                                | **Must**  |
| **LOG‑19** | **Инициализация журнала:** При запуске приложения (CLI или сервера) система аудита **обязана** быть инициализирована. Если файл журнала аудита не существует, он **обязан** быть создан с первой записью, имеющей `prev_hash = "0"*64`.                                                                                                                                                                                                              | **Must**  |

---

## 8. Тестирование и верификация

Усиленная PKI должна быть протестирована на предмет нарушений политик, а также должна быть подтверждена целостность системы аудита.

| ID          | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | Приоритет |
|-------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **TEST‑51** | **Нарушение политики – недостаточный размер ключа:** Попытаться выпустить конечный сертификат с RSA‑ключом 1024 бит (или сгенерировать CSR с ключом 1024 бит). УЦ **обязан** отклонить запрос с ошибкой, и **обязана** быть создана запись аудита уровня AUDIT.                                                                                                                                                                                                                                                                                | **Must**  |
| **TEST‑52** | **Нарушение политики – превышение срока действия:** Попытаться выпустить конечный сертификат со сроком действия > 365 дней. УЦ **обязан** отклонить запрос.                                                                                                                                                                                                                                                                                                                                                                                  | **Must**  |
| **TEST‑53** | **Нарушение политики – Wildcard в SAN:** Попытаться выпустить серверный сертификат с SAN `dns:*.example.com`. УЦ **обязан** отклонить (в соответствии с политикой по умолчанию).                                                                                                                                                                                                                                                                                                                                                             | **Must**  |
| **TEST‑54** | **Нарушение политики – запрещённый тип SAN:** Попытаться выпустить сертификат для подписи кода (code‑signing) с SAN типа `email`. УЦ **обязан** отклонить.                                                                                                                                                                                                                                                                                                                                                                                   | **Must**  |
| **TEST‑55** | **Целостность аудита – обнаружение подделки:** <br> 1. Создать несколько записей аудита (выпуски, отзывы).<br> 2. Вручную изменить один байт в файле журнала аудита (с помощью hex‑редактора или скрипта).<br> 3. Запустить `micropki audit verify` – инструмент **обязан** обнаружить подделку и завершиться с ненулевым кодом.                                                                                                                                                                                                                  | **Must**  |
| **TEST‑56** | **Целостность аудита – непрерывность цепочки:** <br> 1. Создать записи аудита A, B, C.<br> 2. Удалить запись B.<br> 3. Запустить `audit verify` – инструмент **обязан** обнаружить пропущенную запись (несовпадение хеша между A и C).                                                                                                                                                                                                                                                                                                      | **Should** |
| **TEST‑57** | **Симуляция компрометации и блокировка:** <br> 1. Выпустить сертификат (Серийный номер X).<br> 2. Выполнить `micropki ca compromise --cert cert.pem`.<br> 3. Убедиться, что статус сертификата — `revoked` с причиной `keyCompromise`.<br> 4. Убедиться, что таблица `compromised_keys` содержит хеш открытого ключа.<br> 5. Сгенерировать CSR с **тем же** закрытым ключом и попытаться выпустить новый сертификат. УЦ **обязан** отклонить запрос (ключ скомпрометирован).                                                                      | **Should** |
| **TEST‑58** | **Тест ограничения скорости:** <br> 1. Запустить сервер репозитория с `--rate-limit 1 --rate-burst 2`.<br> 2. Отправить 5 быстрых запросов к `/ca/root`.<br> 3. Как минимум 4-й и 5-й запросы **обязаны** получить HTTP‑статус 429.<br> 4. В журнале **обязано** быть указано превышение лимита.                                                                                                                                                                                                                                             | **Should** |
| **TEST‑59** | **Тест журнала Certificate Transparency:** <br> 1. Выпустить сертификат.<br> 2. Убедиться, что запись добавлена в `ct.log`.<br> 3. Выполнить `grep` для подтверждения наличия серийного номера.                                                                                                                                                                                                                                                                                                                                              | **Must**  |
| **TEST‑60** | **Полный интеграционный тест усиления безопасности:** <br> Единый автоматизированный скрипт, который:<br> • Запускает репозиторий с ограничением скорости.<br> • Пытается выполнить множественные нарушения политик — все должны быть заблокированы и зафиксированы в аудите.<br> • Выпускает валидный сертификат, записывает его в CT, аудит‑трейл остаётся целым.<br> • Имитирует компрометацию ключа, инициирует экстренный CRL, блокирует повторный выпуск.<br> • Проверяет целостность журнала аудита до и после попытки подделки.<br> • Демонстрирует, что система защищена от базовых атак. | **Should** |

---

## 9. Сводка обязательных технологических решений (дополнения для спринта 7)

| Компонент             | Требование (дополнения спринта 7)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|-----------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Аудитный журнал**   | • **Формат:** NDJSON (JSON, разделённый переводами строк).<br> • **Хеш‑цепочка:** SHA‑256, связывание каждой записи с предыдущей.<br> • **Библиотека:** Использовать стандартную JSON‑библиотеку (`json` в Python, `encoding/json` в Go).<br> • **Файловый ввод/вывод:** Дополняемая запись; рекомендуется файловая блокировка (fcntl/flock или рекомендательная).                                                                                                                                                                                                                             |
| **Применение политик**| • Проверка размера ключей: реализуется при обработке CSR и генерации ключей.<br> • Проверка срока действия: сравнение `--validity-days` с настроенным максимумом.<br> • Проверка типов SAN: валидация каждого SAN на соответствие разрешённым типам для шаблона.<br> • Обнаружение wildcard: отклонять при наличии шаблона `*.` (настраиваемо).<br> • Внешний механизм политик не требуется; все проверки реализуются жёстко или через конфигурационный файл.                                                                                                                                |
| **Ограничение скорости** | • **Python:** `flask-limiter` (при использовании Flask) либо собственная реализация token bucket с помощью `time` и `collections.deque`.<br> • **Go:** пакет `golang.org/x/time/rate` (token bucket) или собственная реализация с `sync.Map` и таймерами.<br> • Обязательна поддержка ограничения на IP‑клиента.                                                                                                                                                                                                                                                                           |
| **Симуляция CT**      | • Простой текстовый файл, дополняемый.<br> • Никаких деревьев Меркла, криптографических доказательств (только симуляция).                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Симуляция компрометации** | • Новая CLI‑команда `ca compromise`.<br> • Таблица БД `compromised_keys`.<br> • Хеширование открытого ключа: SHA‑256 от DER‑представления SPKI.                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **CLI**               | • Подкоманды `audit query` и `audit verify`.<br> • Подкоманда `ca compromise`.<br> • Новые флаги для ограничения скорости в командах `serve`.                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Конфигурация**      | • Опциональный конфигурационный файл YAML/TOML/JSON.<br> • Если реализован, обязательно описан в README.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **Тестирование**      | • Автоматизированные тесты для отбраковки по политикам, целостности аудита, ограничению скорости, блокировке скомпрометированных ключей.<br> • Использование временных файлов/директорий для журнала аудита и CT‑журнала в тестах.                                                                                                                                                                                                                                                                                                                                                        |

---

**Окончание требований спринта 7**
*Все требования могут быть уточнены. В случае сомнений отдавайте приоритет целостности журнала аудита и принудительному применению политик перед расширенными возможностями, такими как настраиваемые политики или обнаружение аномалий.*
