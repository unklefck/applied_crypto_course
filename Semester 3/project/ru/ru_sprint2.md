# **Проект: MicroPKI – Технические требования (Спринт 2)**

**Цель спринта:** Расширить PKI путём создания промежуточного удостоверяющего центра (выпускающего УЦ) и реализации механизма шаблонов сертификатов, позволяющего генерировать серверные, клиентские сертификаты и сертификаты подписи кода с корректными расширениями X.509v3 и поддержкой альтернативных имён субъекта (SAN).

---

## 1. Структура проекта и гигиена репозитория

Кодовая база должна оставаться организованной и расширяемой. Добавляются новые модули для обработки CSR, шаблонов сертификатов и проверки цепочек.

| ID      | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                          | Приоритет |
|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **STR-6**  | Репозиторий **обязан** сохранять структуру, заложенную в Спринте 1. Новые файлы с исходным кодом **обязаны** размещаться в логически поименованных модулях (например, `csr.py`, `templates.py`, `chain.py` для Python; `internal/csr/`, `internal/templates/`, `internal/chain/` для Go).                                                                                                                                                    | **Must**  |
| **STR-7**  | Файл `README.md` **обязан** быть обновлён с примерами использования для Спринта 2, новыми зависимостями (если есть) и инструкциями по созданию промежуточного УЦ и выпуску сертификата.                                                                                                                                                                                                                                                       | **Must**  |
| **STR-8**  | Весь новый код **обязан** следовать тем же соглашениям по стилю, документированию и тестированию, которые были установлены в Спринте 1.                                                                                                                                                                                                                                                                                                       | **Must**  |

---

## 2. Парсер командной строки (CLI)

Интерфейс командной строки должен поддерживать создание промежуточного УЦ и выпуск конечных сертификатов с использованием шаблонов.

| ID       | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Приоритет |
|----------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **CLI-7**  | Инструмент **обязан** предоставлять подкоманду `ca issue-intermediate`, которая генерирует запрос на сертификат (CSR) для промежуточного УЦ, подписывает его корневым УЦ и сохраняет полученный сертификат промежуточного УЦ вместе с зашифрованным закрытым ключом.                                                                                                                                                                                                                                                                               | **Must**  |
|          | **Обязательные аргументы:**<br> • `--root-cert`      – путь к сертификату корневого УЦ (PEM).<br> • `--root-key`       – путь к зашифрованному закрытому ключу корневого УЦ (PEM).<br> • `--root-pass-file` – файл с парольной фразой для ключа корневого УЦ.<br> • `--subject`         – отличительное имя (DN) для промежуточного УЦ (например, `CN=Intermediate CA,O=MicroPKI`).<br> • `--key-type`        – `rsa` (4096) или `ecc` (384).<br> • `--passphrase-file` – парольная фраза для закрытого ключа промежуточного УЦ.<br> • `--out-dir`         – выходной каталог (по умолчанию `./pki`).<br> • `--validity-days`   – срок действия (по умолчанию `1825` ≈ 5 лет).<br> • `--pathlen`         – ограничение длины пути (pathLenConstraint; по умолчанию `0`).                                                                                                 | **Must**  |
| **CLI-8**  | Инструмент **обязан** предоставлять подкоманду `ca issue-cert`, которая выпускает конечный сертификат, подписанный промежуточным УЦ.                                                                                                                                                                                                                                                                                                                                                                                                            | **Must**  |
|          | **Обязательные аргументы:**<br> • `--ca-cert`   – сертификат промежуточного УЦ (PEM).<br> • `--ca-key`    – зашифрованный закрытый ключ промежуточного УЦ (PEM).<br> • `--ca-pass-file` – парольная фраза для ключа промежуточного УЦ.<br> • `--template`  – шаблон сертификата: `server`, `client` или `code_signing`.<br> • `--subject`  – отличительное имя для сертификата.<br> • `--san`      – альтернативные имена субъекта (SAN). Для сервера: DNS-имена, IP-адреса; для клиента: адреса электронной почты, DNS; для подписи кода – не обязательно, но допускаются DNS/URI.<br> • `--out-dir`  – выходной каталог (по умолчанию `./pki/certs`).<br> • `--validity-days` – срок действия конечного сертификата (по умолчанию `365`).                                                         | **Must**  |
| **CLI-9**  | CLI **обязан** принимать несколько записей SAN, например: `--san dns:example.com --san dns:www.example.com --san ip:192.168.1.1`.                                                                                                                                                                                                                                                                                                                                               | **Must**  |
| **CLI-10** | CLI **обязан** проверять, поддерживает ли выбранный шаблон указанные типы SAN (например, для шаблона `code_signing` не должны допускаться IP-адреса). Недопустимые комбинации **обязаны** отклоняться с понятным сообщением об ошибке.                                                                                                                                                                                                                                           | **Should**|
| **CLI-11** | Подкоманда `ca issue-cert` **рекомендуется** поддерживать необязательный аргумент `--csr` для подписи внешнего сформированного CSR вместо генерации новой пары ключей внутри инструмента.                                                                                                                                                                                                                                                                                        | **Could** |

**Примеры вызова:**

```bash
# 1. Создание промежуточного УЦ, подписанного корневым УЦ
$ micropki ca issue-intermediate \
    --root-cert ./pki/certs/ca.cert.pem \
    --root-key ./pki/private/ca.key.pem \
    --root-pass-file ./secrets/root.pass \
    --subject "CN=MicroPKI Intermediate CA,O=MicroPKI" \
    --key-type rsa \
    --key-size 4096 \
    --passphrase-file ./secrets/intermediate.pass \
    --out-dir ./pki \
    --validity-days 1825 \
    --pathlen 0

# 2. Выпуск серверного сертификата от промежуточного УЦ
$ micropki ca issue-cert \
    --ca-cert ./pki/certs/intermediate.cert.pem \
    --ca-key ./pki/private/intermediate.key.pem \
    --ca-pass-file ./secrets/intermediate.pass \
    --template server \
    --subject "CN=example.com,O=MicroPKI" \
    --san dns:example.com \
    --san dns:www.example.com \
    --san ip:192.168.1.10 \
    --out-dir ./pki/certs \
    --validity-days 365

# 3. Выпуск клиентского сертификата
$ micropki ca issue-cert \
    --ca-cert ./pki/certs/intermediate.cert.pem \
    --ca-key ./pki/private/intermediate.key.pem \
    --ca-pass-file ./secrets/intermediate.pass \
    --template client \
    --subject "CN=Alice Smith,EMAIL=alice@example.com" \
    --san email:alice@example.com \
    --out-dir ./pki/certs

# 4. Выпуск сертификата для подписи кода
$ micropki ca issue-cert \
    --ca-cert ./pki/certs/intermediate.cert.pem \
    --ca-key ./pki/private/intermediate.key.pem \
    --ca-pass-file ./secrets/intermediate.pass \
    --template code_signing \
    --subject "CN=MicroPKI Code Signer" \
    --out-dir ./pki/certs
```

---

## 3. Базовая реализация PKI

Все криптографические операции по-прежнему должны использовать утверждённые библиотеки. **Запрещена самостоятельная реализация криптографических примитивов.**

| ID      | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Приоритет |
|---------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **PKI-6**  | **Генерация CSR для промежуточного УЦ:** Инструмент **обязан** сгенерировать запрос на сертификат (PKCS#10) для промежуточного УЦ. CSR **обязан** содержать:<br> • DN субъекта согласно переданному значению.<br> • Открытый ключ сгенерированной пары ключей промежуточного УЦ.<br> • Расширение Basic Constraints **рекомендуется** включить в CSR (`CA=TRUE`, `pathLenConstraint` = значение `--pathlen`). Включение опционально, но настоятельно рекомендуется; итоговый сертификат **обязан** содержать это расширение.                             | **Must**  |
| **PKI-7**  | **Подписание CSR промежуточного УЦ корневым УЦ:** Корневой УЦ **обязан** подписать CSR промежуточного УЦ своим закрытым ключом. Итоговый сертификат X.509 **обязан** соответствовать RFC 5280 и включать:<br> • Версию v3.<br> • Серийный номер: генерируется CSPRNG, минимум 20 бит энтропии.<br> • Издатель = субъект корневого УЦ.<br> • Срок действия согласно `--validity-days`.<br> • **Basic Constraints:** `CA=TRUE`, `pathLenConstraint` устанавливается в значение `--pathlen` (по умолчанию `0`). Расширение **обязано** быть критическим.<br> • **Key Usage:** `keyCertSign`, `cRLSign`. Критическое.<br> • **SKI** и **AKI** согласно RFC 5280 (SKI – из открытого ключа промежуточного УЦ, AKI – из SKI корневого УЦ).<br> • Алгоритм подписи: SHA‑256 с RSA или SHA‑384 с ECDSA, в соответствии с алгоритмом корневого УЦ. | **Must**  |
| **PKI-8**  | **Генерация конечных сертификатов:** Инструмент **обязан** поддерживать три шаблона сертификатов: `server`, `client`, `code_signing`. Для каждого шаблона следующие расширения **обязаны** быть установлены соответствующим образом:                                                                                                                                                                                                                                                                                                            | **Must**  |
|          | **Серверный сертификат:**<br> • **Basic Constraints:** `CA=FALSE`. Критическое.<br> • **Key Usage:** `digitalSignature`, `keyEncipherment` (для RSA) **или** только `digitalSignature` (для ECC). Критическое.<br> • **Extended Key Usage:** `serverAuth` (1.3.6.1.5.5.7.3.1).<br> • **Subject Alternative Name:** Как минимум одно DNS-имя или IP-адрес **обязаны** присутствовать.                                                                                                                                                               |          |
|          | **Клиентский сертификат:**<br> • **Basic Constraints:** `CA=FALSE`. Критическое.<br> • **Key Usage:** `digitalSignature` (и опционально `keyAgreement` для ECDH). Критическое.<br> • **Extended Key Usage:** `clientAuth` (1.3.6.1.5.5.7.3.2).<br> • **Subject Alternative Name:** Рекомендуется указывать `rfc822Name` (email), если он предоставлен.                                                                                                                                                                                           |          |
|          | **Сертификат подписи кода:**<br> • **Basic Constraints:** `CA=FALSE`. Критическое.<br> • **Key Usage:** `digitalSignature`. Критическое.<br> • **Extended Key Usage:** `codeSigning` (1.3.6.1.5.5.7.3.3).<br> • **Subject Alternative Name:** Не требуется; если указаны, следует ограничить типами DNS или URI.                                                                                                                                                                                                                                 |          |
| **PKI-9**  | **Обработка альтернативных имён субъекта (SAN):** CLI **обязан** разбирать строки SAN формата `тип:значение`. Поддерживаемые типы: `dns`, `ip`, `email`, `uri`. Соответствующие структуры GeneralName **обязаны** быть корректно закодированы согласно RFC 5280. Для шаблона `server` **обязан** присутствовать как минимум один SAN соответствующего типа; для `client` – **рекомендуется**.                                                                                                                                                         | **Must**  |
| **PKI-10** | **Кодировка и сохранение сертификатов:** Все сгенерированные сертификаты (промежуточного УЦ и конечные) **обязаны** сохраняться в формате PEM. Сертификат промежуточного УЦ **обязан** быть записан как `intermediate.cert.pem` внутри подкаталога `certs` в `--out-dir`. Конечные сертификаты **обязаны** именоваться с использованием общего имени (CN) или уникального идентификатора (например, `example.com.cert.pem`).                                                                                                                      | **Must**  |
| **PKI-11** | **Генерация ключей для конечных субъектов:** Если `--csr` не указан, инструмент **обязан** сгенерировать новую пару ключей (минимум RSA‑2048 или ECC P‑256) для конечного сертификата. Закрытый ключ **обязан** сохраняться **без шифрования** (простой PEM) в выходном каталоге с правами доступа `0o600`. Имя файла **обязано** соответствовать имени сертификата (например, `example.com.key.pem`).                                                                                                                                            | **Must**  |
| **PKI-12** | **Подписание CSR (опционально):** Если указан `--csr`, инструмент **обязан** проверить подпись CSR, извлечь открытый ключ и выпустить сертификат с запрошенным субъектом и расширениями (переопределяя шаблонные значения по необходимости). Закрытый ключ не сохраняется.                                                                                                                                                                                                          | **Could** |

---

## 4. Безопасное хранение ключей и управление выходными данными

Закрытый ключ промежуточного УЦ должен быть защищён с той же строгостью, что и ключ корневого УЦ. Выпущенные сертификаты и ключи должны размещаться в предсказуемой структуре каталогов.

| ID      | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Приоритет |
|---------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **KEY-5** | **Закрытый ключ промежуточного УЦ:** Закрытый ключ промежуточного УЦ **обязан** быть зашифрован с парольной фразой, переданной через `--passphrase-file`, с использованием того же метода, что и в Спринте 1 (PKCS#8 или зашифрованный PEM с AES‑256). Файл **обязан** быть сохранён как `intermediate.key.pem` внутри подкаталога `private` в `--out-dir`. Права доступа к файлу **обязаны** быть `0o600`.                                                                                                                                             | **Must**  |
| **KEY-6** | **Расширение структуры каталогов:** Инструмент **обязан** поддерживать следующую структуру каталогов внутри `--out-dir`. Каталоги **обязаны** создаваться, если они отсутствуют.                                                                                                                                                                                                                                                                                                                                                                       | **Must**  |

```
<out-dir>/
├── private/
│   ├── ca.key.pem               (зашифрованный ключ корневого УЦ)
│   └── intermediate.key.pem     (зашифрованный ключ промежуточного УЦ)
├── certs/
│   ├── ca.cert.pem             (сертификат корневого УЦ)
│   ├── intermediate.cert.pem   (сертификат промежуточного УЦ)
│   └── *.cert.pem              (выпущенные конечные сертификаты)
├── csrs/                       (опционально, для хранения CSR)
│   └── *.csr.pem
└── policy.txt                 (обновляется с информацией о промежуточном УЦ)
```

| ID      | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Приоритет |
|---------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **KEY-7** | **Хранение закрытого ключа конечного субъекта:** Незашифрованный закрытый ключ для конечного сертификата **обязан** сохраняться в том же каталоге, что и сертификат, с тем же базовым именем и суффиксом `.key.pem`. Права доступа **обязаны** быть `0o600`. Инструмент **обязан** выдать предупреждение о том, что закрытый ключ хранится без шифрования.                                                                                                                                                                                              | **Must**  |

---

## 5. Политика и журналирование

Документ политики должен быть обновлён с учётом появления промежуточного УЦ. Логирование должно охватывать все новые операции.

| ID      | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                          | Приоритет |
|---------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **POL-2** | **Обновление документа политики:** Файл `policy.txt` в корне `--out-dir` **обязан** быть дополнен (или новая секция добавлена) следующей информацией о промежуточном УЦ:<br> • DN субъекта<br> • Серийный номер (шестнадцатеричный)<br> • Период действия<br> • Алгоритм и размер ключа<br> • Ограничение длины пути (path length constraint)<br> • DN издателя (корневого УЦ)                                                                      | **Must**  |
| **LOG-4** | **Новые события логирования:** Система логирования **обязана** записывать следующие операции Спринта 2 с уровнем `INFO`:<br> • Генерация CSR для промежуточного УЦ.<br> • Подписание сертификата промежуточного УЦ корневым УЦ.<br> • Успешный выпуск конечного сертификата (включая имя шаблона, субъект, SAN).<br> • Любые ошибки валидации (например, отсутствие SAN для серверного сертификата, неподдерживаемый тип SAN) **обязаны** логироваться с уровнем `ERROR` или `WARNING`. | **Must**  |
| **LOG-5** | **Аудиторский след выпуска:** Каждый выпущенный сертификат **рекомендуется** логировать с указанием серийного номера, субъекта, шаблона и временной метки выпуска.                                                                                                                                                                                                                                                                        | **Should**|

---

## 6. Тестирование и проверка

Реализация должна быть демонстрационно корректной и совместимой со стандартными PKI-инструментами.

| ID       | Описание требования                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | Приоритет |
|----------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| **TEST-7** | **Проверка цепочки сертификатов:** Инструмент **обязан** предоставить команду (или документированную процедуру) для проверки полной цепочки сертификатов: `конечный → промежуточный → корневой`. Проверка **обязана** включать:<br> • Проверку подписей на каждом уровне.<br> • Проверку сроков действия.<br> • Проверку Basic Constraints (флаг CA и ограничение длины пути).<br> • Проверку совместимости Key Usage / Extended Key Usage (опционально).                                                                               | **Must**  |
| **TEST-8** | **Корректность расширений:** С помощью OpenSSL студент **обязан** убедиться, что все требуемые расширения присутствуют и корректно помечены как критические/некритические. Для серверных сертификатов **обязано** быть подтверждено наличие записей SAN. Пример:<br> `openssl x509 -in cert.pem -text -noout`                                                                                                                                                                                                                          | **Must**  |
| **TEST-9** | **Сквозной тест (round-trip):** Студент **обязан** продемонстрировать, что серверный сертификат, выпущенный промежуточным УЦ, может быть использован для установки TLS-соединения (например, с помощью `openssl s_server` / `openssl s_client`), когда клиент доверяет корневому УЦ. **Рекомендуется** предоставить тестовый скрипт.                                                                                                                                                                                              | **Should**|
| **TEST-10**| **Негативные тесты:** Набор тестов **обязан** включать как минимум следующие негативные сценарии, каждый из которых ожидает корректную ошибку и ненулевой код возврата:<br> • Попытка выпустить серверный сертификат без SAN.<br> • Выпуск сертификата с неподдерживаемым типом SAN для данного шаблона.<br> • Использование неверной парольной фразы для ключа промежуточного УЦ.<br> • Подписание CSR, в котором запрашивается `CA=true` для конечного сертификата (должно быть отклонено или переопределено на `CA=false`).           | **Should**|
| **TEST-11**| **Совместимость с OpenSSL:** Сгенерированный сертификат промежуточного УЦ **рекомендуется** проверить с помощью OpenSSL:<br> `openssl verify -CAfile root.pem intermediate.pem`<br> Выпущенный конечный сертификат **рекомендуется** проверить с полной цепочкой:<br> `openssl verify -CAfile root.pem -untrusted intermediate.pem leaf.pem`                                                                                                                                                                                            | **Should**|
| **TEST-12**| **Модульные тесты:** Для новых ключевых функций (генерация CSR, построение расширений, разбор SAN, применение шаблонов) **обязаны** присутствовать как минимум базовые модульные тесты.                                                                                                                                                                                                                                                                                  | **Must**  |

---

## 7. Сводка обязательного технического стека

| Компонент             | Требование (дополнения для Спринта 2)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|-----------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Языки**             | Те же, что и в Спринте 1 (Python ≥3.8 или Go ≥1.18).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Криптобиблиотека**  | • **Python:** `cryptography` для генерации CSR (`x509.CertificateSigningRequestBuilder`), выпуска сертификатов (`x509.CertificateBuilder`) и работы с расширениями.<br> • **Go:** Стандартный пакет `crypto/x509` для создания шаблонов CSR, разбора CSR и построения сертификатов.                                                                                                                                                                                                                                                   |
| **Обработка CSR**     | • **Python:** `x509.CertificateSigningRequestBuilder` и `x509.CertificateSigningRequest`.<br> • **Go:** `x509.CreateCertificateRequest` и `x509.ParseCertificateRequest`.                                                                                                                                                                                                                                                                                                                                                             |
| **Шаблоны сертификатов** | Реализуются программно; внешние файлы шаблонов не требуются. Три шаблона (`server`, `client`, `code_signing`) **обязаны** быть различимы и обеспечивать корректные политики EKU и SAN.                                                                                                                                                                                                                                                                                                                                                  |
| **Альтернативные имена субъекта (SAN)** | • **Python:** Расширение `x509.SubjectAlternativeName`, содержащее `x509.DNSName`, `x509.IPAddress`, `x509.RFC822Name`, `x509.UniformResourceIdentifier`.<br> • **Go:** Поля структуры `x509.Certificate`: `DNSNames`, `IPAddresses`, `EmailAddresses`, `URIs`.                                                                                                                                                                                                                                                                      |
| **Хранение ключей**   | • Ключи корневого и промежуточного УЦ: зашифрованный PEM (как в Спринте 1).<br> • Закрытые ключи конечных субъектов: незашифрованный PEM с правами `0o600`.                                                                                                                                                                                                                                                                                                                                                                            |
| **CLI-фреймворк**     | Тот же, что в Спринте 1. Подкоманды **обязаны** быть организованы иерархически (например, `micropki ca issue-intermediate`, `micropki ca issue-cert`).                                                                                                                                                                                                                                                                                                                                                                                 |
| **Логирование**       | То же, что в Спринте 1; новые обязательные библиотеки не требуются.                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Файл политики**     | Обычный текст, дополненный сведениями о промежуточном УЦ.                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |

---

**Конец требований Спринта 2**
*Все требования могут быть уточнены. В случае сомнений отдавайте предпочтение корректности и следованию RFC 5280, а не полноте функционала.*
