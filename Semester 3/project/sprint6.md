# **Project: MicroPKI - Technical Requirements Document (Sprint 6)**

**Sprint Goal:** Implement a certificate path validation engine and a suite of client tools that enable CSR generation, certificate issuance requests, full chain validation, and revocation checking (CRL + OCSP) with intelligent fallback logic.

---

## 1. Project Structure & Repository Hygiene

The codebase must now include path validation modules, revocation checking logic, and client‑side CLI tools.

| ID     | Requirement Description                                                                                                                                                                                                                                                                                                                                                                                                                          | Priority |
|--------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| **STR‑19** | The repository **must** retain the structure from Sprints 1–5. New modules **must** be added for validation and client functionality: <br> • **Python:** `validation.py`, `revocation_check.py`, `client.py`.<br> • **Go:** `internal/validation/`, `internal/revocation/`, `internal/client/`, and a new `cmd/micropki-client` (if separating client binary) **or** extend existing `micropki` CLI with `client` subcommand.                        | **Must** |
| **STR‑20** | The `README.md` **must** be updated with:<br> • Instructions for generating a CSR and requesting a certificate (`client request-cert`).<br> • How to validate a certificate chain (`client validate`).<br> • How to check revocation status using both CRL and OCSP (`client check-status`).<br> • Explanation of the revocation preference logic (OCSP first, fallback to CRL).                                                                      | **Must** |
| **STR‑21** | If a separate client binary is created (e.g., `micropki-client`), it **must** be built and installed alongside the main `micropki` tool. The same coding standards and dependency management **must** apply.                                                                                                                                                                                                                                       | **Should** |

---

## 2. Command‑Line Interface (CLI) Parser

The CLI must provide comprehensive client‑side commands for certificate management and validation.

| ID     | Requirement Description                                                                                                                                                                                                                                                                                                                                                          | Priority |
|--------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| **CLI‑25** | The tool **must** provide a subcommand `client gen-csr` that generates a private key and a PKCS#10 Certificate Signing Request (CSR) for an end‑entity certificate. <br> • **Arguments:** <br>   - `--subject` – Distinguished Name.<br>   - `--key-type` – `rsa` or `ecc` (default: `rsa`).<br>   - `--key-size` – for RSA: 2048 or 4096 (default: 2048); for ECC: 256 or 384 (default: 256).<br>   - `--san` – Subject Alternative Name(s) (same format as Sprint 2).<br>   - `--out-key` – output file for private key (unencrypted PEM) (default: `./key.pem`).<br>   - `--out-csr` – output file for CSR (PEM) (default: `./request.csr.pem`).<br> • The private key **must** be saved **unencrypted** with permissions `0o600`. A warning **must** be displayed. | **Must** |
| **CLI‑26** | The tool **must** provide a subcommand `client request-cert` that submits a CSR to the CA (via the repository API) and retrieves the issued certificate. <br> • **Arguments:** <br>   - `--csr` – path to CSR file (PEM).<br>   - `--template` – certificate template: `server`, `client`, `code_signing`.<br>   - `--ca-url` – base URL of the repository (e.g., `http://localhost:8080`).<br>   - `--out-cert` – output file for certificate (PEM) (default: `./cert.pem`).<br> • The tool **must** send the CSR to the CA’s issuance endpoint (to be defined – see **REPO‑15**).<br> • The tool **must** handle HTTP errors and display meaningful messages. | **Must** |
| **CLI‑27** | The tool **must** provide a subcommand `client validate` that performs full certificate chain validation. <br> • **Arguments:** <br>   - `--cert` – path to leaf certificate (PEM).<br>   - `--untrusted` – optional intermediate certificate(s) (PEM, can be repeated or single file with chain).<br>   - `--trusted` – path to trusted Root CA certificate(s) (PEM bundle) (default: `./pki/certs/ca.cert.pem`).<br>   - `--crl` – optional, check CRL (local file or URL).<br>   - `--ocsp` – optional, perform OCSP check.<br>   - `--mode` – `chain` (only signature/validity) or `full` (includes revocation) (default: `full`).<br> • The tool **must** output a clear pass/fail result and list validation steps. | **Must** |
| **CLI‑28** | The tool **must** provide a subcommand `client check-status` that checks revocation status of a certificate using both CRL and OCSP, with OCSP first and fallback to CRL. <br> • **Arguments:** <br>   - `--cert` – path to certificate (PEM).<br>   - `--ca-cert` – issuer CA certificate (PEM).<br>   - `--crl` – optional, specific CRL file or URL to use.<br>   - `--ocsp-url` – optional, override OCSP responder URL (otherwise extracted from certificate AIA).<br> • The tool **must** print the status: `good`, `revoked`, or `unknown`, with details (revocation time/reason if revoked). | **Must** |
| **CLI‑29** | The existing `ca issue-cert` command **should** be extended to support a `--csr` flag (as a **Could** in Sprint 2). For Sprint 6, this **must** be implemented, enabling the CA to accept external CSRs.                                                                                                                                                                                                                                         | **Must** |
| **CLI‑30** | The repository server **must** provide a new endpoint for certificate issuance (see **REPO‑15**). The `client request-cert` command **must** use this endpoint.                                                                                                                                                                                                                                                                                   | **Must** |

**Example invocations:**

```bash
# 1. Generate a private key and CSR for a server certificate
$ micropki client gen-csr \
    --subject "CN=app.example.com" \
    --key-type rsa \
    --key-size 2048 \
    --san dns:app.example.com \
    --san dns:api.example.com \
    --out-key ./app.key.pem \
    --out-csr ./app.csr.pem

# 2. Submit the CSR to the CA and receive a signed certificate
$ micropki client request-cert \
    --csr ./app.csr.pem \
    --template server \
    --ca-url http://localhost:8080 \
    --out-cert ./app.cert.pem

# 3. Validate a certificate chain (with local trust store)
$ micropki client validate \
    --cert ./app.cert.pem \
    --untrusted ./pki/certs/intermediate.cert.pem \
    --trusted ./pki/certs/ca.cert.pem \
    --crl http://localhost:8080/crl?ca=intermediate \
    --ocsp

# 4. Check revocation status of a certificate (OCSP first, CRL fallback)
$ micropki client check-status \
    --cert ./app.cert.pem \
    --ca-cert ./pki/certs/intermediate.cert.pem
```

---

## 3. Core PKI Implementation (Path Validation Engine)

The path validation engine must implement a simplified version of RFC 5280 path validation.

| ID     | Requirement Description                                                                                                                                                                                                                                                                                                                                                                                                                                      | Priority |
|--------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| **VAL‑1** | **Certificate Chain Building:** The validator **must** be able to construct a certification path from a leaf certificate up to a trusted root. <br> • Input: leaf certificate, optional set of untrusted intermediate certificates, set of trusted root certificates.<br> • The builder **must** order certificates such that each certificate is issued by the next one in the chain.<br> • If multiple paths exist, the shortest valid path **should** be chosen.<br> • If no path can be built, validation **must** fail with an appropriate error.                                                | **Must** |
| **VAL‑2** | **Basic Path Validation Checks:** For each certificate in the path (excluding the trusted root), the validator **must** perform the following checks:<br> • **Signature validity:** Verify the signature of the certificate using the issuer's public key.<br> • **Validity period:** Verify that the current time (or a specified reference time) is within the `notBefore` and `notAfter` fields.<br> • **Basic Constraints:** If the certificate is a CA certificate (`CA=TRUE`), verify that it is used as an issuer; for end‑entity certificates (`CA=FALSE`), verify that they are not used as issuers.<br> • **Path length constraints:** If a `pathLenConstraint` is present in a CA certificate, verify that the number of subordinate CA certificates does not exceed the constraint.<br> • **Key Usage:** For CA certificates, verify that `keyCertSign` is present (if Key Usage extension is critical). For end‑entity certificates, verify that the key usage is appropriate for the intended purpose (e.g., `digitalSignature` for TLS client/server). | **Must** |
| **VAL‑3** | **Name Constraints (Optional):** The validator **should** support name constraints (permitted/excluded subtrees) as per RFC 5280. This is **optional** for Sprint 6 but encouraged.                                                                                                                                                                                                                                                                            | **Could** |
| **VAL‑4** | **Policy Validation:** The validator is **not** required to process certificate policies (X.509 policy extensions). This can be omitted.                                                                                                                                                                                                                                                                                                                     | **N/A**  |
| **VAL‑5** | **Validation Result:** The validator **must** return a structured result containing:<br> • Overall pass/fail status.<br> • For each certificate: validation steps passed/failed.<br> • Error messages for the first encountered failure.                                                                                                                                                                                                                      | **Must** |
| **VAL‑6** | **Time Handling:** The validator **must** accept an optional `--validation-time` parameter (default: current system time). This allows testing with expired certificates.                                                                                                                                                                                                                                                                                     | **Should** |

---

## 4. Revocation Checking (CRL & OCSP Integration)

The client tools must perform revocation checks using both CRLs and OCSP, with a defined fallback logic.

| ID     | Requirement Description                                                                                                                                                                                                                                                                                                                                                                                                                                      | Priority |
|--------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| **REV‑1** | **CRL Checking:** The validator **must** support checking a certificate against a Certificate Revocation List (CRL). <br> • Input: CRL (PEM/DER) or URL to fetch CRL.<br> • The CRL **must** be verified for signature, issuer, and nextUpdate freshness.<br> • If the CRL is expired (`nextUpdate` < current time), a warning **must** be logged, but the CRL **may** still be used (or validation can fail – configurable).<br> • The certificate's serial number is looked up in the revokedCertificates list; if found, status = `revoked` (with reason and revocation date). | **Must** |
| **REV‑2** | **OCSP Checking:** The validator **must** support checking a certificate via OCSP. <br> • Input: issuer certificate, responder URL (extracted from AIA extension or provided manually).<br> • The tool **must** construct an OCSP request (with optional nonce) and send it to the responder.<br> • The OCSP response **must** be verified: signature, responder certificate validity, nonce echo (if nonce was sent).<br> • The response status (`good`, `revoked`, `unknown`) is extracted.                                                                                             | **Must** |
| **REV‑3** | **Revocation Preference Logic:** When performing a `full` validation (or a standalone `check-status`), the tool **must** implement the following logic:<br> 1. **OCSP first:** Attempt OCSP check if an OCSP responder URL is available (from AIA extension or user‑supplied).<br> 2. **If OCSP is successful** (valid response, status = `good` or `revoked`), use that result.<br> 3. **If OCSP fails** (responder unreachable, malformed response, signature invalid, or status = `unknown`), **fallback to CRL**.<br> 4. **If CRL is successful** (fresh, signature valid, serial not found → `good`; serial found → `revoked`), use that result.<br> 5. **If both fail**, status = `unknown` (or validation fails). | **Must** |
| **REV‑4** | **AIA Extension Parsing:** The client **must** be able to extract the OCSP responder URI from the Authority Information Access (AIA) extension of a certificate (if present). This is used for automatic OCSP endpoint discovery.                                                                                                                                                                                                                             | **Must** |
| **REV‑5** | **CRL Distribution Point Parsing:** The client **should** be able to extract the CRL distribution point URI from the CRL Distribution Points (CDP) extension of a certificate (if present). This enables automatic CRL fetching.                                                                                                                                                                                                                             | **Should** |
| **REV‑6** | **Caching of Revocation Data:** The client **may** implement simple caching of CRLs and OCSP responses to avoid repeated network requests. This is **optional** for Sprint 6.                                                                                                                                                                                                                                                                                | **Could** |

---

## 5. Repository & CA Extensions for CSR Handling

To support the client `request-cert` workflow, the repository server and CA must be extended.

| ID     | Requirement Description                                                                                                                                                                                                                                                                                                                                                                                                                                      | Priority |
|--------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| **REPO‑15**| **New Endpoint: POST /request-cert** <br> • Accepts a CSR (PEM) and a template name (e.g., `server`) in a JSON payload or as multipart form data.<br> • The server **must** authenticate the request (simple API key or no authentication for demo purposes – but **should** be documented as insecure).<br> • The server **must** call the internal `ca issue-cert` logic with the provided CSR and template, returning the issued certificate in PEM format (or an error).<br> • Response: `201 Created` with `Content-Type: application/x-pem-file` and the certificate body.<br> • This endpoint **must** be integrated with the existing `ca issue-cert` implementation, reusing the same validation, extension building, and database insertion logic. | **Must** |
| **REPO‑16**| **Authentication/Authorisation:** For the purpose of Sprint 6, the endpoint **may** use a simple pre‑shared key passed via `X-API-Key` header, or no authentication with a clear warning. The student **must** document the security implications.                                                                                                                                                                                                             | **Should** |
| **CA‑1**  | **CSR Signing:** The `ca issue-cert` command (and underlying library function) **must** now accept an optional CSR parameter. When a CSR is provided:<br> • The public key **must** be extracted from the CSR.<br> • The subject **must** be taken from the CSR (overriding any `--subject` argument).<br> • The SANs **must** be taken from the CSR's Subject Alternative Name extension (if present), overriding any `--san` flags.<br> • The signature on the CSR **must** be verified; if invalid, the issuance **must** fail. <br> • The CSR's validity (e.g., key size, algorithm) **should** be checked against policy. | **Must** |

**Example API interaction (client → repository):**

```bash
$ cat app.csr.pem | curl -X POST \
    -H "Content-Type: application/x-pem-file" \
    -H "X-API-Key: changeme" \
    --data-binary @- \
    http://localhost:8080/request-cert?template=server \
    --output app.cert.pem
```

---

## 6. Logging & Audit

Client operations and validation attempts must be logged for auditability.

| ID     | Requirement Description                                                                                                                                                                                                                                                                                                                                                                                                                      | Priority |
|--------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| **LOG‑14**| **Client Logging:** The client tool **must** log all significant operations (CSR generation, certificate request, validation attempts) to a local log file (default: `~/.micropki/client.log`) or to stderr if `--log-file` is provided. <br> • Log entries **must** include timestamps, operation type, and outcome.                                                                                                                                 | **Should** |
| **LOG‑15**| **Validation Audit:** The path validation engine **should** produce a detailed, machine‑readable output (JSON) when a `--format json` flag is provided. This aids in integrating with other tools.                                                                                                                                                                                                                                            | **Could** |
| **LOG‑16**| **CA Logging for CSR Requests:** The CA **must** log all certificate issuances that originate from the `/request-cert` endpoint, including the source IP (if available) and the fact that the request came via the API.                                                                                                                                                                                                                       | **Must** |

---

## 7. Testing & Verification

The implementation must be thoroughly tested against positive and negative cases, including chain building, revocation checks, and end‑to‑end client workflows.

| ID     | Requirement Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Priority |
|--------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| **TEST‑38** | **CSR Generation Test:** Generate a CSR with `client gen-csr` and verify that:<br> • The private key is saved unencrypted with correct permissions.<br> • The CSR contains the correct subject and SANs.<br> • The CSR signature verifies using the public key from the private key.                                                                                                                                                                                                                                                    | **Must** |
| **TEST‑39** | **Certificate Request Test:** Use the generated CSR with `client request-cert` against a running repository/CA. Verify that a certificate is returned, stored, and that the certificate subject and SANs match the CSR.                                                                                                                                                                                                                                                                                                             | **Must** |
| **TEST‑40** | **Chain Validation – Valid Chain:** Issue a leaf certificate, then run `client validate` with the full chain. The tool **must** report success and list all validation steps passed.                                                                                                                                                                                                                                                                                                                                                 | **Must** |
| **TEST‑41** | **Chain Validation – Expired Certificate:** Issue a certificate with a very short validity, wait for it to expire (or use `--validation-time`), and validate. The tool **must** report failure due to expiration.                                                                                                                                                                                                                                                                                                                     | **Must** |
| **TEST‑42** | **Chain Validation – Wrong Key Usage:** Issue a client certificate but attempt to validate it as a server certificate (i.e., with extended key usage checking). The validator **should** optionally check EKU; this test is recommended but not mandatory.                                                                                                                                                                                                                                                                         | **Could** |
| **TEST‑43** | **Revocation Checking – CRL Only:** Revoke a certificate, generate a CRL, then use `client check-status` with `--crl` pointing to the CRL file. The tool **must** report `revoked` with correct reason and date.                                                                                                                                                                                                                                                                                                                     | **Must** |
| **TEST‑44** | **Revocation Checking – OCSP Only:** Revoke a certificate, start the OCSP responder, then use `client check-status` with OCSP (automatic from AIA or manual). The tool **must** report `revoked`.                                                                                                                                                                                                                                                                                                                                   | **Must** |
| **TEST‑45** | **Revocation Fallback Logic:** <br> 1. Issue a certificate, revoke it, but do **not** start the OCSP responder.<br> 2. Run `client check-status` with OCSP enabled (and CRL available).<br> 3. The tool **must** fall back to CRL and correctly report `revoked`.<br> 4. Logging **must** indicate the fallback.                                                                                                                                                                                                                       | **Should** |
| **TEST‑46** | **Chain Building – Missing Intermediate:** Validate a leaf certificate without providing the intermediate. If the trusted root can directly issue the leaf (which it cannot, since leaf is issued by intermediate), the tool **must** fail to build a chain. Provide the intermediate via `--untrusted` and it should succeed.                                                                                                                                                                                                       | **Must** |
| **TEST‑47** | **Chain Building – Multiple Paths:** Create a scenario with two cross‑signed intermediates (optional, advanced). Not required for Sprint 6.                                                                                                                                                                                                                                                                                                                                                                                         | **N/A**  |
| **TEST‑48** | **End‑to‑End Integration Test:** Perform a complete client workflow:<br> 1. Start repository server (with OCSP responder optional).<br> 2. Generate a CSR for a server certificate.<br> 3. Submit CSR via `client request-cert`.<br> 4. Retrieve issued certificate.<br> 5. Validate the certificate chain with revocation checking (OCSP/CRL).<br> 6. Revoke the certificate.<br> 7. Re‑validate; expect revocation detected.<br> This entire sequence **should** be automated in a single test script.                                      | **Should** |
| **TEST‑49** | **Negative Test – Invalid CSR Signature:** Generate a CSR, tamper with it (e.g., modify one byte), then submit to the CA. The CA **must** reject the request with an appropriate error.                                                                                                                                                                                                                                                                                                                                             | **Should** |
| **TEST‑50** | **Negative Test – Wrong Template for CSR:** Submit a CSR that requests CA=true or contains inappropriate extensions. The CA **must** override or reject. This tests the policy enforcement (Sprint 7 will formalise this; for Sprint 6, basic rejection of CA=true in end‑entity certs **must** be enforced).                                                                                                                                                                                                                          | **Should** |

---

## 8. Summary of Mandatory Technical Stack Choices (Sprint 6 Additions)

| Component             | Requirement (Sprint 6 additions)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|-----------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **CSR Generation**    | • **Python:** `cryptography.x509.CertificateSigningRequestBuilder`.<br> • **Go:** `crypto/x509.CreateCertificateRequest`.<br> • Private key generation: same as Sprint 2 (RSA‑2048/4096, ECC‑P256/P384).                                                                                                                                                                                                                                                                                                                                                                                       |
| **CSR Parsing**       | • **Python:** `cryptography.x509.load_pem_x509_csr`.<br> • **Go:** `crypto/x509.ParseCertificateRequest` (and `ParsePKIXPublicKey`).                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **Path Validation**   | • **Python:** Implement using `cryptography.x509.Certificate` and `cryptography.x509.Verifier`; chain building custom.<br> • **Go:** `crypto/x509.Certificate.Verify` can be used **only** for reference/testing. The student **must** implement their own simplified path validation logic – **not** rely solely on `Certificate.Verify` (which does full chain building). However, they **may** use it for comparison. The emphasis is on understanding RFC 5280; therefore the validation engine should be custom‑coded using the certificate structures and signature verification methods. |
| **OCSP Client**       | • **Python:** `cryptography.x509.ocsp.OCSPRequestBuilder`, `requests` library for HTTP POST.<br> • **Go:** `crypto/ocsp` package to create request and parse response; `net/http` to send.                                                                                                                                                                                                                                                                                                                                                                                                    |
| **CRL Client**        | • **Python:** `cryptography.x509.load_pem_x509_crl` / `load_der_x509_crl`; `requests` to fetch.<br> • **Go:** `crypto/x509.ParseRevocationList` (Go 1.19+).                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **AIA / CDP Parsing** | • **Python:** Extract OCSP URI from `cryptography.x509.AuthorityInformationAccess` extension; CDP from `cryptography.x509.CRLDistributionPoints`.<br> • **Go:** Access `Certificate.OCSPServer` and `Certificate.CRLDistributionPoints` fields.                                                                                                                                                                                                                                                                                                                                                  |
| **CLI**               | • New subcommand group `client` with subcommands `gen-csr`, `request-cert`, `validate`, `check-status`.<br> • The `ca issue-cert` command gains a `--csr` flag.                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Repository**        | • New endpoint `POST /request-cert`.<br> • Integration with existing issuance logic.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Logging**           | • Client‑side logging (file or stderr).<br> • CA logging for API‑originated issuances.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Testing**           | • Unit tests for CSR handling, chain building, revocation logic.<br> • Integration tests using live repository and OCSP responder.                                                                                                                                                                                                                                                                                                                                                                                                                                                            |

---

**End of Sprint 6 Requirements**
*All requirements are subject to clarification. When in doubt, prioritise correct path validation logic and robust revocation checking over advanced features like name constraints or policy processing.*
