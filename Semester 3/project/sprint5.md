# **Project: MicroPKI - Technical Requirements Document (Sprint 5)**

**Sprint Goal:** Implement a basic OCSP (Online Certificate Status Protocol) responder that provides real‑time certificate status information, complete with an OCSP signing certificate, request/response handling, and integration with the existing HTTP repository server.

---

## 1. Project Structure & Repository Hygiene

The codebase must now include OCSP responder modules and a dedicated OCSP signer certificate.

| ID     | Requirement Description                                                                                                                                                                                                                                                                                                                                                                                                                          | Priority |
|--------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| **STR‑16** | The repository **must** retain the structure from Sprints 1–4. New modules **must** be added for OCSP functionality: <br> • **Python:** `ocsp.py`, `ocsp_responder.py`.<br> • **Go:** `internal/ocsp/`, `internal/ocsp/responder.go`, `internal/ocsp/signer.go`.                                                                                                                                                                                   | **Must** |
| **STR‑17** | The `README.md` **must** be updated with:<br> • Instructions for issuing an OCSP responder certificate.<br> • How to start the OCSP responder (as part of the repository server or a separate service).<br> • Example `openssl ocsp` client commands to query the responder.<br> • Explanation of OCSP nonce and replay protection.                                                                                                                  | **Must** |
| **STR‑18** | The directory structure under `--out-dir` **must** be extended to optionally include an `ocsp` subdirectory for storing OCSP responder logs or cache files (if implemented).                                                                                                                                                                                                                                                                      | **Should** |

```
<out-dir>/
├── private/
├── certs/
├── crl/
├── ocsp/                         # OPTIONAL – for OCSP cache / logs
├── micropki.db
└── policy.txt
```

---

## 2. Command‑Line Interface (CLI) Parser

The CLI must support issuing an OCSP responder certificate and starting the OCSP responder service.

| ID     | Requirement Description                                                                                                                                                                                                                                                                                                                                                          | Priority |
|--------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| **CLI‑22** | The tool **must** provide a subcommand `ca issue-ocsp-cert` that issues a special‑purpose OCSP signing certificate from the Intermediate CA (or optionally directly from the Root CA). <br> • **Required arguments:** <br>   - `--ca-cert` – Intermediate CA certificate.<br>   - `--ca-key` – Intermediate CA private key.<br>   - `--ca-pass-file` – passphrase for CA key.<br>   - `--subject` – Distinguished Name (e.g., `CN=OCSP Responder`).<br>   - `--key-type` / `--key-size` – as before.<br> • **Optional arguments:** <br>   - `--san` – Subject Alternative Name (typically a DNS name or URI where the responder is hosted).<br>   - `--out-dir` – output directory (default: `./pki/certs`).<br>   - `--validity-days` – default `365`. <br> • The certificate **must** include the Extended Key Usage extension with `id-kp-OCSPSigning` (1.3.6.1.5.5.7.3.9). <br> • The certificate **must** have `CA=FALSE` and appropriate Key Usage (`digitalSignature`). <br> • The certificate **should** include an Authority Information Access (AIA) extension pointing to the OCSP responder itself (optional). | **Must** |
| **CLI‑23** | The tool **must** provide a subcommand `ocsp serve` that starts the OCSP responder. <br> • **Arguments:** <br>   - `--host` – bind address (default: `127.0.0.1`). <br>   - `--port` – TCP port (default: `8081`). <br>   - `--db-path` – SQLite database path (default: `./pki/micropki.db`). <br>   - `--responder-cert` – OCSP signing certificate (PEM). <br>   - `--responder-key` – OCSP signing private key (PEM, unencrypted). <br>   - `--ca-cert` – Issuer CA certificate (to verify requests and locate certificates). <br>   - `--cache-ttl` – response cache time‑to‑live in seconds (default: `60`). <br>   - `--log-file` – optional log file (default: stderr). <br> • The server **must** run until interrupted (Ctrl+C). | **Must** |
| **CLI‑24** | The existing `repo serve` command **may** be extended with an `--enable-ocsp` flag that also starts the OCSP responder on a separate port (or same port with path `/ocsp`). This is **optional**; a separate `ocsp serve` command is sufficient.                                                                                                                                   | **Could** |

**Example invocations:**

```bash
# 1. Issue an OCSP responder certificate signed by the Intermediate CA
$ micropki ca issue-ocsp-cert \
    --ca-cert ./pki/certs/intermediate.cert.pem \
    --ca-key ./pki/private/intermediate.key.pem \
    --ca-pass-file ./secrets/intermediate.pass \
    --subject "CN=OCSP Responder,O=MicroPKI" \
    --key-type rsa \
    --key-size 2048 \
    --san dns:ocsp.example.com \
    --out-dir ./pki/certs \
    --validity-days 365

# 2. Start the OCSP responder
$ micropki ocsp serve \
    --host 127.0.0.1 \
    --port 8081 \
    --db-path ./pki/micropki.db \
    --responder-cert ./pki/certs/ocsp.cert.pem \
    --responder-key ./pki/certs/ocsp.key.pem \
    --ca-cert ./pki/certs/intermediate.cert.pem \
    --cache-ttl 120 \
    --log-file ./logs/ocsp.log
```

---

## 3. Core PKI Implementation (OCSP Responder)

The OCSP responder must correctly parse RFC 6960 requests, query the database, and generate signed responses.

| ID     | Requirement Description                                                                                                                                                                                                                                                                                                                                                                                                                                      | Priority |
|--------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| **OCSP‑1** | **OCSP Request Parsing:** The responder **must** accept POST requests with `Content-Type: application/ocsp-request` containing a DER‑encoded OCSP request (ASN.1). The responder **must** extract the following fields from the request:<br> • `version` – must be `v1` (value 0).<br> • `requestorName` – optional, ignored.<br> • **Request list:** at least one `CertID` containing:<br>   - Hash algorithm (must be SHA‑1 or SHA‑256; **must** support SHA‑1 for compatibility).<br>   - Issuer name hash (hash of issuer's DN).<br>   - Issuer key hash (hash of issuer's public key).<br>   - Serial number of the certificate in question.<br> • **Extensions:** nonce (if present).<br> The responder **must** reject malformed requests with a proper OCSP response (malformedRequest) or HTTP 400. | **Must** |
| **OCSP‑2** | **OCSP Response Generation:** For each requested certificate, the responder **must** produce a response with the following structure:<br> • `version` – v1 (0).<br> • `responderID` – by name (subject of the OCSP signing certificate) **or** by key hash (SHA‑1 hash of the responder's public key). **Must** support both; **should** use byKey for anonymity.<br> • `producedAt` – current UTC time.<br> • **SingleResponse** for each certificate containing:<br>   - `certID` – same as request.<br>   - `certStatus`: `good`, `revoked`, or `unknown`.<br>   - `thisUpdate` – current time.<br>   - `nextUpdate` – optional (recommended: `thisUpdate` + cache TTL).<br>   - `revokedInfo` – if revoked, include revocation date and reason.<br> • **ResponseExtensions:** nonce (if present in request, MUST be echoed).<br> • **Signature:** signed by the OCSP responder's private key using the algorithm specified in the responder certificate. | **Must** |
| **OCSP‑3** | **Status Determination:** The responder **must** query the database for each serial number:<br> • If the certificate exists and `status = 'valid'` → `good`.<br> • If the certificate exists and `status = 'revoked'` → `revoked`, with revocation date and reason from the database.<br> • If the certificate does not exist OR is issued by a different CA (issuer mismatch) → `unknown`.<br> • **Edge case:** expired certificates are still considered `good` for OCSP purposes (they are not revoked). The responder **may** choose to return `good` or `unknown`; `good` is recommended. | **Must** |
| **OCSP‑4** | **Nonce Handling:** The responder **must** extract the nonce extension from the request (if present). The responder **must** include the exact same nonce value in the response extension `OCSPNonce` (OID 1.3.6.1.5.5.7.48.1.2). This provides replay protection. If the request does not contain a nonce, the responder **should not** include a nonce in the response.                                                                                       | **Must** |
| **OCSP‑5** | **Response Encoding:** The OCSP response **must** be DER‑encoded as a `BasicOCSPResponse` (as per RFC 6960), then wrapped in a `OCSPResponse` structure with `responseStatus = successful`. The final DER **must** be sent with `Content-Type: application/ocsp-response`.                                                                                                                                                                                    | **Must** |
| **OCSP‑6** | **Error Responses:** The responder **must** generate proper OCSP error responses for:<br> • malformedRequest – request could not be parsed.<br> • internalError – server error (database unavailable, etc.).<br> • tryLater – optional, if rate limiting is applied.<br> • sigRequired – if authentication is required (not used).<br> • unauthorized – if the responder refuses to answer for this issuer/certificate (e.g., issuer not recognised).<br> These **must** be returned as proper OCSPResponse structures with HTTP 200 (or appropriate 4xx/5xx as fallback). | **Should** |
| **OCSP‑7** | **Caching:** To improve performance, the responder **should** cache recently generated responses in memory with a TTL. The cache key **should** be (issuerHash, serialNumber, nonce) or simply (serialNumber) if nonce is ignored for cache – but note nonce must be echoed, so caching without nonce is non‑trivial. A simple approach: cache per serial number for `good`/`revoked` responses, and only use for requests without nonce. This is **optional** but recommended.                                                | **Could** |
| **OCSP‑8** | **Logging:** Every OCSP request **must** be logged at `INFO` level with: timestamp, client IP, serial number(s), response status (good/revoked/unknown), and processing time (ms). Errors **must** be logged at `ERROR` level.                                                                                                                                                                                                                               | **Must** |

---

## 4. OCSP Signer Certificate

The OCSP responder certificate is a specialised end‑entity certificate with specific extensions.

| ID     | Requirement Description                                                                                                                                                                                                                                                                                                                                                                                                                                      | Priority |
|--------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| **OSC‑1** | **OCSP Signer Certificate Profile:** The certificate issued by `ca issue-ocsp-cert` **must** adhere to the following profile:<br> • Version: v3.<br> • Basic Constraints: `CA=FALSE`, critical.<br> • Key Usage: `digitalSignature` (critical). **Must not** include `keyCertSign` or `cRLSign`.<br> • Extended Key Usage: **must** include `id-kp-OCSPSigning` (1.3.6.1.5.5.7.3.9). **Must not** include `serverAuth`, `clientAuth`, etc. unless also needed (not required).<br> • Subject Alternative Name: **should** contain a DNS name or URI that matches the responder's address (if known). This is recommended but not mandatory.<br> • Authority Information Access (AIA): **may** include an OCSP URI pointing to the responder itself (self‑reference). | **Must** |
| **OSC‑2** | **Key Size Requirements:** The OCSP signer key pair **should** be at least RSA‑2048 or ECC‑P256. While 2048‑bit RSA is sufficient, the tool **must** allow key sizes as per the existing `--key-size` argument (RSA ≥ 2048, ECC ≥ 256).                                                                                                                                                                                                                       | **Should** |
| **OSC‑3** | **Private Key Storage:** The OCSP signer private key **must** be stored **unencrypted** (plain PEM) with permissions `0o600`. This is because the responder needs to load the key automatically on startup without human interaction. The tool **must** emit a clear warning when generating an unencrypted private key for OCSP use.                                                                                                                            | **Must** |

---

## 5. Repository Extensions (Optional Integration)

The OCSP responder may be integrated with the existing repository server or run separately.

| ID     | Requirement Description                                                                                                                                                                                                                                                                                                                                                                                                                                      | Priority |
|--------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| **REPO‑13**| **OCSP Endpoint on Repository Server:** If the student chooses to integrate OCSP into the repository server (instead of a separate `ocsp serve` command), the server **must** listen for POST requests on `/ocsp`. The same requirements as OCSP‑1 through OCSP‑8 apply. This approach is acceptable but **must** be clearly documented.                                                                                                                           | **Could** |
| **REPO‑14**| **AIA Extension in Issued Certificates:** The existing `issue-cert` command **should** be extended to optionally include an Authority Information Access (AIA) extension with an OCSP URI. This would require a new CLI flag (e.g., `--ocsp-url`) and is **optional** for Sprint 5.                                                                                                                                                                             | **Could** |

---

## 6. Database Integration

The OCSP responder relies on the certificate status database.

| ID     | Requirement Description                                                                                                                                                                                                                                                                                                                                                                                                                                      | Priority |
|--------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| **DB‑8** | **Issuer Identification:** To verify that a request's CertID matches a known issuer, the responder **must** be able to:<br> • Load the CA certificate(s) (Root and Intermediate) from the filesystem or database.<br> • Compute the issuer name hash (SHA‑1) and issuer key hash (SHA‑1 of the public key) for each CA.<br> • Match the hash values from the request against these pre‑computed values. <br> • If no match, return `unauthorized` or `unknown` for the certificate.                                                  | **Must** |
| **DB‑9** | **Efficient Querying:** The database **should** have an index on `serial_hex` for fast lookups. The responder **must** handle at least 10 requests per second (performance target, not strict).                                                                                                                                                                                                                                                              | **Should** |

---

## 7. Logging & Audit

OCSP operations must be auditable.

| ID     | Requirement Description                                                                                                                                                                                                                                                                                                                                                                                                                      | Priority |
|--------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| **LOG‑12**| **OCSP Request Logging:** As specified in OCSP‑8, each request **must** be logged with full details. The log format **should** be structured (JSON) to facilitate analysis.                                                                                                                                                                                                                                                                    | **Must** |
| **LOG‑13**| **Audit Trail:** The OCSP responder's decisions (good/revoked/unknown) **should** be logged in a way that can be correlated with the certificate database. This is essential for non‑repudiation.                                                                                                                                                                                                                                             | **Should** |

---

## 8. Testing & Verification

The OCSP responder must be tested against OpenSSL and demonstrate correct status reporting.

| ID     | Requirement Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Priority |
|--------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| **TEST‑28** | **OCSP Signer Certificate Test:** Verify that the issued OCSP responder certificate has the correct Extended Key Usage (`OCSPSigning`) and Key Usage (`digitalSignature`). Use OpenSSL:<br> `openssl x509 -in ocsp.cert.pem -text -noout` and check the extensions.                                                                                                                                                                                                                                                                    | **Must** |
| **TEST‑29** | **OCSP Request/Response Cycle – Good Certificate:** <br> 1. Issue a server certificate.<br> 2. Query the OCSP responder for that certificate using `openssl ocsp`.<br> 3. Verify that the response status is `good` and that the response is correctly signed by the OCSP responder certificate.<br> 4. Verify that the nonce is echoed correctly (if provided).                                                                                                                                                                         | **Must** |
| **TEST‑30** | **OCSP Request/Response – Revoked Certificate:** <br> 1. Revoke a previously issued certificate.<br> 2. Query the OCSP responder for that certificate.<br> 3. Verify that the response status is `revoked` and that the revocation reason and date are included.                                                                                                                                                                                                                                                                       | **Must** |
| **TEST‑31** | **OCSP Request/Response – Unknown Certificate:** <br> 1. Query the OCSP responder for a non‑existent serial number (or a certificate issued by a different CA).<br> 2. Verify that the response status is `unknown`.                                                                                                                                                                                                                                                                                                                   | **Must** |
| **TEST‑32** | **OCSP Nonce Test:** <br> 1. Send an OCSP request with a nonce.<br> 2. Verify that the response contains the exact same nonce.<br> 3. Send an OCSP request without a nonce; verify that the response does not include a nonce extension.                                                                                                                                                                                                                                                                                              | **Must** |
| **TEST‑33** | **OCSP Responder Signature Verification:** <br> Using the OCSP responder certificate and the issuing CA certificate, verify the OCSP response signature with OpenSSL:<br> `openssl ocsp -respin response.der -CAfile intermediate.cert.pem -verify_other ocsp.cert.pem` (or similar).                                                                                                                                                                                                                                                   | **Should** |
| **TEST‑34** | **Negative Test – Malformed Request:** <br> Send an invalid OCSP request (e.g., garbage data, missing Content-Type). The responder **must** return an appropriate HTTP error (400) or a proper OCSP error response (`malformedRequest`).                                                                                                                                                                                                                                                                                              | **Should** |
| **TEST‑35** | **Negative Test – Unauthorised Issuer:** <br> Send a request for a certificate that is signed by an unrecognised CA (i.e., issuer hashes do not match the configured CA). The responder **should** return `unauthorized` or treat as `unknown`.                                                                                                                                                                                                                                                                                     | **Should** |
| **TEST‑36** | **Performance / Load Test:** <br> Write a script that sends 100 concurrent OCSP requests for valid certificates. Measure response time. This test is **optional** but encouraged.                                                                                                                                                                                                                                                                                                                                                  | **Could** |
| **TEST‑37** | **Integration Test – Full PKI Workflow with OCSP:** <br> Demonstrate a complete scenario: Root CA → Intermediate CA → issue server cert → issue OCSP responder cert → start OCSP responder → query status (good) → revoke certificate → query status (revoked). This **should** be automated in a test script.                                                                                                                                                                                                                         | **Should** |

---

## 9. Summary of Mandatory Technical Stack Choices (Sprint 5 Additions)

| Component             | Requirement (Sprint 5 additions)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|-----------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **OCSP Library**      | • **Python:** `cryptography.x509.ocsp` – provides `OCSPRequestBuilder`, `OCSPResponseBuilder`, `OCSPNonce`, `OCSPSigningKeyUsage`, etc.<br> • **Go:** `crypto/ocsp` standard package (for parsing OCSP requests/responses) and `crypto/x509` for building extensions.                                                                                                                                                                                                                                                                                                                         |
| **OCSP Signer Certificate** | • **Extended Key Usage:** `id-kp-OCSPSigning` (1.3.6.1.5.5.7.3.9).<br> • **Key Usage:** `digitalSignature` only.<br> • **Private Key:** stored unencrypted (PEM) with `0o600` permissions.                                                                                                                                                                                                                                                                                                                                                                                                  |
| **HTTP Transport**    | • OCSP requests **must** be received via HTTP POST (path `/ocsp` if integrated, else separate server).<br> • Content‑Type: `application/ocsp-request` (request), `application/ocsp-response` (response).<br> • **Python:** `Flask`/`FastAPI` or built‑in `http.server`.<br> • **Go:** `net/http`.                                                                                                                                                                                                                                                                                            |
| **Nonce Handling**    | • MUST echo nonce if present; MUST NOT add nonce if absent.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **Database**          | • Same SQLite database; indexes recommended on `serial_hex`.<br> • No new mandatory tables.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **CLI**               | • `ca issue-ocsp-cert` – issues OCSP responder certificate.<br> • `ocsp serve` – starts responder (separate command).                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **Logging**           | • Extend existing logger; include structured JSON **should** for OCSP access logs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **Testing**           | • OpenSSL `ocsp` command used as reference client.<br> • Must demonstrate good/revoked/unknown responses.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |

---

**End of Sprint 5 Requirements**
*All requirements are subject to clarification. When in doubt, prioritise correct OCSP request/response handling and signature generation over advanced features (caching, AIA extensions, high performance).*
