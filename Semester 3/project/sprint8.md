# **Project: MicroPKI - Technical Requirements Document (Sprint 8)**

**Sprint Goal:** Deliver a fully integrated, demonstrable PKI system that showcases all previous sprints in realistic scenarios. Produce a complete demo script, integrate with TLS and code signing, finalise documentation, and deliver a comprehensive test suite covering correctness, edge cases, and performance.

---

## 1. Project Structure & Repository Hygiene

The repository must be in a final, shippable state with all code, documentation, and demo assets properly organised.

| ID     | Requirement Description                                                                                                                                                                                                                                                                                                                                                                                                                          | Priority |
|--------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| **STR‑26** | The repository **must** be **tagged** with a release version (e.g., `v1.0.0`) corresponding to the final Sprint 8 deliverable. The tag **must** be pushed to the remote repository.                                                                                                                                                                                                                                                               | **Must** |
| **STR‑27** | The `README.md` **must** be comprehensive and polished, containing all sections described in Section 6. It **must** be the primary entry point for anyone evaluating the project.                                                                                                                                                                                                                                                                 | **Must** |
| **STR‑28** | All source code, tests, configuration files, and demo scripts **must** be committed and pushed. No generated files (certificates, keys, databases, logs) **should** be committed; they **must** be listed in `.gitignore`.                                                                                                                                                                                                                         | **Must** |
| **STR‑29** | The repository **should** include a `demo/` directory containing all assets needed to run the demo scenario (e.g., configuration files, example scripts, test files). This directory **must** be clearly documented.                                                                                                                                                                                                                              | **Should** |
| **STR‑30** | A `LICENSE` file **should** be present in the root directory (e.g., MIT, Apache 2.0). This is not mandatory but strongly encouraged.                                                                                                                                                                                                                                                                                                             | **Could** |

---

## 2. Command‑Line Interface (CLI) Parser

No new major features are required in Sprint 8. However, the CLI **must** be fully functional and well‑documented. Any necessary demo‑related convenience commands **may** be added.

| ID     | Requirement Description                                                                                                                                                                                                                                                                                                                                                          | Priority |
|--------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| **CLI‑36** | All previously implemented CLI commands (`ca init`, `ca issue-intermediate`, `ca issue-cert`, `ca revoke`, `ca gen-crl`, `ca issue-ocsp-cert`, `ocsp serve`, `repo serve`, `client gen-csr`, `client request-cert`, `client validate`, `client check-status`, `audit query`, `audit verify`, `ca compromise`) **must** work without errors when invoked as documented.             | **Must** |
| **CLI‑37** | A new convenience command `demo run` **may** be added to execute the entire demo scenario (Section 3) in one step. This is optional but encouraged.                                                                                                                                                                                                                             | **Could** |
| **CLI‑38** | The `--help` output for every command **must** be accurate, complete, and user‑friendly. All arguments and flags **must** be described.                                                                                                                                                                                                                                         | **Must** |

---

## 3. Demo Script

The student must provide a self‑contained, automated demo script that walks through a complete PKI scenario, demonstrating all major capabilities of the system.

| ID     | Requirement Description                                                                                                                                                                                                                                                                                                                                                                                                                                      | Priority |
|--------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| **DEMO‑1** | The demo **must** be implemented as a **single, executable script** (e.g., `demo.sh`, `demo.py`, or `make demo`) that can be run from a clean environment. The script **must**:<br> • Set up the necessary directory structure.<br> • Initialise the Root CA.<br> • Initialise the Intermediate CA (signed by Root).<br> • Issue at least one **server** certificate.<br> • Issue at least one **client** certificate.<br> • Issue an **OCSP responder** certificate.<br> • Start the repository server (in background or separate terminal).<br> • Start the OCSP responder (in background).<br> • Perform a successful certificate validation (full chain + revocation check).<br> • Revoke a certificate.<br> • Demonstrate that the revoked certificate is now rejected.<br> • Demonstrate **audit log integrity** (e.g., verify the hash chain).<br> • Demonstrate **policy enforcement** (e.g., show that an invalid certificate request is rejected).<br> • Stop all servers. | **Must** |
| **DEMO‑2** | The demo script **must** be **idempotent** – running it twice in the same directory **should** either clean up before starting or handle existing state gracefully (e.g., by using temporary directories).                                                                                                                                                                                                                                                   | **Should** |
| **DEMO‑3** | The demo script **should** produce clear, human‑readable output, indicating each step and its outcome (e.g., `[PASS]`, `[FAIL]`). Coloured output is encouraged.                                                                                                                                                                                                                                                                                            | **Should** |
| **DEMO‑4** | The demo script **must not** require any manual intervention (e.g., typing passphrases). All passphrases **must** be read from files generated during the demo or supplied via environment variables.                                                                                                                                                                                                                                                       | **Must** |
| **DEMO‑5** | A **written walkthrough** of the demo **must** be included in the `README.md` or as a separate `DEMO.md` file. This **must** explain what each step does and why it matters.                                                                                                                                                                                                                                                                                | **Must** |

---

## 4. TLS Integration

The student must demonstrate that a certificate issued by their PKI can be used to secure a real TLS connection.

| ID     | Requirement Description                                                                                                                                                                                                                                                                                                                                                                                                                                      | Priority |
|--------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| **TLS‑1** | **TLS Server Demonstration:** The student **must** configure a simple web server (e.g., Python's `http.server`, `nginx`, or `openssl s_server`) to use a **server certificate** issued by their Intermediate CA, along with its private key. <br> • The server **must** be started during the demo (manually or via script).<br> • A client (e.g., `curl`, `wget`, `openssl s_client`) **must** connect successfully **only** when the Root CA certificate is provided as a trust anchor.<br> • The demonstration **must** be documented in the README with exact commands.                    | **Must** |
| **TLS‑2** | **OCSP Stapling (Simulated or Real):** The student **should** demonstrate OCSP stapling. This can be done by:<br> • Using `openssl s_server -status` to enable stapling and providing the OCSP response file.<br> • Or configuring a web server that supports stapling (e.g., nginx with `ssl_stapling`).<br> • Or simulating by manually showing that the certificate contains an OCSP responder URL and that the responder returns `good`.<br> This is **optional** but strongly encouraged.                                                                                                   | **Could** |
| **TLS‑3** | **Revocation Demonstration:** The demo **must** include a step where the server certificate is revoked, and subsequent TLS connections **fail** when the client performs revocation checking (CRL or OCSP). This **must** be clearly demonstrated and documented.                                                                                                                                                                                              | **Must** |

**Example demonstration (to be documented):**
```bash
# Start a simple HTTPS server with the issued certificate
$ python3 -m http.server 8443 --certfile server.cert.pem --keyfile server.key.pem

# Connect with client trusting the Root CA
$ curl --cacert root.cert.pem https://localhost:8443

# Revoke the certificate
$ micropki ca revoke <serial> --reason keyCompromise

# Generate fresh CRL and restart server (or use OCSP)
# Client with revocation checking should now fail
```

---

## 5. Code Signing Demo

The student must demonstrate that a code signing certificate issued by their PKI can be used to sign and verify a script or binary.

| ID     | Requirement Description                                                                                                                                                                                                                                                                                                                                                                                                                                      | Priority |
|--------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| **CSIGN‑1** | **Code Signing Certificate:** The student **must** issue a **code signing** certificate from their Intermediate CA (as per Sprint 2/6).                                                                                                                                                                                                                                                                                                                       | **Must** |
| **CSIGN‑2** | **Signing Demonstration:** The student **must** demonstrate signing a simple file (e.g., a Python script, shell script, or text file) using the code signing private key. <br> • The signing process **must** use a standard format (e.g., detached PKCS#7 signature, or a simple SHA‑256 hash signed with the private key).<br> • The student **must** provide a tool (or extend `micropki client`) to perform the signing and verification. <br> • The demonstration **must** be fully documented.                                                                                              | **Must** |
| **CSIGN‑3** | **Verification Demonstration:** The student **must** demonstrate that the signature verifies successfully with the code signing certificate and the trusted Root CA. <br> • The verification **must** fail if the file is tampered with. <br> • The verification **must** fail if the certificate is revoked (optional but encouraged).                                                                                                                            | **Must** |
| **CSIGN‑4** | **Tooling:** The student **may** implement simple `client sign` and `client verify` subcommands. Alternatively, they **may** use OpenSSL commands (`openssl dgst -sign`, `openssl dgst -verify`) to demonstrate the concept. The emphasis is on showing that the issued certificate is usable for code signing, not on building a production code signing tool.                                                                                                 | **Should** |

**Example demonstration (OpenSSL‑based):**
```bash
# Sign a script
$ openssl dgst -sha256 -sign code_signing.key.pem -out script.sh.sig script.sh

# Verify the signature
$ openssl dgst -sha256 -verify <(openssl x509 -in code_signing.cert.pem -pubkey -noout) -signature script.sh.sig script.sh
```

---

## 6. Final Documentation

The project must be thoroughly documented to enable a new user to understand, build, and use the system.

| ID     | Requirement Description                                                                                                                                                                                                                                                                                                                                                                                                                                      | Priority |
|--------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| **DOC‑1** | **README.md** – The root `README.md` **must** contain the following sections, clearly formatted:<br> • **Project Title & One‑Liner** – concise description.<br> • **Features** – bullet list of major capabilities (per sprint).<br> • **Architecture Diagram** – a visual representation of the PKI components, their interactions, and data flow. This **must** be an image (PNG/SVG) embedded in the README or linked. (See DOC‑2).<br> • **Prerequisites** – required software (Python/Go, OpenSSL, etc.).<br> • **Installation / Build Instructions** – step‑by‑step commands to install dependencies and build/install the tool.<br> • **Configuration** – explanation of configuration file (if implemented).<br> • **CLI Reference** – comprehensive list of all commands and subcommands with examples. This **may** be generated or written manually.<br> • **Demo Walkthrough** – detailed explanation of how to run the demo script, with expected output.<br> • **API Reference** – if the repository server endpoints are used, document them (paths, methods, parameters, examples).<br> • **Security Considerations** – discussion of known limitations, assumptions, and how to use the system safely. Include warnings about unencrypted end‑entity keys, passphrase handling, etc.<br> • **Acknowledgments / References** – RFCs, libraries, tutorials used. | **Must** |
| **DOC‑2** | **Architecture Diagram:** The student **must** create a clear architecture diagram showing the main components (CLI, CA modules, database, repository server, OCSP responder, client tools, audit system) and their relationships. The diagram **must** be included in the README (as an image) or in the `docs/` directory. Tools like `draw.io`, `PlantUML`, `Mermaid` (Markdown compatible) are acceptable.                                                                                                                                                                                      | **Must** |
| **DOC‑3** | **Security Considerations:** The student **must** explicitly document the following (if applicable):<br> • End‑entity private keys are stored unencrypted (warning).<br> • Root/Intermediate CA keys are encrypted, but passphrases are read from files – discuss risks.<br> • OCSP responder does not use HTTPS (if not implemented) – no transport security.<br> • Rate limiting is basic and may not protect against distributed attacks.<br> • Audit log integrity relies on hash chain, but the log file itself is not signed.<br> • Certificate Transparency is only simulated (no Merkle tree, no public gossip).<br> • The system is educational and not recommended for production use without further hardening. | **Must** |
| **DOC‑4** | **CLI/API Reference:** The student **must** provide a complete reference of all CLI commands and their options, as well as the REST API endpoints (if implemented). This **may** be in the README or in separate markdown files under `docs/`.                                                                                                                                                                                                                 | **Must** |
| **DOC‑5** | **Inline Code Documentation:** All public functions, methods, and complex logic **must** be documented with docstrings/comments explaining purpose, parameters, and return values. The student **should** follow language‑standard documentation style (e.g., Python docstrings, Go comments).                                                                                                                                                                | **Should** |

---

## 7. Test Suite

The final sprint requires a comprehensive, automated test suite that validates correctness, robustness, and performance.

| ID     | Requirement Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Priority |
|--------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| **TEST‑61** | **Comprehensive Test Suite:** The project **must** include an automated test suite that achieves **at least 80% code coverage** (line coverage) of the core PKI logic, validation engine, revocation modules, and CLI. <br> • **Python:** `pytest` with `pytest-cov`.<br> • **Go:** `go test -cover`.<br> • The coverage report **must** be documented in the README or in a CI badge.                                                                                                                                                     | **Must** |
| **TEST‑62** | **Edge Cases – Expired Certificates:** The test suite **must** include tests for validating expired certificates (using a fixed validation time or system time manipulation).                                                                                                                                                                                                                                                                                                                                                         | **Must** |
| **TEST‑63** | **Edge Cases – Wrong Key Usage:** The test suite **must** include tests where a certificate is used for an unintended purpose (e.g., using a client certificate as a server certificate). The validator **should** detect and report the misuse (if EKU checking is implemented).                                                                                                                                                                                                                                                        | **Should** |
| **TEST‑64** | **Edge Cases – Malformed Inputs:** The test suite **must** include tests that feed malformed PEM/DER files, invalid CSRs, corrupted audit logs, etc., to ensure graceful error handling.                                                                                                                                                                                                                                                                                                                                              | **Must** |
| **TEST‑65** | **Performance Test – 1000 Certificates:** The test suite **must** include a performance test that:<br> • Issues **1000 certificates** (synthetic, automated) using the CA.<br> • Measures the time taken for issuance and database insertion.<br> • Performs validation of all 1000 certificates.<br> • Reports the results (e.g., certificates per second).<br> • This test **may** be marked as "slow" and skipped by default, but **must** be runnable via a specific command (e.g., `make perf-test` or `pytest -m perf`).                 | **Must** |
| **TEST‑66** | **Performance Test – CRL/OCSP Load:** The test suite **should** include a performance test that simulates 1000 OCSP requests or CRL fetches and measures response time.                                                                                                                                                                                                                                                                                                                                                               | **Could** |
| **TEST‑67** | **Continuous Integration (CI):** The repository **should** be integrated with a CI service (e.g., GitHub Actions, GitLab CI) that automatically runs the test suite on every push and pull request. A CI badge **should** be displayed in the README.                                                                                                                                                                                                                                                                                  | **Should** |
| **TEST‑68** | **Test Documentation:** The test suite **must** be documented: how to run tests, how to interpret results, and any special requirements (e.g., OpenSSL must be installed).                                                                                                                                                                                                                                                                                                                                                            | **Must** |

---

## 8. Summary of Mandatory Technical Stack Choices (Sprint 8 Additions)

| Component             | Requirement (Sprint 8 additions)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|-----------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Demo Script**       | • Any language (Bash, Python, Go script) that orchestrates the demo.<br> • **Must** be executable and self‑contained.<br> • **Must** use temporary directories or clean up after itself.                                                                                                                                                                                                                                                                                                                                                                                                      |
| **TLS Integration**   | • No new libraries required; use existing system tools (`openssl`, `curl`, `python3 -m http.server`, `nginx`, etc.).<br> • The demonstration **must** be reproducible with documented commands.                                                                                                                                                                                                                                                                                                                                                                                               |
| **Code Signing**      | • **OpenSSL** command‑line tool may be used for signing/verification.<br> • Alternatively, implement custom `client sign` / `client verify` commands using the `cryptography` or Go standard library.                                                                                                                                                                                                                                                                                                                                                                                          |
| **Documentation**     | • Architecture diagram: any format (PNG, SVG, Mermaid).<br> • README in Markdown.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Test Suite**        | • **Python:** `pytest`, `pytest-cov`, `pytest-benchmark` (optional).<br> • **Go:** `testing` package, `go test -bench` for performance.<br> • Coverage target: **≥80%** line coverage.                                                                                                                                                                                                                                                                                                                                                                                                         |
| **Performance Test**  | • Must handle 1000 certificate issuances.<br> • Should be isolated (use in‑memory SQLite or temporary files).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **CI**                | • GitHub Actions, GitLab CI, or similar (optional).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |

---

**End of Sprint 8 Requirements**
*All requirements are subject to clarification. When in doubt, prioritise a clean, repeatable demo and thorough documentation over advanced performance optimisations.*
